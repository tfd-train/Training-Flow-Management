<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ºåŒ—å¸‚æ”¿åºœæ¶ˆé˜²å±€ 114å¹´æ•™è‚²è¨“ç·´ç®¡ç†ç³»çµ±</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --sidebar: #1e293b; --active: #334155; --accent: #3b82f6; --bg: #f1f5f9; --border: #64748b; --header: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #333; }

        /* Screen Styles */
        table { border-collapse: collapse; font-size: 13px; table-layout: fixed; width: auto; border-spacing: 0; }
        #table1 { min-width: 2000px; } #table2 { min-width: 1800px; } #table3 { min-width: 1400px; }
        #table4 { width: 1230px !important; background: white; } 
        .col-fix-name { width: 300px !important; min-width: 300px; max-width: 300px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; box-sizing: border-box; padding-left: 5px; }
        .col-fix-day { width: 30px !important; min-width: 30px; max-width: 30px; text-align: center; padding: 0 !important; box-sizing: border-box; }

        th { background: var(--header); color: #1e293b; font-weight: 700; border: 1px solid var(--border); position: sticky; top: 0; z-index: 10; height: 50px; padding: 4px; box-sizing: border-box; }
        td { border: 1px solid var(--border); height: 36px; background: white; position: relative; box-sizing: border-box; padding: 0; vertical-align: middle; }

        /* Inputs */
        input[type="text"], input[type="number"] { width: 100%; height: 36px; border: none; outline: none; background: transparent; text-align: center; font-family: inherit; font-size: 13px; color: #000; display: block; }
        input:focus, textarea:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px var(--accent); }
        input[readonly] { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        .align-left input { text-align: left; padding-left: 8px; }
        textarea { width: 100%; min-height: 36px; height: 100%; border: none; resize: none; outline: none; background: transparent; font-family: inherit; font-size: 13px; color: #000; text-align: left; padding: 8px 5px; box-sizing: border-box; white-space: pre-wrap; overflow: hidden; display: block; }

        /* Components */
        .date-cell { display: flex; align-items: center; height: 100%; min-height: 36px; } .date-cell input { flex: 1; height: 100%; }
        .btn-calendar { width: 30px; height: 100%; min-height: 36px; border: none; border-left: 1px solid var(--border); cursor: pointer; background: #f1f5f9; }
        .td-checkbox { text-align: center !important; padding: 0 !important; }
        .excel-checkbox { appearance: none; width: 18px; height: 18px; border: 1px solid #000; background: white; cursor: pointer; display: inline-block; vertical-align: middle; margin: 0; }
        .excel-checkbox:checked::after { content: 'âœ“'; font-size: 16px; font-weight: 900; color: #000; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* Gantt */
        .gantt-month-header td { background: #e2e8f0; font-weight: bold; text-align: left; padding-left: 15px; border: 2px solid #475569; color: #1e293b; font-size: 14px; height: 30px; }
        .gantt-visual-row { height: 24px; } .gantt-data-row { height: 24px; }
        .gantt-cell-bar { border-right: 1px solid var(--border); border-bottom: none; }
        .gantt-num { border-top: none; border-right: 1px solid var(--border); }
        .gantt-num input { font-weight: bold; color: #000; font-size: 12px; height: 100%; }
        .bar-active { background: #3b82f6 !important; border-color: #1d4ed8; }
        .stats-row td { background: #f1f5f9; border: 2px solid #333; color: #1e40af; font-weight: bold; font-size: 12px; text-align: center; }
        
        /* PDF Print Area */
        #pdf-export-area { background: white; width: 100%; }

        /* UI Structure */
        .sidebar { width: 240px; background: var(--sidebar); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 20px; background: #0f172a; border-bottom: 1px solid #334155; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-left: 4px solid transparent; color: #94a3b8; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; }
        .nav-item:hover { background: var(--active); color: white; }
        .nav-item.active { background: var(--active); color: var(--accent); border-left-color: var(--accent); font-weight: bold; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 55px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        .page-title { font-size: 18px; font-weight: 600; color: #1e293b; }
        .toolbar-group { display: flex; gap: 8px; align-items: center; }
        .workspace { flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .view-section { display: none; height: 100%; flex-direction: column; background: white; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
        .view-section.active { display: flex; }
        .table-container { flex: 1; overflow: auto; }

        /* Modal */
        #loading { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; font-size: 18px; backdrop-filter: blur(4px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 420px; padding: 20px; border-radius: 8px; }
        .btn-action { padding: 8px 16px; border-radius: 4px; border: none; color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .btn-save { background: #0f172a; } .btn-import { background: #64748b; } .btn-download { background: #16a34a; } .btn-print { background: #dc2626; } .btn-outline { background: white; border: 1px solid #cbd5e1; color: #333; }
        .btn-add-row { width: 100%; padding: 10px; background: #fff; border: 1px dashed #94a3b8; color: var(--accent); font-weight: bold; cursor: pointer; margin-top: 5px; }
        .col-yellow { background: #ffffcc; } .col-blue-light { background: #e0f2fe; } .col-red-light { background: #fee2e2; }
        .text-manpower { color: #1d4ed8; font-weight: bold; } .text-danger { color: #ef4444; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
        .day-btn { padding: 8px; border: 1px solid #cbd5e1; background: white; cursor: pointer; text-align: center; border-radius: 4px; }
        .day-btn.active-range { background: #dbeafe; color: #1e40af; font-weight: bold; border-color: #3b82f6; }
        .day-btn.excluded { background: #64748b; color: white; text-decoration: line-through; }
        .print-month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .month-select-btn { padding: 15px; border: 1px solid #cbd5e1; background: white; cursor: pointer; text-align: center; border-radius: 4px; }
        .month-select-btn.selected { background: #3b82f6; color: white; border-color: #2563eb; }
    </style>
</head>
<body>
    <div id="loading"><div class="spinner"></div><div id="loadText">è™•ç†ä¸­...</div></div>

    <!-- Modals -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div style="font-weight:bold;margin-bottom:15px;">æ’é™¤æ—¥æœŸè¨­å®š</div>
            <div style="font-size:13px;color:#3b82f6;margin-bottom:10px;" id="modalRangeText"></div>
            <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;">
                <button class="btn-outline" style="padding:4px 8px" onclick="applyDateFilter('all')">å…¨é¸</button>
                <button class="btn-outline" style="padding:4px 8px" onclick="applyDateFilter('no-weekend')">æ’é™¤å…­æ—¥</button>
                <button class="btn-outline" style="padding:4px 8px" onclick="applyDateFilter('only-weekend')">åƒ…é¸å…­æ—¥</button>
                <button class="btn-outline" style="padding:4px 8px" onclick="applyDateFilter('clear')">æ¸…é™¤</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                <button class="btn-outline" style="padding:8px 16px" onclick="closeModal('dateModal')">å–æ¶ˆ</button>
                <button class="btn-save" style="padding:8px 16px;color:white;border:none;border-radius:4px;cursor:pointer;" onclick="saveDateModal()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="font-weight:bold;margin-bottom:10px">è«‹é¸æ“‡è¼¸å‡ºæœˆä»½</div>
            <div style="margin-bottom:10px;display:flex;justify-content:space-between;">
                <span style="font-size:12px;color:#666;">æœªé¸å–æœˆä»½å°‡è¢«éš±è—</span>
                <button class="btn-outline" style="padding:2px 8px" onclick="toggleAllMonths()">å…¨é¸/åé¸</button>
            </div>
            <div class="print-month-grid" id="printMonthGrid"></div>
            <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                <button class="btn-outline" style="padding:8px 16px" onclick="closeModal('printModal')">å–æ¶ˆ</button>
                <button class="btn-save" style="padding:8px 16px;color:white;border:none;border-radius:4px;cursor:pointer;" onclick="executePrintOrExport()">ç¢ºèªåŸ·è¡Œ</button>
            </div>
        </div>
    </div>

    <!-- Main UI -->
    <div class="sidebar">
        <div class="sidebar-header"><h2 style="color:white;margin:0;">æ•™è‚²è¨“ç·´ç®¡ç†ç³»çµ±</h2></div>
        <nav>
            <div class="nav-item active" onclick="switchTab(1, this)">1. æ¶ˆé˜²äººå“¡</div>
            <div class="nav-item" onclick="switchTab(2, this)">2. éæ¶ˆé˜²äººå“¡</div>
            <div class="nav-item" onclick="switchTab(3, this)">3. é‡å¤§æ´»å‹•</div>
            <div class="nav-item" onclick="switchTab(4, this)">4. ç”˜ç‰¹åœ–</div>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title" id="pageTitle">é™„ä»¶1 - æ¶ˆé˜²äººå“¡</div>
            <div class="toolbar-group" id="toolbar"></div>
        </div>

        <div class="workspace">
            <!-- Tabs 1~3 -->
            <div id="view1" class="view-section active"><div class="table-container"><table id="table1"><thead><tr><th style="width:40px" class="del-btn">åˆª</th><th style="width:40px">é …æ¬¡</th><th style="width:40px">æœˆä»½</th><th style="width:100px">æ‰¿è¾¦å–®ä½</th><th style="width:200px">èª²ç¨‹åç¨±</th><th style="width:80px">è¨“ç·´å°è±¡</th><th style="width:140px">èª²ç¨‹æ—¥æœŸ</th><th style="width:120px">ä¸Šèª²åœ°é»</th><th style="width:40px">æ¢¯æ•¸</th><th style="width:50px">æ¯æ¢¯<br>äººæ•¸</th><th style="width:50px">åˆè¨ˆ<br>äººæ•¸</th><th style="width:50px">æ¯å¤©<br>æ™‚æ•¸</th><th style="width:50px">æ¯æ¢¯<br>æ™‚æ•¸</th><th style="width:50px">åˆè¨ˆ<br>æ™‚æ•¸</th><th style="width:100px" class="col-blue-light"><div class="th-content">é è¨ˆèª¿ç”¨äººæ•¸<br>(åˆ†éšŠäººåŠ›)</div></th><th style="width:120px" class="col-yellow"><div class="th-content">æ˜¯å¦æä¾›å®œåŸº<br>åŒ—æ¡ƒåƒè¨“</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>æ–°åŒ—</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>åŸºéš†</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>æ¡ƒåœ’</div></th><th style="width:60px" class="col-yellow"><div class="th-content">æš«è¨‚<br>å®œè˜­</div></th><th style="width:150px">å‚™è¨»</th></tr></thead><tbody id="tbody1"></tbody></table></div><button class="btn-add-row" onclick="addRow(1)">+ æ–°å¢</button></div>
            <div id="view2" class="view-section"><div class="table-container"><table id="table2"><thead><tr><th style="width:40px" class="del-btn">åˆª</th><th style="width:40px">åºè™Ÿ</th><th style="width:40px">æœˆä»½</th><th style="width:100px">æ‰¿è¾¦å–®ä½</th><th style="width:200px">èª²ç¨‹åç¨±</th><th style="width:120px">è¨“ç·´å°è±¡</th><th style="width:140px">èª²ç¨‹æ—¥æœŸ</th><th style="width:120px">è¨“ç·´åœ°é»</th><th style="width:40px">æ¢¯æ•¸</th><th style="width:50px">æ¯æ¢¯<br>äººæ•¸</th><th style="width:50px">åˆè¨ˆ<br>äººæ•¸</th><th style="width:50px">æ¯å¤©<br>æ™‚æ•¸</th><th style="width:50px">æ¯æ¢¯<br>æ™‚æ•¸</th><th style="width:50px">åˆè¨ˆ<br>æ™‚æ•¸</th><th style="width:80px">èª¿ç”¨æœ¬å±€<br>æ•™å®˜äººæ•¸</th><th style="width:100px"><div class="th-content">æ˜¯å¦æä¾›<br>è·¨ç¸£å¸‚</div></th><th style="width:150px">å‚™è¨»</th></tr></thead><tbody id="tbody2"></tbody></table></div><button class="btn-add-row" onclick="addRow(2)">+ æ–°å¢</button></div>
            <div id="view3" class="view-section"><div class="table-container"><table id="table3"><thead><tr><th style="width:40px" class="del-btn">åˆª</th><th style="width:40px">åºè™Ÿ</th><th style="width:100px">æ‰¿è¾¦å–®ä½</th><th style="width:250px">é‡å¤§æ´»å‹•æ¼”ç¿’åç¨±</th><th style="width:150px">åƒåŠ å°è±¡</th><th style="width:140px">æ—¥æœŸ</th><th style="width:50px">å¤©æ•¸</th><th style="width:50px">æ™‚æ•¸</th><th style="width:100px" class="col-red-light"><div class="th-content">æ¯æ—¥èª¿ç”¨<br>å¤–å‹¤äººæ•¸</div></th><th style="width:150px">åœ°é»(æ•™å®¤)</th></tr></thead><tbody id="tbody3"></tbody></table></div><button class="btn-add-row" onclick="addRow(3)">+ æ–°å¢</button></div>

            <!-- Tab 4: Gantt -->
            <div id="view4" class="view-section">
                <div style="padding:12px; background:#fffbeb; border-bottom:1px solid #94a3b8; font-size:13px; color:#92400e;">
                    âš ï¸ <strong>èªªæ˜ï¼š</strong> çµ±è¨ˆåŒ…å«é™„ä»¶1~3æ‰€æœ‰äººæ•¸ã€‚æ¯æ—¥çµ±è¨ˆå³ä½¿ç‚º 0 ä¹Ÿæœƒé¡¯ç¤ºã€‚åˆ—å°å‰è«‹é¸æ“‡æœˆä»½ã€‚
                </div>
                <div class="table-container" style="background:white; padding:20px;">
                    <!-- PDF Capture Area -->
                    <div id="ganttExportArea">
                        <table id="table4">
                            <thead>
                                <tr id="ganttHeader">
                                    <th class="col-fix-name">ç­æœŸ / æ´»å‹•åç¨±</th>
                                    <!-- JS ç”Ÿæˆ 1-31 -->
                                </tr>
                            </thead>
                            <tbody id="ganttContainer"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxB06TURmbo4QW7ecb5OprxEF3mnJGve_Qkq64qvcyKTS0d4__4kmpzxFvJ9T6Cw0jKuQ/exec"; 

        let d1 = [{m:'1', unit:'', name:'', date:'', mp:0, ex:[], isNew:true}];
        let d2 = [{m:'1', unit:'', name:'', date:'', inst:0, ex:[], isNew:true}];
        let d3 = [{unit:'', name:'', date:'', mp:0, ex:[], isNew:true}];
        let currentTab = 1;
        let printActionType = '';

        window.onload = function() { updateToolbar(); loadData(); };

        // --- Load/Save/Nav ---
        function loadData() {
            if(GAS_API_URL.includes("è«‹è²¼ä¸Š")) { renderAll(); return; }
            showLoading(true, "é›²ç«¯åŒæ­¥ä¸­...");
            fetch(GAS_API_URL).then(r=>r.json()).then(res => {
                if(res.status === 'success') {
                    d1 = (res.d1||[]).map(r => ({m:r[0], unit:r[1], name:r[2], target:r[3], date:r[4], loc:r[5], batch:r[6], pb:r[7], mp:r[12], ext:r[13]==='true', nt:r[14], kl:r[15], ty:r[16], yl:r[17], note:r[18], ex:JSON.parse(r[19]||'[]'), isNew:false, dHour:r[9], bHour:r[10]}));
                    d2 = (res.d2||[]).map(r => ({m:r[0], unit:r[1], name:r[2], target:r[3], date:r[4], loc:r[5], batch:r[6], pb:r[7], inst:r[12], ext:r[13]==='true', note:r[14], ex:JSON.parse(r[15]||'[]'), isNew:false, dHour:r[9], bHour:r[10]}));
                    d3 = (res.d3||[]).map(r => ({unit:r[0], name:r[1], target:r[2], date:r[3], days:r[4], hours:r[5], mp:r[6], loc:r[7], ex:JSON.parse(r[8]||'[]'), isNew:false}));
                    if(d1.length==0) addRow(1); if(d2.length==0) addRow(2); if(d3.length==0) addRow(3);
                    renderAll();
                }
            }).catch(e=>alert("é€£ç·šéŒ¯èª¤: "+e)).finally(()=>showLoading(false));
        }

        function saveData() {
            if(GAS_API_URL.includes("è«‹è²¼ä¸Š")) return alert("è«‹è¨­å®š API ç¶²å€");
            showLoading(true, "å„²å­˜ä¸­...");
            const p1 = d1.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch*r.pb)||0, r.dHour, r.bHour, (r.batch*r.bHour)||0, r.mp, r.ext, r.nt, r.kl, r.ty, r.yl, r.note, JSON.stringify(r.ex)]);
            const p2 = d2.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch*r.pb)||0, r.dHour, r.bHour, (r.batch*r.bHour)||0, r.inst, r.ext, r.note, JSON.stringify(r.ex)]);
            const p3 = d3.map(r => [r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.ex)]);
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({d1:p1, d2:p2, d3:p3}), headers: {'Content-Type': 'text/plain'} })
            .then(r=>r.json()).then(res=>{ if(res.status==='success') { alert(res.message); [d1,d2,d3].forEach(arr=>arr.forEach(r=>r.isNew=false)); renderAll(); } else alert("éŒ¯èª¤: "+res.message); })
            .finally(()=>showLoading(false));
        }

        function switchTab(idx, el) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.getElementById(`view${idx}`).classList.add('active');
            currentTab = idx;
            const titles = ["é™„ä»¶1 - æ¶ˆé˜²äººå“¡", "é™„ä»¶2 - éæ¶ˆé˜²äººå“¡", "é™„ä»¶3 - é‡å¤§æ´»å‹•", "ç”˜ç‰¹åœ–"];
            document.getElementById('pageTitle').innerText = titles[idx-1];
            updateToolbar();
            if(idx===4) renderGantt();
        }

        function updateToolbar() {
            const bar = document.getElementById('toolbar');
            let html = '';
            if(currentTab <= 3) {
                html += `<button class="btn-action btn-outline" onclick="downloadCSVTemplate()">ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹CSV</button>`;
                html += `<button class="btn-action btn-import" onclick="document.getElementById('csvInput').click()">ğŸ“‚ åŒ¯å…¥ CSV</button>`;
                html += `<button class="btn-action btn-save" onclick="saveData()">â˜ï¸ å„²å­˜è³‡æ–™</button>`;
            } else {
                html += `<button class="btn-action btn-download" onclick="openPrintModal('excel')">ğŸ“¥ ä¸‹è¼‰ Excel</button>`;
                html += `<button class="btn-action btn-print" onclick="openPrintModal('print')">ğŸ“„ åŒ¯å‡º PDF</button>`;
            }
            bar.innerHTML = html;
        }

        function showLoading(s,t){ document.getElementById('loading').style.display=s?'flex':'none'; if(t)document.getElementById('loadText').innerText=t; }
        function updateMonthFromDate(t, i, val) { let match = val.match(/^(\d+)\//); if(match) { let m = match[1]; if(t===1) d1[i].m = m; if(t===2) d2[i].m = m; document.getElementById(`m_${t}_${i}`).value = m; } if(t===1) d1[i].date=val; if(t===2) d2[i].date=val; if(t===3) d3[i].date=val; }

        // --- Renders ---
        function renderAll(){ renderT1(); renderT2(); renderT3(); }
        function renderT1(){ const tb=document.getElementById('tbody1'); tb.innerHTML=''; d1.forEach((r,i)=>{ tb.innerHTML+=`<tr><td style="text-align:center"><button class="del-btn" onclick="delRow(1,${i})" style="border:none;background:none;color:#94a3b8;cursor:pointer;">âœ•</button></td><td><input type="text" value="${i+1}" readonly style="color:#999"></td><td><input type="text" id="m_1_${i}" value="${r.m||''}" readonly style="background:#f1f5f9;color:#64748b"></td><td><input type="text" value="${r.unit||''}" onchange="d1[${i}].unit=this.value"></td><td class="align-left"><textarea onchange="d1[${i}].name=this.value">${r.name||''}</textarea></td><td><input type="text" value="${r.target||''}" onchange="d1[${i}].target=this.value"></td><td><div class="date-cell"><input type="text" value="${r.date||''}" onchange="updateMonthFromDate(1,${i},this.value)" placeholder="1/6-19"><button class="btn-calendar" onclick="openDateModal(1,${i})">ğŸ“…</button></div></td><td><input type="text" value="${r.loc||''}" onchange="d1[${i}].loc=this.value"></td><td><input type="number" value="${r.batch||''}" onchange="d1[${i}].batch=this.value"></td><td><input type="number" value="${r.pb||''}" onchange="d1[${i}].pb=this.value"></td><td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.pb)||0}</td><td><input type="number" value="${r.dh||''}" onchange="d1[${i}].dh=this.value"></td><td><input type="number" value="${r.bh||''}" onchange="d1[${i}].bh=this.value"></td><td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.bh)||0}</td><td class="col-blue-light"><input type="number" value="${r.mp||''}" onchange="d1[${i}].mp=this.value" class="text-manpower"></td><td class="td-checkbox"><input type="checkbox" class="excel-checkbox" ${r.ext?'checked':''} onchange="d1[${i}].ext=this.checked"></td><td><input type="number" value="${r.nt||''}" onchange="d1[${i}].nt=this.value"></td><td><input type="number" value="${r.kl||''}" onchange="d1[${i}].kl=this.value"></td><td><input type="number" value="${r.ty||''}" onchange="d1[${i}].ty=this.value"></td><td><input type="number" value="${r.yl||''}" onchange="d1[${i}].yl=this.value"></td><td class="align-left"><input type="text" value="${r.note||''}" onchange="d1[${i}].note=this.value"></td></tr>`; }); }
        function renderT2(){ const tb=document.getElementById('tbody2'); tb.innerHTML=''; d2.forEach((r,i)=>{ tb.innerHTML+=`<tr><td style="text-align:center"><button class="del-btn" onclick="delRow(2,${i})" style="border:none;background:none;color:#94a3b8;cursor:pointer;">âœ•</button></td><td><input type="text" value="${i+1}" readonly style="color:#999"></td><td><input type="text" id="m_2_${i}" value="${r.m||''}" readonly style="background:#f1f5f9;color:#64748b"></td><td><input type="text" value="${r.unit||''}" onchange="d2[${i}].unit=this.value"></td><td class="align-left"><textarea onchange="d2[${i}].name=this.value">${r.name||''}</textarea></td><td><input type="text" value="${r.target||''}" onchange="d2[${i}].target=this.value"></td><td><div class="date-cell"><input type="text" value="${r.date||''}" onchange="updateMonthFromDate(2,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(2,${i})">ğŸ“…</button></div></td><td><input type="text" value="${r.loc||''}" onchange="d2[${i}].loc=this.value"></td><td><input type="number" value="${r.batch||''}" onchange="d2[${i}].batch=this.value"></td><td><input type="number" value="${r.pb||''}" onchange="d2[${i}].pb=this.value"></td><td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.pb)||0}</td><td><input type="number" value="${r.dHour||''}" onchange="d2[${i}].dHour=this.value"></td><td><input type="number" value="${r.bHour||''}" onchange="d2[${i}].bHour=this.value"></td><td style="background:#f1f5f9;text-align:center;line-height:36px">${(r.batch*r.bHour)||0}</td><td><input type="number" value="${r.inst||''}" onchange="d2[${i}].inst=this.value"></td><td class="td-checkbox"><input type="checkbox" class="excel-checkbox" ${r.ext?'checked':''} onchange="d2[${i}].ext=this.checked"></td><td class="align-left"><input type="text" value="${r.note||''}" onchange="d2[${i}].note=this.value"></td></tr>`; }); }
        function renderT3(){ const tb=document.getElementById('tbody3'); tb.innerHTML=''; d3.forEach((r,i)=>{ tb.innerHTML+=`<tr><td style="text-align:center"><button class="del-btn" onclick="delRow(3,${i})" style="border:none;background:none;color:#94a3b8;cursor:pointer;">âœ•</button></td><td><input type="text" value="${i+1}" readonly style="color:#999"></td><td><input type="text" value="${r.unit||''}" onchange="d3[${i}].unit=this.value"></td><td class="align-left"><textarea onchange="d3[${i}].name=this.value">${r.name||''}</textarea></td><td><input type="text" value="${r.target||''}" onchange="d3[${i}].target=this.value"></td><td><div class="date-box"><input type="text" value="${r.date||''}" onchange="updateMonthFromDate(3,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(3,${i})">ğŸ“…</button></div></td><td><input type="number" value="${r.days||''}" onchange="d3[${i}].days=this.value"></td><td><input type="number" value="${r.hours||''}" onchange="d3[${i}].hours=this.value"></td><td class="col-red-light"><input type="number" value="${r.mp||''}" onchange="d3[${i}].mp=this.value" class="text-danger"></td><td class="align-left"><input type="text" value="${r.loc||''}" onchange="d3[${i}].loc=this.value"></td></tr>`; }); }

        // --- Gantt Logic ---
        function renderGantt() {
            const h = document.getElementById('ganttHeader');
            h.innerHTML = '<th class="col-fix-name">ç­æœŸ / æ´»å‹•åç¨±</th>';
            for(let i=1; i<=31; i++) h.innerHTML += `<th class="col-fix-day">${i}</th>`;
            const container = document.getElementById('ganttContainer'); container.innerHTML = '';

            let rows = [];
            const parse = (r) => parseDateStr(r.date, r.ex);
            const add = (r, val, prefix) => {
                let daysSet = parse(r);
                let involvedMonths = [...new Set(daysSet.map(o => o.m))].sort((a,b)=>a-b);
                involvedMonths.forEach(m => {
                    let daysInThisMonth = daysSet.filter(o => o.m === m).map(o => o.d);
                    let label = `${r.date} ${r.name} ${val>0 ? `(${prefix} ${val}äºº)` : ''}`;
                    rows.push({ m: m, n: label, ds: daysInThisMonth, v: val });
                });
            };
            d1.forEach(r => { if(r.date && r.mp) add(r, r.mp, 'èª¿ç”¨'); });
            d2.forEach(r => { if(r.date && r.inst) add(r, r.inst, 'æ•™å®˜'); });
            d3.forEach(r => { if(r.date && r.mp) add(r, r.mp, 'èª¿ç”¨'); });

            let grp = {}; for(let i=1;i<=12;i++) grp[i]=[];
            rows.forEach(r=>{if(grp[r.m])grp[r.m].push(r)});

            for(let m=1; m<=12; m++) {
                if(grp[m].length === 0) continue;
                let tbody = document.createElement('tbody');
                tbody.className = 'gantt-month-group';
                tbody.id = `month-${m}`;
                let html = `<tr class="gantt-month-header"><td class="fix-month" colspan="32">${m} æœˆä»½</td></tr>`;
                let sum = Array(32).fill(0);

                grp[m].forEach(r => {
                    let vis = `<tr class="gantt-visual-row"><td class="col-fix-name" style="border-right:1px solid #64748b;border-bottom:none;"></td>`;
                    let dat = `<tr class="gantt-data-row"><td class="col-fix-name" style="padding-left:10px;border-top:none;" title="${r.n}">${r.n}</td>`;
                    for(let i=1; i<=31; i++) {
                        let act = r.ds.includes(i);
                        if(act) sum[i] += parseInt(r.v);
                        vis += `<td class="col-fix-day gantt-cell-bar ${act?'bar-active':''}"></td>`;
                        dat += `<td class="col-fix-day gantt-num">${act ? `<input type="text" value="${r.v}" readonly>` : ''}</td>`;
                    }
                    html += vis + '</tr>' + dat + '</tr>';
                });
                let sRow = `<tr class="stats-row"><td class="col-fix-name">æ¯æ—¥çµ±è¨ˆ</td>`;
                for(let i=1; i<=31; i++) sRow += `<td class="col-fix-day">${sum[i]}</td>`;
                html += sRow + '</tr>';
                tbody.innerHTML = html;
                container.appendChild(tbody);
            }
        }

        function parseDateStr(str, excludeList) {
            let results = []; if(!str) return results;
            try {
                let s = str.replace(/ï¼ˆ.*?ï¼‰/g, '').replace(/\(.*?\)/g, '').trim();
                let parts = s.split(/[,ã€]/);
                parts.forEach(part => {
                    part = part.trim();
                    let cross = part.match(/(\d+)\/(\d+)\s*-\s*(\d+)\/(\d+)/);
                    if(cross) {
                        let m1=+cross[1], d1=+cross[2], m2=+cross[3], d2=+cross[4];
                        let cur = new Date(2025, m1-1, d1), end = new Date(2025, m2-1, d2);
                        while(cur <= end) { results.push({ m: cur.getMonth()+1, d: cur.getDate() }); cur.setDate(cur.getDate()+1); }
                        return;
                    }
                    let rng = part.match(/(\d+)\/(\d+)\s*-\s*(\d+)/);
                    if(rng) { let m=+rng[1], d1=+rng[2], d2=+rng[3]; for(let i=d1; i<=d2; i++) results.push({m:m, d:i}); return; }
                    let sgl = part.match(/(\d+)\/(\d+)/);
                    if(sgl) { results.push({m:+sgl[1], d:+sgl[2]}); }
                });
                if(excludeList && excludeList.length > 0) results = results.filter(o => !excludeList.includes(o.d));
            } catch(e) { console.error(e); }
            return results;
        }

        // --- Utils ---
        let curEdit=null;
        function openDateModal(t,i) {
            curEdit={t,i}; let r=(t==1?d1:t==2?d2:d3)[i];
            let allObj = parseDateStr(r.date, []);
            if(allObj.length==0) return alert('è«‹å…ˆè¼¸å…¥æ­£ç¢ºæ—¥æœŸ');
            let firstM = allObj[0].m;
            let daysInM = allObj.filter(o=>o.m===firstM).map(o=>o.d);
            document.getElementById('modalRangeText').innerText = `ç·¨è¼¯æœˆä»½: ${firstM}æœˆ (åƒ…æ”¯æ´é¦–æœˆæ’é™¤)`;
            let grid=document.getElementById('calendarGrid'); grid.innerHTML='';
            for(let d=1; d<=31; d++){
                let btn=document.createElement('div'); btn.className='day-btn'; btn.innerText=d;
                if(daysInM.includes(d)) {
                    btn.classList.add('active');
                    if((r.ex||[]).includes(d)) btn.classList.add('excluded');
                    btn.onclick = ()=> btn.classList.toggle('excluded');
                } else btn.classList.add('disabled');
                grid.appendChild(btn);
            }
            document.getElementById('dateModal').style.display='flex';
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function saveDateModal() {
            let ex = Array.from(document.querySelectorAll('#calendarGrid .day-btn.active.excluded')).map(b=>parseInt(b.innerText));
            (curEdit.t==1?d1:curEdit.t==2?d2:d3)[curEdit.i].ex = ex; closeModal('dateModal'); renderAll();
        }
        function applyDateFilter(type) {
            let row=(curEdit.t==1?d1:curEdit.t==2?d2:d3)[curEdit.i];
            let allObj = parseDateStr(row.date, []);
            let m = allObj.length>0 ? allObj[0].m : 1;
            document.querySelectorAll('#calendarGrid .day-btn.active').forEach(b=>{
                let d=parseInt(b.innerText), dt=new Date(2025, m-1, d), w=dt.getDay();
                if(type=='all') b.classList.remove('excluded');
                if(type=='clear') b.classList.add('excluded');
                if(type=='no-weekend') { if(w==0||w==6) b.classList.add('excluded'); else b.classList.remove('excluded'); }
                if(type=='only-weekend') { if(w==0||w==6) b.classList.remove('excluded'); else b.classList.add('excluded'); }
            });
        }
        function openPrintModal(act) {
            printActionType=act;
            const grid=document.getElementById('printMonthGrid'); grid.innerHTML='';
            for(let m=1;m<=12;m++){
                let btn=document.createElement('div'); btn.className='month-select-btn selected';
                btn.innerText=`${m} æœˆ`; btn.dataset.m=m;
                btn.onclick=()=>btn.classList.toggle('selected');
                grid.appendChild(btn);
            }
            document.getElementById('printModal').style.display='flex';
        }
        function toggleAllMonths(){
            let all=document.querySelectorAll('.month-select-btn');
            let hasUn=Array.from(all).some(b=>!b.classList.contains('selected'));
            all.forEach(b=>hasUn?b.classList.add('selected'):b.classList.remove('selected'));
        }
        function executePrintOrExport() {
            let selected=Array.from(document.querySelectorAll('.month-select-btn.selected')).map(b=>b.dataset.m);
            closeModal('printModal');
            for(let m=1;m<=12;m++){ let tb=document.getElementById(`month-${m}`); if(tb) tb.style.display=selected.includes(String(m))?'table-header-group':'none'; }
            
            if(printActionType==='print') {
                setTimeout(()=>{ downloadPDF(); }, 300);
            } else {
                exportExcelJS(selected);
                for(let m=1;m<=12;m++){let tb=document.getElementById(`month-${m}`);if(tb)tb.style.display='table-header-group';}
            }
        }
        function delRow(t, i) {
            let arr = t==1?d1:t==2?d2:d3;
            if(arr[i].isNew) { arr.splice(i, 1); renderAll(); } 
            else { if(prompt("è¼¸å…¥å¯†ç¢¼ (119) åˆªé™¤:")==="119") { arr.splice(i, 1); renderAll(); } }
        }
        function addRow(t) {
            let o = {isNew:true, ex:[], date:''};
            if(t==1) d1.push({...o, m:'', mp:0}); if(t==2) d2.push({...o, m:'', inst:0}); if(t==3) d3.push({...o, unit:'', mp:0});
            renderAll();
        }
        function downloadCSVTemplate() {
            let c="\uFEFF";
            if(currentTab==1) c+="æœˆä»½,æ‰¿è¾¦å–®ä½,èª²ç¨‹åç¨±,è¨“ç·´å°è±¡,èª²ç¨‹æ—¥æœŸ,ä¸Šèª²åœ°é»,æ¢¯æ•¸,æ¯æ¢¯äººæ•¸,æ¯å¤©æ™‚æ•¸,æ¯æ¢¯æ™‚æ•¸,é è¨ˆèª¿ç”¨äººæ•¸,æ˜¯å¦æä¾›å®œåŸºåŒ—æ¡ƒåƒè¨“,æ–°åŒ—,åŸºéš†,æ¡ƒåœ’,å®œè˜­,å‚™è¨»\n";
            if(currentTab==2) c+="æœˆä»½,æ‰¿è¾¦å–®ä½,èª²ç¨‹åç¨±,è¨“ç·´å°è±¡,èª²ç¨‹æ—¥æœŸ,è¨“ç·´åœ°é»,æ¢¯æ•¸,æ¯æ¢¯äººæ•¸,æ¯å¤©æ™‚æ•¸,æ¯æ¢¯æ™‚æ•¸,èª¿ç”¨æ•™å®˜äººæ•¸,æ˜¯å¦æä¾›è·¨ç¸£å¸‚,å‚™è¨»\n";
            if(currentTab==3) c+="æ‰¿è¾¦å–®ä½,é‡å¤§æ´»å‹•æ¼”ç¿’åç¨±,åƒåŠ å°è±¡,æ—¥æœŸ,å¤©æ•¸,æ™‚æ•¸,æ¯æ—¥èª¿ç”¨å¤–å‹¤äººæ•¸,åœ°é»\n";
            saveAs(new Blob([c],{type:'text/csv;charset=utf-8;'}), `ç¯„æœ¬_é™„ä»¶${currentTab}.csv`);
        }
        function processCSV(inp) {
            if(!inp.files[0]) return;
            Papa.parse(inp.files[0], {complete:function(res){
                if(res.data.length<2) return alert("ç„¡è³‡æ–™");
                let target=currentTab==1?d1:currentTab==2?d2:d3;
                res.data.forEach((r,i)=>{
                    if(i==0||r.length<3)return;
                    let o={isNew:true,ex:[]};
                    if(currentTab==1){o.m=r[0];o.unit=r[1];o.name=r[2];o.target=r[3];o.date=r[4];o.loc=r[5];o.batch=r[6];o.pb=r[7];o.dh=r[8];o.bh=r[9];o.mp=r[10];o.ext=(r[11]=='æ˜¯');o.nt=r[12];o.kl=r[13];o.ty=r[14];o.yl=r[15];o.note=r[16];}
                    else if(currentTab==2){o.m=r[0];o.unit=r[1];o.name=r[2];o.target=r[3];o.date=r[4];o.loc=r[5];o.batch=r[6];o.pb=r[7];o.dh=r[8];o.bh=r[9];o.inst=r[10];o.ext=(r[11]=='æ˜¯');o.note=r[12];}
                    else {o.unit=r[0];o.name=r[1];o.target=r[2];o.date=r[3];o.days=r[4];o.hours=r[5];o.mp=r[6];o.loc=r[7];}
                    target.push(o);
                });
                renderAll(); alert("åŒ¯å…¥å®Œæˆï¼Œè«‹æŒ‰å„²å­˜");
            }});
            inp.value='';
        }

        // --- HTML2PDF ---
        function downloadPDF() {
            const element = document.getElementById('ganttExportArea');
            const opt = {
                margin: 5, filename: 'ç”˜ç‰¹åœ–å ±è¡¨.pdf', image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save().then(() => {
                for(let m=1;m<=12;m++){let tb=document.getElementById(`month-${m}`);if(tb)tb.style.display='table-header-group';}
            });
        }

        // --- ExcelJS Export (Fix Color & Sum) ---
        async function exportExcelJS(selM) {
            const wb = new ExcelJS.Workbook();
            const sh = wb.addWorksheet('ç”˜ç‰¹åœ–');
            const hSty = (c) => { c.font={bold:true}; c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'E2E8F0'}}; c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}}; c.alignment={horizontal:'center'}; };
            
            sh.getColumn(1).width = 50; 
            for(let k=2; k<=32; k++) sh.getColumn(k).width = 4;

            sh.addRow(["ç­æœŸ / æ´»å‹•åç¨±", ...Array.from({length:31},(_,k)=>k+1)]).eachCell(c=>hSty(c));

            let rows=[];
            const parse = (r) => parseDateStr(r.date, r.ex);
            d1.forEach(r=>{if(r.date&&r.mp)rows.push({m:r.m||'1',n:r.name,ds:parse(r),v:r.mp})});
            d2.forEach(r=>{if(r.date&&r.inst)rows.push({m:r.m||'1',n:r.name,ds:parse(r),v:r.inst})});
            d3.forEach(r=>{if(r.date&&r.mp){let m=r.date.match(/^(\d+)/);rows.push({m:m?m[1]:'1',n:r.name,ds:parse(r),v:r.mp})}});
            let grp={}; for(let i=1;i<=12;i++) grp[i]=[];
            rows.forEach(r=>{if(grp[r.m])grp[r.m].push(r)});

            selM.forEach(m => {
                if(grp[m].length===0) return;
                let mt = sh.addRow([`${m} æœˆä»½`]);
                mt.font={bold:true, size:12};
                mt.getCell(1).fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE2E8F0'}}; // Fix ARGB

                let sum=Array(32).fill(0);
                grp[m].forEach(r => {
                    let d=[r.n];
                    for(let i=1;i<=31;i++) {
                        if(r.ds.includes(i)){ d.push(parseInt(r.v)); sum[i]+=parseInt(r.v); } else d.push("");
                    }
                    let rw = sh.addRow(d);
                    rw.eachCell((c, col) => {
                        c.border = {top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'}};
                        c.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                        if(col===1) c.alignment = { horizontal: 'left', wrapText: true };
                        if(col>1 && c.value!=="") {
                            c.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FF3B82F6'}}; // Fix ARGB
                            c.font = {color:{argb:'FFFFFFFF'}, bold:true};
                        }
                    });
                });
                let sd=["æ¯æ—¥çµ±è¨ˆ"];
                for(let i=1;i<=31;i++) sd.push(sum[i]);
                let sr = sh.addRow(sd);
                sr.eachCell((c, col)=>{
                    c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF1F5F9'}}; // Fix ARGB
                    c.font={bold:true,color:{argb:'FF1E40AF'}};
                    c.border={top:{style:'double'},bottom:{style:'thick'},left:{style:'thin'},right:{style:'thin'}};
                    c.alignment={horizontal:'center'};
                });
                sh.addRow([]);
            });
            
            const buf=await wb.xlsx.writeBuffer();
            saveAs(new Blob([buf]), "ç”˜ç‰¹åœ–å ±è¡¨.xlsx");
        }
    </script>
</body>
</html>
