<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>訓練流路管理系統</title>

    <!-- 核心工具庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 視覺框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // 1. 系統連結
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwDk9vkK3Idu7ax_mpfx4hcW36Bn_IIoen72gqXmNRPlXn6PDzQJMgONXAqCX46uJd9OA/exec";
        const PORTAL_URL = "https://tfd-train.github.io/Training-Management-Platform/";
        const OTHER_SYSTEM_URL = "https://tfd-train.github.io/Facility-Booking/";
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .table-container { overflow-x: auto; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { border-collapse: collapse; font-size: 13px; table-layout: fixed; width: auto; border-spacing: 0; }
        #table1 { min-width: 2000px; } #table2 { min-width: 1800px; }
        td { border: 1px solid #cbd5e1; height: auto; min-height: 38px; background: white; padding: 0; vertical-align: middle; }
        input[type="text"], input[type="number"] { width: 100%; height: 38px; border: none; outline: none; background: transparent; text-align: center; font-family: inherit; font-size: 13px; display: block; color: #334155; }
        input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        textarea { width: 100%; min-height: 38px; height: 100%; border: none; resize: none; outline: none; background: transparent; font-family: inherit; font-size: 13px; text-align: left; padding: 8px; box-sizing: border-box; line-height: 1.4; }
        textarea:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        
        /* 甘特圖 CSS - 強力對齊 */
        #table4 { width: 1232px !important; min-width: 1232px !important; max-width: 1232px !important; table-layout: fixed !important; border-collapse: collapse; margin: 0; }
        .col-fix-name { width: 300px !important; min-width: 300px !important; max-width: 300px !important; white-space: normal; word-break: break-all; line-height: 1.3; padding: 5px; border: 1px solid #000 !important; vertical-align: middle !important; background: #fff; box-sizing: border-box; }
        .col-fix-day { width: 30px !important; min-width: 30px !important; max-width: 30px !important; text-align: center; padding: 0 !important; border: 1px solid #000 !important; box-sizing: border-box; }
        .gantt-visual-row, .gantt-data-row { height: 28px; line-height: 28px; }
        .gantt-cell-bar { border-bottom: none; height: 28px; }
        .gantt-num { border-top: none; font-weight: bold; color: #000; font-size: 12px; height: 28px; line-height: 28px; }
        .weekend { background-color: #f3f4f6; }
        .holiday-red { background-color: #fee2e2; }
        .bar-active { background-color: #3b82f6 !important; border-color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        tbody.gantt-month-group { break-inside: avoid; page-break-inside: avoid; border-bottom: 2px solid #000; }
        .gantt-month-header td { background: #e2e8f0; font-weight: bold; padding-left: 15px; border: 1px solid #000; font-size: 14px; height: 32px; }
        .stats-row td { background-color: #f8fafc; border: 1px solid #000; color: #1e40af; font-weight: bold; text-align: center; }
        .date-cell { display: flex; align-items: center; height: 100%; }
        .date-cell input { flex: 1; }
        .btn-calendar { width: 30px; height: 100%; min-height: 38px; border: none; border-left: 1px solid #cbd5e1; cursor: pointer; background: #f8fafc; color: #64748b; transition: 0.2s; }
        .col-yellow { background: #ffffcc !important; }
        .col-blue-light { background: #e0f2fe !important; }
        .col-red-light { background: #fee2e2 !important; }
        
        /* Modal */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
        .day-btn { padding: 8px; border: 1px solid #e2e8f0; background: white; cursor: pointer; text-align: center; border-radius: 6px; font-size: 14px; }
        .day-btn.active.excluded { background: #64748b; color: white; text-decoration: line-through; border-color: #475569; }
        .day-btn.active { background: #dbeafe; color: #1e40af; font-weight: bold; border-color: #3b82f6; }
        .print-month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .month-select-btn { padding: 10px; border: 1px solid #e2e8f0; background: white; cursor: pointer; text-align: center; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .month-select-btn.selected { background: #3b82f6; color: white; border-color: #2563eb; }
        #loading { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; font-size: 16px; backdrop-filter: blur(4px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            body { background: white; height: auto; overflow: visible; display: block !important; }
            #sidebar, .top-bar, .btn-add-row, .del-btn, .btn-calendar, #loading, #csvInput, #toolbar-container, .mobile-header, #yearSelectorContainer { display: none !important; }
            .main-content, .workspace, .view-section, .table-container { width: 100%; height: auto; overflow: visible; display: block; padding: 0; margin: 0; border: none; box-shadow: none; }
            .view-section { display: none; }
            .view-section.active { display: block; }
            #table4 { width: 1232px !important; min-width: 1232px !important; table-layout: fixed !important; }
            .col-fix-name { width: 300px !important; }
            .col-fix-day { width: 30px !important; padding: 0 !important; }
            table, th, td { border: 1px solid #000 !important; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-blue-500 selection:text-white">

    <div id="loading"><div class="spinner"></div><div id="loadText">處理中...</div></div>

    <!-- Modal 區域 -->
    <div id="dateModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-[420px] p-6 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-lg text-slate-800">選擇日期</h3>
                <select id="pickerYearSelect" onchange="changePickerYear(this.value)" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded p-1 font-bold">
                    <option value="2025">114年</option>
                    <option value="2026">115年</option>
                    <option value="2027">116年</option>
                    <option value="2028">117年</option>
                    <option value="2029">118年</option>
                </select>
            </div>
            <div id="modalRangeText" class="text-sm text-blue-600 mb-3 font-mono"></div>
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100" onclick="applyDateFilter('all')">全選</button>
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100" onclick="applyDateFilter('no-weekend')">排除六日</button>
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100" onclick="applyDateFilter('only-weekend')">僅選六日</button>
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100 text-red-500 border-red-200" onclick="applyDateFilter('clear')">清除</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="px-5 py-2 text-slate-500 hover:bg-slate-100 rounded-xl font-bold" onclick="closeModal('dateModal')">取消</button>
                <button class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg" onclick="saveDateModal()">確定</button>
            </div>
        </div>
    </div>

    <div id="printModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-[420px] p-6 rounded-2xl shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-slate-800">請選擇輸出月份</h3>
            <div class="flex justify-between items-center mb-4"><span class="text-xs text-slate-500">未選取月份將被隱藏</span><button class="px-2 py-1 text-xs border rounded" onclick="toggleAllMonths()">全選/反選</button></div>
            <div class="print-month-grid" id="printMonthGrid"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="px-5 py-2 text-slate-500 hover:bg-slate-100 rounded-xl font-bold" onclick="closeModal('printModal')">取消</button>
                <button class="px-5 py-2 bg-slate-900 text-white rounded-xl hover:bg-slate-800 font-bold shadow-lg" onclick="executePrintOrExport()">確認執行</button>
            </div>
        </div>
    </div>

    <!-- 側邊欄 -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-30 transition-all duration-300">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i class="ri-flow-chart text-white"></i></div>
            <div><h1 class="font-bold text-lg tracking-wide">訓練流路</h1><p class="text-xs text-slate-400">訓練中心內部系統</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div onclick="switchTab(1, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl bg-blue-600/20 text-blue-300 border border-blue-500/30 flex items-center gap-3 hover:bg-blue-600 hover:text-white transition"><i class="ri-user-fire-line text-xl"></i> 消防人員</div>
            <div onclick="switchTab(2, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-group-line text-xl"></i> 非消防人員</div>
            <div onclick="switchTab(3, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-flag-line text-xl"></i> 重大活動</div>
            <div onclick="switchTab(4, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-bar-chart-horizontal-line text-xl"></i> 甘特圖</div>
        </nav>
        <div class="p-4 border-t border-slate-800 space-y-2 bg-slate-900">
            <div class="text-[10px] text-slate-500 font-bold px-4 mb-1 uppercase tracking-wider">系統切換</div>
            <a href="javascript:void(0)" onclick="location.href=OTHER_SYSTEM_URL" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm"><i class="ri-building-2-fill text-lg text-indigo-400"></i> 場地借用系統</a>
            <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-500 hover:text-white transition text-xs"><i class="ri-arrow-left-line"></i> 回整合首頁</a>
        </div>
    </aside>

    <!-- 主內容 -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
        <div class="mobile-header bg-white md:hidden h-14 flex items-center justify-between px-4 shadow-sm border-b border-slate-200 z-20">
            <div class="flex items-center gap-3"><button onclick="toggleMobileSidebar()" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button><div class="font-bold text-slate-800" id="mobilePageTitle">消防人員</div></div>
            <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="text-slate-400 hover:text-blue-600"><i class="ri-home-4-line text-xl"></i></a>
        </div>

        <div id="toolbar-container" class="bg-white px-6 py-3 border-b border-slate-200 flex flex-wrap items-center justify-between gap-3 shadow-sm z-10">
            <div class="text-lg font-bold text-slate-800 hidden md:flex items-center gap-2" id="pageTitle"><span class="w-2 h-6 bg-blue-600 rounded-full"></span> 附件1 - 消防人員</div>
            <div id="yearSelectorContainer" class="hidden flex items-center gap-2">
                <span class="text-sm font-bold text-slate-600">年度:</span>
                <select id="yearSelect" onchange="changeYear(this.value)" class="bg-white border border-slate-300 text-slate-800 text-sm rounded-lg block p-1.5 font-bold">
                    <option value="2025">114年</option>
                    <option value="2026">115年</option>
                    <option value="2027">116年</option>
                    <option value="2028">117年</option>
                    <option value="2029">118年</option>
                </select>
            </div>
            <div class="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0" id="toolbar"></div>
        </div>

        <div class="flex-1 overflow-hidden p-4 relative">
            <div id="view1" class="view-section h-full flex flex-col">
                <div class="table-container flex-1 mb-4">
                    <table id="table1">
                        <thead><tr><th style="width:50px">刪除</th><th style="width:40px">項次</th><th style="width:40px">月份</th><th style="width:100px">承辦單位</th><th style="width:200px">課程名稱</th><th style="width:80px">訓練對象</th><th style="width:140px">課程日期</th><th style="width:120px">上課地點</th><th style="width:40px">梯數</th><th style="width:50px">每梯<br>人數</th><th style="width:50px">合計<br>人數</th><th style="width:50px">每天<br>時數</th><th style="width:50px">每梯<br>時數</th><th style="width:50px">合計<br>時數</th><th style="width:100px" class="col-blue-light">預計調用人數<br>(分隊人力)</th><th style="width:120px" class="col-yellow">是否提供宜基<br>北桃參訓</th><th style="width:60px" class="col-yellow">暫訂<br>新北</th><th style="width:60px" class="col-yellow">暫訂<br>基隆</th><th style="width:60px" class="col-yellow">暫訂<br>桃園</th><th style="width:60px" class="col-yellow">暫訂<br>宜蘭</th><th style="width:150px">備註</th></tr></thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0" onclick="addRow(1)"><i class="ri-add-line text-lg"></i> 新增資料列</button>
            </div>

            <div id="view2" class="view-section hidden h-full flex flex-col">
                <div class="table-container flex-1 mb-4">
                    <table id="table2">
                        <thead><tr><th style="width:50px">刪除</th><th style="width:40px">序號</th><th style="width:40px">月份</th><th style="width:100px">承辦單位</th><th style="width:200px">課程名稱</th><th style="width:120px">訓練對象</th><th style="width:140px">課程日期</th><th style="width:120px">訓練地點</th><th style="width:40px">梯數</th><th style="width:50px">每梯<br>人數</th><th style="width:50px">合計<br>人數</th><th style="width:50px">每天<br>時數</th><th style="width:50px">每梯<br>時數</th><th style="width:50px">合計<br>時數</th><th style="width:80px">調用本局<br>教官人數</th><th style="width:100px">是否提供<br>跨縣市</th><th style="width:150px">備註</th></tr></thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0" onclick="addRow(2)"><i class="ri-add-line text-lg"></i> 新增資料列</button>
            </div>

            <div id="view3" class="view-section hidden h-full flex flex-col">
                <div class="table-container flex-1 mb-4">
                    <table id="table3">
                        <thead><tr><th style="width:50px">刪除</th><th style="width:40px">序號</th><th style="width:100px">承辦單位</th><th style="width:250px">重大活動演習名稱</th><th style="width:150px">參加對象</th><th style="width:140px">日期</th><th style="width:50px">天數</th><th style="width:50px">時數</th><th style="width:100px" class="col-red-light">每日調用<br>外勤人數</th><th style="width:150px">地點(教室)</th></tr></thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0" onclick="addRow(3)"><i class="ri-add-line text-lg"></i> 新增資料列</button>
            </div>

            <div id="view4" class="view-section hidden h-full flex flex-col">
                <div class="bg-amber-50 text-amber-800 px-4 py-3 rounded-xl border border-amber-200 text-sm mb-4 flex items-center gap-2 shadow-sm">
                    <i class="ri-calendar-event-line text-lg text-amber-500"></i>
                    <span><strong>說明：</strong> 紅色底色代表國定假日或週末。資料來源：內建行政院行事曆。</span>
                </div>
                <div class="table-container flex-1 p-4 bg-white">
                    <div id="ganttExportArea">
                        <table id="table4">
                            <tbody id="ganttContainer"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">

    <script>
        // === 全域變數定義 ===
        let d1 = [], d2 = [], d3 = [];
        let currentTab = 1; 
        let printActionType = '';
        
        const nowYear = new Date().getFullYear();
        let currentYear = (nowYear >= 2025 && nowYear <= 2029) ? nowYear : 2025;
        
        // 內建假日表 (2025-2026)
        const builtInHolidays = {
            '2025-1-1': true, '2025-1-25': true, '2025-1-26': true, '2025-1-27': true, '2025-1-28': true, 
            '2025-1-29': true, '2025-1-30': true, '2025-1-31': true, '2025-2-1': true, '2025-2-2': true, 
            '2025-2-28': true, '2025-4-3': true, '2025-4-4': true, '2025-4-5': true, '2025-4-6': true, 
            '2025-5-30': true, '2025-5-31': true, '2025-6-1': true, '2025-10-4': true, '2025-10-5': true, 
            '2025-10-6': true, '2025-10-10': true, '2025-10-11': true, '2025-10-12': true, 
            '2026-1-1': true, '2026-2-16': true, '2026-2-17': true, '2026-2-18': true, '2026-2-19': true, 
            '2026-2-20': true, '2026-2-28': true, '2026-4-4': true, '2026-4-5': true, '2026-6-19': true, 
            '2026-9-25': true, '2026-10-10': true
        };

        let currentEdit = null;
        let selectedDates = new Set();
        let currentCalendarMonth = 1;
        let pickerYear = currentYear; // 日曆彈窗專用的年份變數

        // === 核心渲染函式 ===
        function renderT1() {
            const tb = document.getElementById('tbody1'); 
            if(!tb) return;
            tb.innerHTML = '';
            d1.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(1,${i})"><i class="ri-close-circle-fill text-xl"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_1_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d1[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d1[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d1[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(1,${i},this.value)" placeholder="點擊選取"><button class="btn-calendar" onclick="openDateModal(1,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="text" value="${r.loc || ''}" onchange="d1[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d1[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d1[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.pb) || 0}</td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d1[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bh || ''}" onchange="d1[${i}].bh=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.bh) || 0}</td>
                <td class="col-blue-light"><input type="number" value="${r.mp || ''}" onchange="d1[${i}].mp=this.value"></td>
                <td style="text-align:center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d1[${i}].ext=this.checked"></td>
                <td><input type="number" value="${r.nt || ''}" onchange="d1[${i}].nt=this.value"></td>
                <td><input type="number" value="${r.kl || ''}" onchange="d1[${i}].kl=this.value"></td>
                <td><input type="number" value="${r.ty || ''}" onchange="d1[${i}].ty=this.value"></td>
                <td><input type="number" value="${r.yl || ''}" onchange="d1[${i}].yl=this.value"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d1[${i}].note=this.value"></td></tr>`;
            });
        }

        function renderT2() {
            const tb = document.getElementById('tbody2'); 
            if(!tb) return;
            tb.innerHTML = '';
            d2.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(2,${i})"><i class="ri-close-circle-fill text-xl"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_2_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d2[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d2[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d2[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(2,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(2,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="text" value="${r.loc || ''}" onchange="d2[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d2[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d2[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.pb) || 0}</td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d2[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bHour || ''}" onchange="d2[${i}].bHour=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.bHour) || 0}</td>
                <td><input type="number" value="${r.inst || ''}" onchange="d2[${i}].inst=this.value"></td>
                <td style="text-align:center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d2[${i}].ext=this.checked"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d2[${i}].note=this.value"></td></tr>`;
            });
        }

        function renderT3() {
            const tb = document.getElementById('tbody3'); if(!tb) return; tb.innerHTML = '';
            d3.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(3,${i})"><i class="ri-close-circle-fill text-xl"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d3[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d3[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d3[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(3,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(3,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="number" value="${r.days || ''}" onchange="d3[${i}].days=this.value"></td>
                <td><input type="number" value="${r.hours || ''}" onchange="d3[${i}].hours=this.value"></td>
                <td class="col-red-light"><input type="number" value="${r.mp || ''}" onchange="d3[${i}].mp=this.value"></td>
                <td class="align-left"><input type="text" value="${r.loc || ''}" onchange="d3[${i}].loc=this.value"></td></tr>`;
            });
        }

        function renderAll() { renderT1(); renderT2(); renderT3(); }

        // === 輔助與事件函式 (修正日曆變數範圍) ===
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden'); sidebar.classList.toggle('absolute'); sidebar.classList.toggle('h-full');
        }

        function updateMonthFromDate(t, i, val) { 
            let match = val.match(/^(\d+)\//); 
            if (match) { 
                let m = match[1]; 
                if (t === 1) d1[i].m = m; if (t === 2) d2[i].m = m; 
                const mEl = document.getElementById(`m_${t}_${i}`); if(mEl) mEl.value = m; 
            } 
            if (t === 1) d1[i].date = val; 
            if (t === 2) d2[i].date = val; 
            if (t === 3) d3[i].date = val; 
        }

        function addRow(t) {
            if (t === 1) d1.push({ m: '', unit: '', name: '', target: '', date: '', loc: '', batch: '', pb: '', mp: 0, ext: false, nt: '', kl: '', ty: '', yl: '', note: '', ex: [], isNew: true });
            if (t === 2) d2.push({ m: '', unit: '', name: '', target: '', date: '', loc: '', batch: '', pb: '', inst: 0, ext: false, note: '', ex: [], isNew: true });
            if (t === 3) d3.push({ unit: '', name: '', target: '', date: '', days: '', hours: '', mp: 0, loc: '', ex: [], isNew: true });
            renderAll();
        }

        function delRow(t, i) {
            const input = prompt("⚠️ 確定要刪除嗎？\n此操作無法復原！\n\n請輸入防呆碼「119」以確認刪除：");
            if (input === "119") {
                if (t === 1) d1.splice(i, 1);
                if (t === 2) d2.splice(i, 1);
                if (t === 3) d3.splice(i, 1);
                renderAll();
            } else if (input !== null) {
                alert("防呆碼錯誤，取消刪除。");
            }
        }

        function switchTab(idx, el) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(e => { e.classList.remove('bg-blue-600/20', 'text-blue-300', 'border-blue-500/30'); e.classList.add('text-slate-400'); });
            if(el) { el.classList.remove('text-slate-400'); el.classList.add('bg-blue-600/20', 'text-blue-300', 'border', 'border-blue-500/30'); }
            else {
                const sidebar = document.getElementById('sidebar');
                if(sidebar) { const btn = sidebar.querySelectorAll('.nav-item')[idx-1]; if(btn) btn.classList.add('bg-blue-600/20', 'text-blue-300'); }
            }

            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            const view = document.getElementById(`view${idx}`);
            if(view) view.classList.remove('hidden');
            
            currentTab = idx;
            const titles = ["附件1 - 消防人員", "附件2 - 非消防人員", "附件3 - 重大活動", "甘特圖"];
            const pageTitle = document.getElementById('pageTitle');
            if(pageTitle) pageTitle.innerHTML = `<span class="w-2 h-6 bg-blue-600 rounded-full"></span> ${titles[idx - 1]}`;
            const mobileTitle = document.getElementById('mobilePageTitle');
            if(mobileTitle) mobileTitle.innerText = titles[idx - 1].replace(/附件\d - /, '');
            
            const yearSelector = document.getElementById('yearSelectorContainer');
            if(yearSelector) { if (idx === 4) yearSelector.classList.remove('hidden'); else yearSelector.classList.add('hidden'); }

            updateToolbar();
            if (idx === 4) renderGantt();
        }

        function updateToolbar() {
            const bar = document.getElementById('toolbar');
            if(!bar) return;
            let html = '';
            const btnBase = "px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition whitespace-nowrap";
            const btnLight = `${btnBase} bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600`;
            const btnDark = `${btnBase} bg-slate-900 text-white hover:bg-slate-800 shadow-lg`;
            const btnGreen = `${btnBase} bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg`;
            const btnRed = `${btnBase} bg-rose-600 text-white hover:bg-rose-700 shadow-lg`;

            if (currentTab <= 3) {
                html += `<button class="${btnLight}" onclick="downloadCSVTemplate()"><i class="ri-download-2-line"></i> 範例</button>`;
                html += `<button class="${btnLight}" onclick="document.getElementById('csvInput').click()"><i class="ri-upload-2-line"></i> 匯入</button>`;
                html += `<button class="${btnDark}" onclick="saveData()"><i class="ri-save-3-line"></i> 儲存資料</button>`;
            } else {
                html += `<button class="${btnGreen}" onclick="openPrintModal('excel')"><i class="ri-file-excel-2-line"></i> 下載 Excel</button>`;
                html += `<button class="${btnRed}" onclick="openPrintModal('download')"><i class="ri-file-pdf-line"></i> 下載 PDF</button>`;
            }
            bar.innerHTML = html;
        }

        function showLoading(s, t) { 
            const ld = document.getElementById('loading'); if(ld) ld.style.display = s ? 'flex' : 'none'; 
            const txt = document.getElementById('loadText'); if(txt && t) txt.innerText = t; 
        }

        // === 雲端存取 (恢復) ===
        function loadData() {
            if (GAS_API_URL.includes("請填入")) { 
                // 沒設定網址時，初始化空資料
                if(d1.length === 0) addRow(1);
                if(d2.length === 0) addRow(2);
                if(d3.length === 0) addRow(3);
                renderAll();
                return; 
            }

            showLoading(true, "正在同步雲端資料...");
            fetch(GAS_API_URL)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        // 檢查回傳資料是否為空，若空則給預設值
                        d1 = (res.d1 && res.d1.length > 0) ? res.d1.map(r => ({ m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], batch: r[6], pb: r[7], mp: r[12], ext: r[13] === 'true', nt: r[14], kl: r[15], ty: r[16], yl: r[17], note: r[18], ex: JSON.parse(r[19] || '[]'), isNew: false, dHour: r[9], bHour: r[10] })) : [];
                        d2 = (res.d2 && res.d2.length > 0) ? res.d2.map(r => ({ m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], batch: r[6], pb: r[7], inst: r[12], ext: r[13] === 'true', note: r[14], ex: JSON.parse(r[15] || '[]'), isNew: false, dHour: r[9], bHour: r[10] })) : [];
                        d3 = (res.d3 && res.d3.length > 0) ? res.d3.map(r => ({ unit: r[0], name: r[1], target: r[2], date: r[3], days: r[4], hours: r[5], mp: r[6], loc: r[7], ex: JSON.parse(r[8] || '[]'), isNew: false })) : [];
                        
                        // 如果資料庫真的是空的，補一列空白
                        if (d1.length === 0) addRow(1);
                        if (d2.length === 0) addRow(2);
                        if (d3.length === 0) addRow(3);
                        
                        renderAll();
                    } else {
                        // 讀取失敗也要顯示空白列
                        if (d1.length === 0) addRow(1);
                        if (d2.length === 0) addRow(2);
                        if (d3.length === 0) addRow(3);
                        renderAll();
                    }
                })
                .catch(e => {
                    console.error("連線錯誤", e);
                    // 連線錯誤也要顯示空白列，確保 UI 正常
                    if (d1.length === 0) addRow(1);
                    if (d2.length === 0) addRow(2);
                    if (d3.length === 0) addRow(3);
                    renderAll();
                })
                .finally(() => showLoading(false));
        }

        function saveData() {
            showLoading(true, "正在儲存至雲端...");
            const p1 = d1.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch * r.pb) || 0, r.dHour, r.bHour, (r.batch * r.bHour) || 0, r.mp, r.ext, r.nt, r.kl, r.ty, r.yl, r.note, JSON.stringify(r.ex)]);
            const p2 = d2.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch * r.pb) || 0, r.dHour, r.bHour, (r.batch * r.bHour) || 0, r.inst, r.ext, r.note, JSON.stringify(r.ex)]);
            const p3 = d3.map(r => [r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.ex)]);
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ d1: p1, d2: p2, d3: p3 }), headers: { 'Content-Type': 'text/plain' } })
                .then(r => r.json()).then(res => { if (res.status === 'success') { alert(res.message);[d1, d2, d3].forEach(arr => arr.forEach(r => r.isNew = false)); renderAll(); } else alert("錯誤: " + res.message); })
                .catch(e => alert("存檔失敗 (連線錯誤)"))
                .finally(() => showLoading(false));
        }

        // === 智慧年份與日期邏輯 ===
        function changeYear(val) {
            currentYear = parseInt(val);
            currentCalendarMonth = 1;
            if(currentTab === 4) renderGantt();
        }

        function isDayOff(year, month, day) {
            const dateStr = `${year}-${month}-${day}`;
            const w = new Date(year, month - 1, day).getDay();
            if (builtInHolidays[dateStr]) return true;
            if (w === 0 || w === 6) return true;
            return false;
        }

        // 智慧日期解析修正版
        function parseDateStr(str, excludeList) {
            let results = [];
            if (!str) return results;
            
            try {
                let specificYear = null;
                let yearMatch = str.match(/(?:^|[^\d])(11[4-9]|12[0-9]|202[5-9])[年\/\.]/);
                if (yearMatch) {
                    let y = parseInt(yearMatch[1]);
                    specificYear = (y < 1000) ? (y + 1911) : y;
                }

                let s = str.trim()
                    .replace(/[０-９]/g, d => "０１２３４５６７８９".indexOf(d))
                    .replace(/（.*?）/g, '').replace(/\(.*?\)/g, '')
                    .replace(/11[3-6]年/g, '') 
                    .replace(/202[4-7]年/g, '')
                    .replace(/月/g, '/')
                    .replace(/日/g, '')
                    .replace(/～/g, '-').replace(/~/g, '-').replace(/－/g, '-')
                    .replace(/[、，,]/g, ' ')
                    .trim();

                let tokens = s.split(/\s+/);
                let currentMonth = null; 
                const today = new Date();
                let baseYear = specificYear;

                if (!baseYear) {
                    baseYear = today.getFullYear();
                }

                tokens.forEach(token => {
                    if (!token) return;

                    let explicitMonthMatch = token.match(/^(\d+)[\/.]/);
                    if (explicitMonthMatch) {
                        currentMonth = parseInt(explicitMonthMatch[1]);
                    }

                    if (!currentMonth && !explicitMonthMatch) return;

                    let checkDate = (m, d) => {
                        if (specificYear) return specificYear; 
                        let tempDate = new Date(today.getFullYear(), m - 1, d);
                        if (tempDate < today) return today.getFullYear() + 1; 
                        return today.getFullYear(); 
                    };

                    let crossMatch = token.match(/(\d+)[\/.](\d+)-(\d+)[\/.](\d+)/);
                    if (crossMatch) {
                        let m1 = parseInt(crossMatch[1]), d1 = parseInt(crossMatch[2]);
                        let m2 = parseInt(crossMatch[3]), d2 = parseInt(crossMatch[4]);
                        let y = checkDate(m1, d1); 
                        let cur = new Date(y, m1 - 1, d1);
                        let end = new Date(y, m2 - 1, d2);
                        if (end < cur) end.setFullYear(y + 1);
                        if (cur <= end) {
                            while (cur <= end) {
                                results.push({ m: cur.getMonth() + 1, d: cur.getDate(), y: cur.getFullYear() });
                                cur.setDate(cur.getDate() + 1);
                            }
                        }
                        currentMonth = m2; 
                        return;
                    }

                    let rangeWithMonth = token.match(/(\d+)[\/.](\d+)-(\d+)/);
                    if (rangeWithMonth) {
                        let m = parseInt(rangeWithMonth[1]);
                        let d1 = parseInt(rangeWithMonth[2]);
                        let d2 = parseInt(rangeWithMonth[3]);
                        let y = checkDate(m, d1);
                        currentMonth = m;
                        if (d2 >= d1) {
                            for (let i = d1; i <= d2; i++) results.push({ m: m, d: i, y: y });
                        }
                        return;
                    }

                    let rangeNoMonth = token.match(/^(\d+)-(\d+)$/);
                    if (rangeNoMonth) {
                        let d1 = parseInt(rangeNoMonth[1]);
                        let d2 = parseInt(rangeNoMonth[2]);
                        let y = checkDate(currentMonth, d1);
                        if (d2 >= d1) {
                            for (let i = d1; i <= d2; i++) results.push({ m: currentMonth, d: i, y: y });
                        }
                        return;
                    }

                    let singleWithMonth = token.match(/(\d+)[\/.](\d+)/);
                    if (singleWithMonth) {
                        let m = parseInt(singleWithMonth[1]);
                        let d = parseInt(singleWithMonth[2]);
                        let y = checkDate(m, d);
                        currentMonth = m;
                        results.push({ m: m, d: d, y: y });
                        return;
                    }

                    let singleNoMonth = token.match(/^(\d+)$/);
                    if (singleNoMonth) {
                        let d = parseInt(singleNoMonth[1]);
                        let y = checkDate(currentMonth, d);
                        results.push({ m: currentMonth, d: d, y: y });
                        return;
                    }
                });

                if (excludeList && excludeList.length > 0) {
                    results = results.filter(o => !excludeList.includes(o.d));
                }

            } catch (e) { console.error("日期解析失敗:", e); }
            return results;
        }

        // === 甘特圖與下載 ===
        function renderGantt() {
            const table = document.getElementById('table4');
            const container = document.getElementById('ganttContainer');
            if(!table || !container) return;
            
            let headerHTML = `<tr id="ganttHeader"><th class="col-fix-name">${currentYear}年 班期 / 活動名稱</th>`;
            for (let i = 1; i <= 31; i++) headerHTML += `<th class="col-fix-day">${i}</th>`;
            headerHTML += '</tr>';

            table.innerHTML = `
                <colgroup>
                    <col style="width: 300px; min-width: 300px;">
                    ${Array(31).fill('<col style="width: 30px; min-width: 30px;">').join('')}
                </colgroup>
                <thead>${headerHTML}</thead>
                <tbody id="ganttContainer"></tbody>
            `;

            const newContainer = document.getElementById('ganttContainer');
            let rows = [];
            const parse = (r) => parseDateStr(r.date, r.ex);

            const add = (r, val, prefix) => {
                let daysSet = parse(r);
                daysSet = daysSet.filter(d => d.y === currentYear);

                if (daysSet.length === 0) return;

                let involvedMonths = [...new Set(daysSet.map(o => o.m))].sort((a, b) => a - b);
                involvedMonths.forEach(m => {
                    let daysInThisMonth = daysSet.filter(o => o.m === m).map(o => o.d);
                    let label = `${r.date} ${r.name} ${val > 0 ? `(${prefix} ${val}人)` : ''}`;
                    rows.push({ m: m, n: label, ds: daysInThisMonth, v: val });
                });
            };

            d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用'); });
            d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, '教官'); });
            d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用'); });

            let grp = {}; for (let i = 1; i <= 12; i++) grp[i] = []; rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r) });

            for (let m = 1; m <= 12; m++) {
                if (grp[m].length === 0) continue;
                
                let tbody = document.createElement('tbody');
                tbody.className = 'gantt-month-group';
                tbody.id = `month-${m}`;
                let html = `<tr class="gantt-month-header"><td colspan="32">${m} 月份</td></tr>`;
                let sum = Array(32).fill(0);

                grp[m].forEach(r => {
                    let row1 = `<tr class="gantt-visual-row">
                        <td class="col-fix-name" rowspan="2">${r.n}</td>`;

                    let row2 = `<tr class="gantt-data-row">`;

                    for (let i = 1; i <= 31; i++) {
                        let act = r.ds.includes(i);
                        let isHoliday = isDayOff(currentYear, m, i);
                        let wkCls = isHoliday ? (builtInHolidays[`${currentYear}-${m}-${i}`] ? 'holiday-red' : 'weekend') : '';

                        let val = parseInt(r.v);
                        if (isNaN(val)) val = 0;
                        if (act) sum[i] += val;

                        let vShow = '';
                        if (act && r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0')) {
                            vShow = r.v;
                        }

                        row1 += `<td class="col-fix-day gantt-cell-bar ${wkCls} ${act ? 'bar-active' : ''}"></td>`;
                        row2 += `<td class="col-fix-day gantt-num ${wkCls}">${vShow}</td>`;
                    }
                    row1 += '</tr>';
                    row2 += '</tr>';
                    html += row1 + row2;
                });

                let sRow = `<tr class="stats-row"><td class="col-fix-name" style="text-align:center;">每日統計</td>`;
                for (let i = 1; i <= 31; i++) sRow += `<td class="col-fix-day">${sum[i]}</td>`;
                html += sRow + '</tr>';
                tbody.innerHTML = html;
                newContainer.appendChild(tbody);
            }
        }

        // 下載修復：強制渲染
        function downloadPDF(selectedMonths) {
            const element = document.getElementById('ganttExportArea');
            const container = document.querySelector('.table-container');
            if(!element || !container) return;

            const originalOverflow = container.style.overflow;
            const originalWidth = container.style.width;

            // 強制切換到甘特圖頁面以確保渲染
            const originalTab = currentTab;
            if(originalTab !== 4) {
                switchTab(4); 
            }

            if (selectedMonths) {
                for (let m = 1; m <= 12; m++) {
                    const tb = document.getElementById(`month-${m}`);
                    if (tb) {
                        if (selectedMonths.includes(m)) tb.style.display = 'table-header-group';
                        else tb.style.display = 'none';
                    }
                }
            }

            container.style.overflow = 'visible';
            container.style.width = '1232px';

            const opt = {
                margin: 5,
                filename: '甘特圖報表.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, scrollY: 0, useCORS: true, width: 1232 },
                jsPDF: { unit: 'pt', format: 'a3', orientation: 'landscape' }
            };

            showLoading(true, "正在產生 PDF...");

            // 給一點時間讓瀏覽器渲染
            setTimeout(() => {
                html2pdf().set(opt).from(element).save()
                .then(() => {
                    container.style.overflow = originalOverflow;
                    container.style.width = originalWidth;
                    for (let m = 1; m <= 12; m++) { let tb = document.getElementById(`month-${m}`); if (tb) tb.style.display = 'table-header-group'; }
                    showLoading(false);
                    // 下載完切回原本的分頁
                    if(originalTab !== 4) switchTab(originalTab);
                })
                .catch(err => {
                    console.error(err);
                    alert("PDF 產生失敗");
                    container.style.overflow = originalOverflow;
                    container.style.width = originalWidth;
                    for (let m = 1; m <= 12; m++) { let tb = document.getElementById(`month-${m}`); if (tb) tb.style.display = 'table-header-group'; }
                    showLoading(false);
                });
            }, 500);
        }

        // Excel 下載 (修復版)
        async function exportExcelJS(selM) {
            const wb = new ExcelJS.Workbook(); const sh = wb.addWorksheet('甘特圖');
            sh.getColumn(1).width = 50; for (let k = 2; k <= 32; k++) sh.getColumn(k).width = 4;
            sh.addRow([`${currentYear}年 班期 / 活動名稱`, ...Array.from({ length: 31 }, (_, k) => k + 1)]).eachCell(c => { c.font = { bold: true }; c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf8fafc' } }; c.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } }; c.alignment = { horizontal: 'center' } });
            
            let rows = []; 
            const parse = (r) => parseDateStr(r.date, r.ex);
            
            const add = (r, val, pre) => { 
                let ds = parse(r);
                ds = ds.filter(d => d.y === currentYear); // 關鍵過濾
                let ms = [...new Set(ds.map(o => o.m))].sort((a, b) => a - b); 
                ms.forEach(m => { rows.push({ m: m, n: `${r.date} ${r.name} ${val > 0 ? `(${pre}${val}人)` : ''}`, ds: ds.filter(o => o.m == m).map(o => o.d), v: val }); }); 
            };
            
            d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用') }); 
            d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, '教官') }); 
            d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用') });
            
            let grp = {}; for (let i = 1; i <= 12; i++) grp[i] = []; rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r) });

            selM.forEach(m => {
                if (grp[m].length === 0) return;
                let mt = sh.addRow([`${m} 月份`]); mt.font = { bold: true, size: 12 }; mt.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFe2e8f0' } };
                let sum = Array(32).fill(0);
                grp[m].forEach(r => {
                    let dVis = [r.n], dDat = [""];
                    for (let i = 1; i <= 31; i++) {
                        if (r.ds.includes(i)) {
                            dVis.push("");
                            let vShow = "";
                            if (r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0' || r.v === 0)) { vShow = parseInt(r.v); }
                            dDat.push(vShow);
                            sum[i] += parseInt(r.v) || 0;
                        } else { dVis.push(""); dDat.push(""); }
                    }
                    let rVis = sh.addRow(dVis); let rDat = sh.addRow(dDat);
                    rVis.eachCell((c, col) => { c.border = { right: { style: 'thin' } }; if (col === 1) c.alignment = { horizontal: 'left', vertical: 'middle', wrapText: true }; if (col > 1 && r.ds.includes(col - 1)) c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF3b82f6' } }; });
                    rDat.eachCell((c, col) => { c.border = { bottom: { style: 'thick' }, right: { style: 'thin' }, left: { style: 'thin' } }; c.alignment = { horizontal: 'center' }; if (col === 1) c.alignment = { horizontal: 'left', wrapText: true }; if (col > 1 && r.ds.includes(col - 1)) c.font = { bold: true }; });
                    sh.mergeCells(rVis.number, 1, rDat.number, 1);
                });
                let sd = ["每日統計"]; for (let i = 1; i <= 31; i++) sd.push(sum[i]);
                let sr = sh.addRow(sd);
                sr.eachCell((c) => { c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf1f5f9' } }; c.font = { bold: true, color: { argb: 'FF1e40af' } }; c.border = { top: { style: 'double' }, bottom: { style: 'thick' }, left: { style: 'thin' }, right: { style: 'thin' } }; c.alignment = { horizontal: 'center' }; });
                sh.addRow([]);
            });
            const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), "甘特圖報表.xlsx");
        }

        // Window Onload (Start)
        window.onload = function () { 
            const yearSelect = document.getElementById('yearSelect');
            if(yearSelect) yearSelect.value = currentYear;
            updateToolbar();
            
            // 初始化空資料列
            if (d1.length === 0) addRow(1);
            if (d2.length === 0) addRow(2);
            if (d3.length === 0) addRow(3);
            
            renderAll();
            loadData(); 
        };
    </script>
</body>
</html>
