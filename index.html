<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>訓練流路管理系統 (完整單一檔版)</title>

    <!-- 核心工具庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 視覺框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        // ==========================================
        // ⚠️ 1. 系統連結 (Google Apps Script URL)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwDk9vkK3Idu7ax_mpfx4hcW36Bn_IIoen72gqXmNRPlXn6PDzQJMgONXAqCX46uJd9OA/exec";

        // ⚠️ 2. 系統整合連結
        const PORTAL_URL = "https://tfd-train.github.io/Training-Management-Platform/";
        const OTHER_SYSTEM_URL = "https://tfd-train.github.io/Facility-Booking/";
        // ==========================================
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .table-container { overflow-x: auto; background: #fff; border-radius: 8px; border: 1px solid #e2e8f0; }
        
        /* 表格樣式優化 */
        table { border-collapse: collapse; font-size: 13px; table-layout: fixed; width: auto; border-spacing: 0; }
        #table1 { min-width: 2000px; }
        #table2 { min-width: 1800px; }
        td, th { border: 1px solid #cbd5e1; height: auto; min-height: 38px; padding: 0; vertical-align: middle; }
        th { background: #f8fafc; color: #475569; font-weight: 600; padding: 8px 4px; text-align: center; }
        
        /* 輸入框樣式 */
        input[type="text"], input[type="number"] { width: 100%; height: 38px; border: none; outline: none; background: transparent; text-align: center; font-family: inherit; font-size: 13px; display: block; color: #334155; }
        input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        textarea { width: 100%; min-height: 38px; height: 100%; border: none; resize: none; outline: none; background: transparent; font-family: inherit; font-size: 13px; text-align: left; padding: 8px; box-sizing: border-box; line-height: 1.4; }
        textarea:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }

        /* 甘特圖專用 CSS */
        #table4 { width: 1232px !important; min-width: 1232px !important; max-width: 1232px !important; table-layout: fixed !important; border-collapse: collapse; margin: 0; }
        .col-fix-name { width: 300px !important; min-width: 300px !important; max-width: 300px !important; white-space: normal; word-break: break-all; line-height: 1.3; padding: 5px; border: 1px solid #000 !important; vertical-align: middle !important; background: #fff; box-sizing: border-box; }
        .col-fix-day { width: 30px !important; min-width: 30px !important; max-width: 30px !important; text-align: center; padding: 0 !important; border: 1px solid #000 !important; box-sizing: border-box; }
        .gantt-visual-row, .gantt-data-row { height: 28px; line-height: 28px; }
        .gantt-cell-bar { border-bottom: none; height: 28px; }
        .gantt-num { border-top: none; font-weight: bold; color: #000; font-size: 10px; height: 28px; line-height: 28px; text-align: center; }
        .weekend { background-color: #f3f4f6; }
        .holiday-red { background-color: #fee2e2; }
        .bar-active { background-color: #3b82f6 !important; border-color: #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        tbody.gantt-month-group { break-inside: avoid; page-break-inside: avoid; border-bottom: 2px solid #000; }
        .gantt-month-header td { background: #e2e8f0; font-weight: bold; padding-left: 15px; border: 1px solid #000; font-size: 14px; height: 32px; }
        .stats-row td { background-color: #f8fafc; border: 1px solid #000; color: #1e40af; font-weight: bold; text-align: center; font-size: 11px; }

        /* 日期選擇器按鈕 */
        .date-cell { display: flex; align-items: center; height: 100%; width: 100%; position: relative; }
        .date-cell input { flex: 1; min-width: 0; }
        .btn-calendar { width: 30px; height: 100%; min-height: 38px; border: none; border-left: 1px solid #cbd5e1; cursor: pointer; background: #f8fafc; color: #64748b; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-calendar:hover { background: #e2e8f0; color: #2563eb; }

        /* 特殊欄位底色 */
        .col-yellow { background: #ffffcc !important; }
        .col-blue-light { background: #e0f2fe !important; }
        .col-red-light { background: #fee2e2 !important; }

        /* Modal 樣式 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin: 10px 0; }
        .day-btn { 
            padding: 8px 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; text-align: center; 
            border-radius: 6px; font-size: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 48px; position: relative;
        }
        .day-btn:hover { border-color: #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .day-btn.excluded { background: #f1f5f9; color: #cbd5e1; text-decoration: line-through; border-color: #f1f5f9; }
        .day-btn.holiday { color: #ef4444; background: #fef2f2; border-color: #fee2e2; }
        .day-btn.holiday.excluded { background: #fef2f2; color: #fca5a5; border-color: #fee2e2; }
        .dot-indicator { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; margin-top: 2px; }
        
        /* 讀取遮罩 */
        #loading { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; font-size: 16px; backdrop-filter: blur(4px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar { height: 0px; background: transparent; }

        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            body { background: white; height: auto; overflow: visible; display: block !important; }
            #sidebar, .top-bar, .btn-add-row, .del-btn, .btn-calendar, #loading, #csvInput, #toolbar-container, .mobile-header, #yearSelectorContainer { display: none !important; }
            .main-content, .workspace, .view-section, .table-container { width: 100%; height: auto; overflow: visible; display: block; padding: 0; margin: 0; border: none; box-shadow: none; }
            .view-section { display: none; }
            .view-section.active { display: block; }
            #table4 { width: 1232px !important; min-width: 1232px !important; table-layout: fixed !important; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "uuid": "https://aistudiocdn.com/uuid@^13.0.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "papaparse": "https://aistudiocdn.com/papaparse@^5.5.3"
  }
}
</script>
</head>

<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-blue-500 selection:text-white">

    <div id="loading">
        <div class="spinner"></div>
        <div id="loadText">處理中...</div>
    </div>

    <!-- Modal: 日期排除 -->
    <div id="dateModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[95%] max-w-[500px] rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                 <div>
                    <h3 class="font-bold text-lg text-slate-800">排除日期設定</h3>
                    <p class="text-xs text-blue-600 font-mono mt-1" id="modalYearDisplay"></p>
                 </div>
                 <button onclick="closeModal('dateModal')" class="p-2 hover:bg-slate-200 rounded-full transition text-slate-500"><i class="ri-close-line text-xl"></i></button>
            </div>
    
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <div class="mb-4 text-sm text-slate-500 bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <p>點選下方按鈕來 <span class="text-slate-400 line-through font-bold">排除</span> 或 <span class="text-green-600 font-bold">保留</span> 該日期。</p>
                    <p class="mt-1 text-xs text-slate-400">* 按下確定後，日期將自動鎖定於該年度 (例如 114/1/5)。</p>
                </div>
    
                <div class="flex flex-wrap gap-2 mb-6">
                    <button class="px-3 py-1.5 text-xs font-bold border border-slate-300 rounded hover:bg-slate-100 text-slate-700" onclick="applyDateFilter('all')">全選(排除)</button>
                    <button class="px-3 py-1.5 text-xs font-bold border border-slate-300 rounded hover:bg-slate-100 text-slate-700" onclick="applyDateFilter('no-weekend')">排除六日/假</button>
                    <button class="px-3 py-1.5 text-xs font-bold border border-slate-300 rounded hover:bg-slate-100 text-slate-700" onclick="applyDateFilter('only-weekend')">僅選六日/假</button>
                    <button class="px-3 py-1.5 text-xs font-bold border border-red-200 rounded hover:bg-red-50 text-red-500" onclick="applyDateFilter('clear')">清除設定</button>
                </div>

                <div id="calendarGridWrapper"></div>
            </div>
    
            <div class="p-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-2xl">
                <button class="px-6 py-2.5 text-slate-500 hover:bg-slate-200 rounded-xl font-bold text-sm transition" onclick="closeModal('dateModal')">取消</button>
                <button class="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm shadow-lg flex items-center gap-2 transition" onclick="saveDateModal()">
                    <i class="ri-check-line text-lg"></i> 確定儲存
                </button>
            </div>
        </div>
    </div>

    <!-- 側邊欄 -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-30 transition-all duration-300">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i class="ri-flow-chart text-white"></i></div>
            <div><h1 class="font-bold text-lg tracking-wide">訓練流路</h1><p class="text-xs text-slate-400">訓練中心內部系統</p></div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div onclick="switchTab(1, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl bg-blue-600/20 text-blue-300 border border-blue-500/30 flex items-center gap-3 hover:bg-blue-600 hover:text-white transition"><i class="ri-user-fire-line text-xl"></i> 消防人員</div>
            <div onclick="switchTab(2, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-group-line text-xl"></i> 非消防人員</div>
            <div onclick="switchTab(3, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-flag-line text-xl"></i> 重大活動</div>
            <div onclick="switchTab(4, this)" class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-bar-chart-horizontal-line text-xl"></i> 甘特圖</div>
        </nav>
        <div class="p-4 border-t border-slate-800 space-y-2 bg-slate-900">
            <div class="text-[10px] text-slate-500 font-bold px-4 mb-1 uppercase tracking-wider">系統切換</div>
            <a href="javascript:void(0)" onclick="location.href=OTHER_SYSTEM_URL" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm"><i class="ri-building-2-fill text-lg text-indigo-400"></i> 場地借用系統</a>
            <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-500 hover:text-white transition text-xs"><i class="ri-arrow-left-line"></i> 回整合首頁</a>
        </div>
    </aside>

    <!-- 主內容 -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
        <div class="mobile-header bg-white md:hidden h-14 flex items-center justify-between px-4 shadow-sm border-b border-slate-200 z-20">
            <div class="flex items-center gap-3"><button onclick="toggleMobileSidebar()" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button><div class="font-bold text-slate-800" id="mobilePageTitle">消防人員</div></div>
            <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="text-slate-400 hover:text-blue-600"><i class="ri-home-4-line text-xl"></i></a>
        </div>

        <div id="toolbar-container" class="bg-white px-6 py-3 border-b border-slate-200 flex flex-wrap items-center justify-between gap-3 shadow-sm z-10">
            <div class="text-lg font-bold text-slate-800 hidden md:flex items-center gap-2" id="pageTitle"><span class="w-2 h-6 bg-blue-600 rounded-full"></span> 附件1 - 消防人員</div>
            
            <div class="flex items-center gap-2">
                <span class="text-sm font-bold text-slate-600">年度:</span>
                <select id="yearSelect" onchange="changeYear(this.value)" class="bg-white border border-slate-300 text-slate-800 text-sm rounded-lg block p-1.5 font-bold outline-none focus:ring-2 focus:ring-blue-200">
                    <option value="2025" selected>114年 (2025)</option>
                    <option value="2026">115年 (2026)</option>
                    <option value="2027">116年 (2027)</option>
                    <option value="2028">117年 (2028)</option>
                </select>
            </div>
            
            <div class="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0 no-scrollbar" id="toolbar"></div>
        </div>

        <div class="flex-1 overflow-hidden p-4 relative">
            <div id="view1" class="view-section h-full flex flex-col">
                <div class="table-container flex-1 mb-4 custom-scrollbar">
                    <table id="table1">
                        <thead><tr><th style="width:50px">刪除</th><th style="width:40px">項次</th><th style="width:40px">月份</th><th style="width:100px">承辦單位</th><th style="width:200px">課程名稱</th><th style="width:80px">訓練對象</th><th style="width:140px">課程日期</th><th style="width:120px">上課地點</th><th style="width:40px">梯數</th><th style="width:50px">每梯<br>人數</th><th style="width:50px">合計<br>人數</th><th style="width:50px">每天<br>時數</th><th style="width:50px">每梯<br>時數</th><th style="width:50px">合計<br>時數</th><th style="width:100px" class="col-blue-light">預計調用人數<br>(分隊人力)</th><th style="width:120px" class="col-yellow">是否提供宜基<br>北桃參訓</th><th style="width:60px" class="col-yellow">暫訂<br>新北</th><th style="width:60px" class="col-yellow">暫訂<br>基隆</th><th style="width:60px" class="col-yellow">暫訂<br>桃園</th><th style="width:60px" class="col-yellow">暫訂<br>宜蘭</th><th style="width:150px">備註</th></tr></thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0" onclick="addRow(1)"><i class="ri-add-line text-lg"></i> 新增資料列</button>
            </div>

            <div id="view2" class="view-section hidden h-full flex flex-col">
                <div class="table-container flex-1 mb-4 custom-scrollbar">
                    <table id="table2">
                        <thead><tr><th style="width:50px">刪除</th><th style="width:40px">序號</th><th style="width:40px">月份</th><th style="width:100px">承辦單位</th><th style="width:200px">課程名稱</th><th style="width:120px">訓練對象</th><th style="width:140px">課程日期</th><th style="width:120px">訓練地點</th><th style="width:40px">梯數</th><th style="width:50px">每梯<br>人數</th><th style="width:50px">合計<br>人數</th><th style="width:50px">每天<br>時數</th><th style="width:50px">每梯<br>時數</th><th style="width:50px">合計<br>時數</th><th style="width:80px">調用本局<br>教官人數</th><th style="width:100px">是否提供<br>跨縣市</th><th style="width:150px">備註</th></tr></thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0" onclick="addRow(2)"><i class="ri-add-line text-lg"></i> 新增資料列</button>
            </div>

            <div id="view3" class="view-section hidden h-full flex flex-col">
                <div class="table-container flex-1 mb-4 custom-scrollbar">
                    <table id="table3">
                        <thead><tr><th style="width:50px">刪除</th><th style="width:40px">序號</th><th style="width:100px">承辦單位</th><th style="width:250px">重大活動演習名稱</th><th style="width:150px">參加對象</th><th style="width:140px">日期</th><th style="width:50px">天數</th><th style="width:50px">時數</th><th style="width:100px" class="col-red-light">每日調用<br>外勤人數</th><th style="width:150px">地點(教室)</th></tr></thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0" onclick="addRow(3)"><i class="ri-add-line text-lg"></i> 新增資料列</button>
            </div>

            <div id="view4" class="view-section hidden h-full flex flex-col">
                <div class="bg-amber-50 text-amber-800 px-4 py-3 rounded-xl border border-amber-200 text-sm mb-4 flex items-center gap-2 shadow-sm">
                    <i class="ri-calendar-event-line text-lg text-amber-500"></i>
                    <span><strong>說明：</strong> 紅色底色代表國定假日或週末。資料來源：行政院行事曆(透過 Google 日曆)。</span>
                </div>
                <div class="table-container flex-1 p-4 bg-white custom-scrollbar">
                    <div id="ganttExportArea">
                        <table id="table4">
                            <tbody id="ganttContainer"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">

    <script>
        const $ = (s) => document.querySelector(s);
        let d1 = [{ m: '1', unit: '', name: '', date: '', mp: 0, ex: [], isNew: true }];
        let d2 = [{ m: '1', unit: '', name: '', date: '', inst: 0, ex: [], isNew: true }];
        let d3 = [{ unit: '', name: '', date: '', mp: 0, ex: [], isNew: true }];
        let currentTab = 1; 
        let currentYear = 2025; 
        let holidays = {};
        
        let currentEdit = { tab: null, index: null };
        let tempExcluded = new Set();

        // =========================================
        // 核心渲染函式
        // =========================================
        function renderT1() {
            const tb = document.getElementById('tbody1'); 
            if(!tb) return;
            tb.innerHTML = '';
            d1.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(1,${i})"><i class="ri-close-circle-fill text-xl"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_1_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d1[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d1[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d1[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(1,${i},this.value)" placeholder="1/6-19"><button class="btn-calendar" onclick="openDateModal(1,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="text" value="${r.loc || ''}" onchange="d1[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d1[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d1[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.pb) || 0}</td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d1[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bHour || ''}" onchange="d1[${i}].bHour=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.bHour) || 0}</td>
                <td class="col-blue-light"><input type="number" value="${r.mp || ''}" onchange="d1[${i}].mp=this.value"></td>
                <td style="text-align:center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d1[${i}].ext=this.checked"></td>
                <td><input type="number" value="${r.nt || ''}" onchange="d1[${i}].nt=this.value"></td>
                <td><input type="number" value="${r.kl || ''}" onchange="d1[${i}].kl=this.value"></td>
                <td><input type="number" value="${r.ty || ''}" onchange="d1[${i}].ty=this.value"></td>
                <td><input type="number" value="${r.yl || ''}" onchange="d1[${i}].yl=this.value"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        function renderT2() {
            const tb = document.getElementById('tbody2'); 
            if(!tb) return;
            tb.innerHTML = '';
            d2.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(2,${i})"><i class="ri-close-circle-fill text-xl"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_2_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d2[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d2[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d2[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(2,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(2,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="text" value="${r.loc || ''}" onchange="d2[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d2[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d2[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.pb) || 0}</td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d2[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bHour || ''}" onchange="d2[${i}].bHour=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">${(r.batch * r.bHour) || 0}</td>
                <td><input type="number" value="${r.inst || ''}" onchange="d2[${i}].inst=this.value"></td>
                <td style="text-align:center"><input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d2[${i}].ext=this.checked"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        function renderT3() {
            const tb = document.getElementById('tbody3'); 
            if(!tb) return;
            tb.innerHTML = '';
            d3.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center"><button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(3,${i})"><i class="ri-close-circle-fill text-xl"></i></button></td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d3[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d3[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d3[${i}].target=this.value"></td>
                <td><div class="date-cell"><input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(3,${i},this.value)"><button class="btn-calendar" onclick="openDateModal(3,${i})"><i class="ri-calendar-line"></i></button></div></td>
                <td><input type="number" value="${r.days || ''}" onchange="d3[${i}].days=this.value"></td>
                <td><input type="number" value="${r.hours || ''}" onchange="d3[${i}].hours=this.value"></td>
                <td class="col-red-light"><input type="number" value="${r.mp || ''}" onchange="d3[${i}].mp=this.value"></td>
                <td class="align-left"><input type="text" value="${r.loc || ''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        function renderAll() { renderT1(); renderT2(); renderT3(); }

        // =========================================
        // 主邏輯 & 初始化
        // =========================================

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden'); sidebar.classList.toggle('absolute'); sidebar.classList.toggle('h-full');
        }

        window.onload = function () { 
            updateToolbar(); 
            loadData(); 
            fetchHolidays(currentYear);
        };

        function changeYear(val) {
            currentYear = parseInt(val);
            showLoading(true, `正在載入 ${currentYear} 年資料...`);
            fetchHolidays(currentYear).then(() => {
                if(currentTab === 4) renderGantt(); 
                showLoading(false);
            });
        }

        async function fetchHolidays(year) {
            try {
                const res = await fetch(`${GAS_API_URL}?type=holidays&year=${year}`);
                const json = await res.json();
                if(json.status === 'success') holidays = json.holidays; 
            } catch(e) { console.error("無法取得假日", e); }
        }

        function isDayOff(year, month, day) {
            const dateStr = `${year}-${month}-${day}`;
            const w = new Date(year, month - 1, day).getDay();
            if (holidays[dateStr]) return true;
            if (w === 0 || w === 6) return true;
            return false;
        }

        function loadData() {
            showLoading(true, "正在同步雲端資料...");
            fetch(GAS_API_URL).then(r => r.json()).then(res => {
                if (res.status === 'success') {
                    d1 = (res.d1 || []).map(r => ({ m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], batch: r[6], pb: r[7], mp: r[12], ext: r[13] === 'true', nt: r[14], kl: r[15], ty: r[16], yl: r[17], note: r[18], ex: JSON.parse(r[19] || '[]'), isNew: false, dHour: r[9], bHour: r[10] }));
                    d2 = (res.d2 || []).map(r => ({ m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5], batch: r[6], pb: r[7], inst: r[12], ext: r[13] === 'true', note: r[14], ex: JSON.parse(r[15] || '[]'), isNew: false, dHour: r[9], bHour: r[10] }));
                    d3 = (res.d3 || []).map(r => ({ unit: r[0], name: r[1], target: r[2], date: r[3], days: r[4], hours: r[5], mp: r[6], loc: r[7], ex: JSON.parse(r[8] || '[]'), isNew: false }));
                    if (d1.length == 0) addRow(1); if (d2.length == 0) addRow(2); if (d3.length == 0) addRow(3);
                    renderAll();
                }
            }).catch(e => {
                console.error(e);
                alert("連線錯誤，使用本地快取/空白資料");
                renderAll();
            }).finally(() => showLoading(false));
        }

        function saveData() {
            showLoading(true, "正在儲存至雲端...");
            const p1 = d1.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch * r.pb) || 0, r.dHour, r.bHour, (r.batch * r.bHour) || 0, r.mp, r.ext, r.nt, r.kl, r.ty, r.yl, r.note, JSON.stringify(r.ex)]);
            const p2 = d2.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (r.batch * r.pb) || 0, r.dHour, r.bHour, (r.batch * r.bHour) || 0, r.inst, r.ext, r.note, JSON.stringify(r.ex)]);
            const p3 = d3.map(r => [r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.ex)]);
            fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ d1: p1, d2: p2, d3: p3 }), headers: { 'Content-Type': 'text/plain' } })
                .then(r => r.json()).then(res => { if (res.status === 'success') { alert(res.message);[d1, d2, d3].forEach(arr => arr.forEach(r => r.isNew = false)); renderAll(); } else alert("錯誤: " + res.message); })
                .finally(() => showLoading(false));
        }

        function switchTab(idx, el) {
            document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('bg-blue-600/20', 'text-blue-300', 'border-blue-500/30'); e.classList.add('text-slate-400'); });
            el.classList.remove('text-slate-400'); el.classList.add('bg-blue-600/20', 'text-blue-300', 'border', 'border-blue-500/30');
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view${idx}`).classList.remove('hidden');
            currentTab = idx;
            const titles = ["附件1 - 消防人員", "附件2 - 非消防人員", "附件3 - 重大活動", "甘特圖"];
            document.getElementById('pageTitle').innerHTML = `<span class="w-2 h-6 bg-blue-600 rounded-full"></span> ${titles[idx - 1]}`;
            document.getElementById('mobilePageTitle').innerText = titles[idx - 1].replace(/附件\d - /, '');
            
            updateToolbar();
            if (idx === 4) renderGantt();
        }

        function updateToolbar() {
            const bar = document.getElementById('toolbar');
            let html = '';
            const btnBase = "px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition whitespace-nowrap cursor-pointer";
            const btnLight = `${btnBase} bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600`;
            const btnDark = `${btnBase} bg-slate-900 text-white hover:bg-slate-800 shadow-lg`;
            const btnGreen = `${btnBase} bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg`;
            const btnRed = `${btnBase} bg-rose-600 text-white hover:bg-rose-700 shadow-lg`;

            if (currentTab <= 3) {
                html += `<button class="${btnLight}" onclick="document.getElementById('csvInput').click()"><i class="ri-upload-2-line"></i> 匯入</button>`;
                html += `<button class="${btnDark}" onclick="saveData()"><i class="ri-save-3-line"></i> 儲存資料</button>`;
            } else {
                html += `<button class="${btnGreen}" onclick="alert('請自行使用瀏覽器列印功能轉存為 PDF 或 Excel')"><i class="ri-file-excel-2-line"></i> 下載 Excel</button>`;
                html += `<button class="${btnRed}" onclick="window.print()"><i class="ri-file-pdf-line"></i> 列印 / PDF</button>`;
            }
            bar.innerHTML = html;
        }

        function showLoading(s, t) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; if (t) document.getElementById('loadText').innerText = t; }
        function updateMonthFromDate(t, i, val) { 
            let match = val.match(/^(\d+)\//); 
            if (match) { 
                let m = match[1]; 
                if (t === 1) d1[i].m = m; 
                if (t === 2) d2[i].m = m; 
                let el = document.getElementById(`m_${t}_${i}`);
                if(el) el.value = m; 
            } 
            if (t === 1) d1[i].date = val; 
            if (t === 2) d2[i].date = val; 
            if (t === 3) d3[i].date = val; 
        }

        function addRow(t) {
            if (t === 1) d1.push({ m: '', unit: '', name: '', target: '', date: '', loc: '', batch: '', pb: '', mp: 0, ext: false, nt: '', kl: '', ty: '', yl: '', note: '', ex: [], isNew: true });
            if (t === 2) d2.push({ m: '', unit: '', name: '', target: '', date: '', loc: '', batch: '', pb: '', inst: 0, ext: false, note: '', ex: [], isNew: true });
            if (t === 3) d3.push({ unit: '', name: '', target: '', date: '', days: '', hours: '', mp: 0, loc: '', ex: [], isNew: true });
            if (t === 1) renderT1(); if (t === 2) renderT2(); if (t === 3) renderT3();
        }

        function delRow(t, i) {
            if(!confirm("確定刪除此列？")) return;
            if (t === 1) d1.splice(i, 1); if (t === 2) d2.splice(i, 1); if (t === 3) d3.splice(i, 1);
            if (t === 1) renderT1(); if (t === 2) renderT2(); if (t === 3) renderT3();
        }

        function processCSV(input) {
            if (!input.files[0]) return;
            Papa.parse(input.files[0], {
                header: true, skipEmptyLines: true,
                complete: function (results) {
                    let data = results.data;
                    let shouldClear = confirm("清除現有資料？(確定=清除, 取消=附加)");
                    if (shouldClear) { if (currentTab === 1) d1 = []; if (currentTab === 2) d2 = []; if (currentTab === 3) d3 = []; }
                    
                    if (currentTab === 1) {
                        data.forEach(r => { d1.push({ m: r['月份']||'', unit: r['承辦單位']||'', name: r['課程名稱']||'', target: r['訓練對象']||'', date: r['課程日期']||'', loc: r['上課地點']||'', batch: r['梯數']||'', pb: r['每梯人數']||'', dHour: r['每天時數']||'', bHour: r['每梯時數']||'', mp: r['預計調用人數']||'', ext: (r['是否提供跨縣市(TRUE/FALSE)']||'').toUpperCase()==='TRUE', nt: r['新北']||'', kl: r['基隆']||'', ty: r['桃園']||'', yl: r['宜蘭']||'', note: r['備註']||'', ex: [], isNew: true }); });
                        renderT1();
                    } else if (currentTab === 2) {
                        data.forEach(r => { d2.push({ m: r['月份']||'', unit: r['承辦單位']||'', name: r['課程名稱']||'', target: r['訓練對象']||'', date: r['課程日期']||'', loc: r['上課地點']||'', batch: r['梯數']||'', pb: r['每梯人數']||'', dHour: r['每天時數']||'', bHour: r['每梯時數']||'', inst: r['調用教官人數']||'', ext: (r['是否提供跨縣市(TRUE/FALSE)']||'').toUpperCase()==='TRUE', note: r['備註']||'', ex: [], isNew: true }); });
                        renderT2();
                    } else if (currentTab === 3) {
                        data.forEach(r => { d3.push({ unit: r['承辦單位']||'', name: r['活動名稱']||'', target: r['參加對象']||'', date: r['日期']||'', days: r['天數']||'', hours: r['時數']||'', mp: r['每日調用人數']||'', loc: r['地點']||'', ex: [], isNew: true }); });
                        renderT3();
                    }
                    input.value = ''; alert("匯入完成");
                }
            });
        }

        // =========================================
        // 日期解析邏輯 (修正版：支援年份過濾)
        // =========================================
        function parseDateStr(str, excludeList) {
            let results = [];
            if (!str) return results;
            
            try {
                // 1. 偵測年份
                let specificYear = null;
                let yearMatch = str.match(/(?:^|[^\d])(11[4-9]|12[0-9]|202[5-9])[年\/\.]/);
                if (yearMatch) {
                    let y = parseInt(yearMatch[1]);
                    specificYear = (y < 1000) ? (y + 1911) : y;
                }

                // 2. 預處理
                let s = str.trim()
                    .replace(/[０-９]/g, d => "０１２３４５６７８９".indexOf(d))
                    .replace(/（.*?）/g, '').replace(/\(.*?\)/g, '')
                    .replace(/11[3-6]年/g, '') 
                    .replace(/202[4-7]年/g, '')
                    .replace(/月/g, '/').replace(/日/g, '')
                    .replace(/～/g, '-').replace(/~/g, '-').replace(/－/g, '-')
                    .replace(/[、，,]/g, ' ')
                    .trim();

                let tokens = s.split(/\s+/);
                let currentMonth = null; 
                let baseYear = specificYear || currentYear; // 若字串無年份，則使用全域 currentYear

                tokens.forEach(token => {
                    if (!token) return;

                    let explicitMonthMatch = token.match(/^(\d+)[\/.]/);
                    if (explicitMonthMatch) currentMonth = parseInt(explicitMonthMatch[1]);
                    if (!currentMonth && !explicitMonthMatch) return;

                    // A: 跨月
                    let crossMatch = token.match(/(\d+)[\/.](\d+)-(\d+)[\/.](\d+)/);
                    if (crossMatch) {
                        let m1 = parseInt(crossMatch[1]), d1 = parseInt(crossMatch[2]);
                        let m2 = parseInt(crossMatch[3]), d2 = parseInt(crossMatch[4]);
                        let cur = new Date(baseYear, m1 - 1, d1);
                        let end = new Date(baseYear, m2 - 1, d2);
                        if (cur <= end) {
                            while (cur <= end) {
                                results.push({ m: cur.getMonth() + 1, d: cur.getDate(), y: cur.getFullYear() });
                                cur.setDate(cur.getDate() + 1);
                            }
                        }
                        currentMonth = m2; return;
                    }

                    // B: 帶月份範圍
                    let rangeWithMonth = token.match(/(\d+)[\/.](\d+)-(\d+)/);
                    if (rangeWithMonth) {
                        let m = parseInt(rangeWithMonth[1]), d1 = parseInt(rangeWithMonth[2]), d2 = parseInt(rangeWithMonth[3]);
                        currentMonth = m;
                        if (d2 >= d1) { for (let i = d1; i <= d2; i++) results.push({ m: m, d: i, y: baseYear }); }
                        return;
                    }

                    // C: 純日期範圍
                    let rangeNoMonth = token.match(/^(\d+)-(\d+)$/);
                    if (rangeNoMonth) {
                        let d1 = parseInt(rangeNoMonth[1]), d2 = parseInt(rangeNoMonth[2]);
                        if (d2 >= d1) { for (let i = d1; i <= d2; i++) results.push({ m: currentMonth, d: i, y: baseYear }); }
                        return;
                    }

                    // D/E: 單日
                    let singleWithMonth = token.match(/(\d+)[\/.](\d+)/);
                    if (singleWithMonth) {
                        let m = parseInt(singleWithMonth[1]), d = parseInt(singleWithMonth[2]);
                        currentMonth = m; results.push({ m: m, d: d, y: baseYear }); return;
                    }
                    let singleNoMonth = token.match(/^(\d+)$/);
                    if (singleNoMonth) {
                        let d = parseInt(singleNoMonth[1]);
                        results.push({ m: currentMonth, d: d, y: baseYear }); return;
                    }
                });

                if (excludeList && excludeList.length > 0) {
                    results = results.filter(o => !excludeList.includes(o.d));
                }
            } catch (e) { console.error("日期解析失敗:", e); }
            return results;
        }

        // =========================================
        // Modal 邏輯 (日期選填)
        // =========================================
        function openDateModal(tab, index) {
            currentEdit = { tab, index };
            let rowData;
            if (tab === 1) rowData = d1[index];
            if (tab === 2) rowData = d2[index];
            if (tab === 3) rowData = d3[index];

            document.getElementById('modalYearDisplay').innerText = `目前年度: ${currentYear} (民國${currentYear-1911}年)`;
            document.getElementById('dateModal').style.display = 'flex';
            tempExcluded = new Set(rowData.ex || []);
            renderModalCalendar(rowData.date);
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            currentEdit = { tab: null, index: null };
        }

        function renderModalCalendar(dateStr) {
            const container = document.getElementById('calendarGridWrapper');
            container.innerHTML = '';

            // 解析日期，並找出該年份有哪些月份需要顯示
            const parsed = parseDateStr(dateStr, [], currentYear); // 先不帶排除清單，顯示所有範圍內的日期
            const valid = parsed.filter(d => d.y === currentYear);

            if (valid.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-400 py-10"><p>無法解析有效日期</p><p class="text-xs">請先輸入格式如 "1/5-1/9" 的日期</p></div>`;
                return;
            }

            // 按月份分組
            let grouped = {};
            valid.forEach(o => {
                if(!grouped[o.m]) grouped[o.m] = [];
                grouped[o.m].push(o);
            });

            // 渲染
            Object.keys(grouped).sort((a,b)=>a-b).forEach(m => {
                let html = `<div>
                    <h4 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2">
                        <span class="w-1 h-4 bg-blue-500 rounded-full"></span> ${m} 月
                    </h4>
                    <div class="grid grid-cols-7 gap-2">`;
                
                grouped[m].forEach(o => {
                    const isEx = tempExcluded.has(o.d);
                    const isOff = isDayOff(currentYear, m, o.d);
                    const btnClass = isEx 
                        ? 'bg-slate-50 text-slate-300 border-slate-100 decoration-slate-400 line-through opacity-70' 
                        : (isOff ? 'bg-red-50 text-red-600 border-red-100' : 'bg-white text-slate-700 border-slate-200 shadow-sm hover:border-blue-400');
                    
                    html += `<button onclick="toggleModalDate(${o.d})" 
                        class="day-btn relative p-2 border rounded-lg transition-all ${btnClass}">
                        <span class="text-xs absolute top-1 left-1 opacity-50">${isOff ? '休' : ''}</span>
                        <span class="text-lg font-medium">${o.d}</span>
                        ${!isEx ? '<div class="dot-indicator"></div>' : ''}
                    </button>`;
                });
                html += `</div></div><hr class="my-4 border-slate-100">`;
                container.innerHTML += html;
            });
        }

        function toggleModalDate(day) {
            if (tempExcluded.has(day)) tempExcluded.delete(day);
            else tempExcluded.add(day);
            // 重新渲染以更新狀態
            let rowData = (currentEdit.tab===1 ? d1 : (currentEdit.tab===2 ? d2 : d3))[currentEdit.index];
            renderModalCalendar(rowData.date);
        }

        function applyDateFilter(type) {
            let rowData = (currentEdit.tab===1 ? d1 : (currentEdit.tab===2 ? d2 : d3))[currentEdit.index];
            const parsed = parseDateStr(rowData.date, [], currentYear);
            const valid = parsed.filter(d => d.y === currentYear);

            if (type === 'clear') tempExcluded.clear();
            else {
                valid.forEach(d => {
                    const dt = new Date(d.y, d.m - 1, d.d);
                    const w = dt.getDay();
                    const isOff = isDayOff(d.y, d.m, d.d);
                    
                    if (type === 'all') tempExcluded.add(d.d);
                    if (type === 'no-weekend' && (w===0 || w===6 || isOff)) tempExcluded.add(d.d);
                    if (type === 'only-weekend' && (w!==0 && w!==6 && !isOff)) tempExcluded.add(d.d);
                });
            }
            renderModalCalendar(rowData.date);
        }

        function saveDateModal() {
            const { tab, index } = currentEdit;
            if (tab === null) return;
            
            let arr = (tab === 1) ? d1 : (tab === 2 ? d2 : d3);
            
            // 1. 儲存排除列表
            arr[index].ex = Array.from(tempExcluded);
            
            // 2. [關鍵修復] 鎖定年份
            // 如果目前的日期字串沒有年份 (e.g., "1/5")，強制加上年份前綴 (e.g., "114/1/5")
            // 這樣切換到 2026 年時，解析器就會看到 114 年，進而濾掉
            let currentDate = arr[index].date;
            if (currentDate && !currentDate.match(/(11[0-9]|202[0-9])[\/.]/)) {
                let rocYear = currentYear - 1911;
                arr[index].date = `${rocYear}/${currentDate}`;
            }

            if (tab === 1) renderT1();
            if (tab === 2) renderT2();
            if (tab === 3) renderT3();
            closeModal('dateModal');
        }

        // =========================================
        // 甘特圖邏輯
        // =========================================
        function renderGantt() {
            const table = document.getElementById('table4');
            const container = document.getElementById('ganttContainer');
            
            let headerHTML = `<tr id="ganttHeader"><th class="col-fix-name">${currentYear}年 班期 / 活動名稱</th>`;
            for (let i = 1; i <= 31; i++) headerHTML += `<th class="col-fix-day">${i}</th>`;
            headerHTML += '</tr>';

            table.innerHTML = `
                <colgroup>
                    <col style="width: 300px; min-width: 300px;">
                    ${Array(31).fill('<col style="width: 30px; min-width: 30px;">').join('')}
                </colgroup>
                <thead>${headerHTML}</thead>
                <tbody id="ganttContainer"></tbody>
            `;

            const newContainer = document.getElementById('ganttContainer');
            let rows = [];
            
            // 使用共用的 parseDateStr
            const parse = (r) => parseDateStr(r.date, r.ex);

            const add = (r, val, prefix) => {
                let daysSet = parse(r);
                
                // [關鍵] 嚴格過濾非當年度的資料
                // 如果 daysSet 裡的 y (年份) 不等於 currentYear，就把它濾掉
                // 例如: 使用者輸入 "114/1/5"，而 currentYear 是 2026 (115)，這裡就會回傳空陣列
                daysSet = daysSet.filter(d => d.y === currentYear);

                if (daysSet.length === 0) return;

                let involvedMonths = [...new Set(daysSet.map(o => o.m))].sort((a, b) => a - b);
                involvedMonths.forEach(m => {
                    let daysInThisMonth = daysSet.filter(o => o.m === m).map(o => o.d);
                    let label = `${r.date} ${r.name} ${val > 0 ? `(${prefix} ${val}人)` : ''}`;
                    rows.push({ m: m, n: label, ds: daysInThisMonth, v: val });
                });
            };

            d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用'); });
            d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, '教官'); });
            d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, '調用'); });

            let grp = {}; for (let i = 1; i <= 12; i++) grp[i] = []; rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r) });

            for (let m = 1; m <= 12; m++) {
                if (grp[m].length === 0) continue;
                
                let tbody = document.createElement('tbody');
                tbody.className = 'gantt-month-group';
                let html = `<tr class="gantt-month-header"><td colspan="32">${m} 月份</td></tr>`;
                let sum = Array(32).fill(0);

                grp[m].forEach(r => {
                    let row1 = `<tr class="gantt-visual-row"><td class="col-fix-name" rowspan="2">${r.n}</td>`;
                    let row2 = `<tr class="gantt-data-row">`;

                    for (let i = 1; i <= 31; i++) {
                        let act = r.ds.includes(i);
                        let isHoliday = isDayOff(currentYear, m, i);
                        let wkCls = isHoliday ? (holidays[`${currentYear}-${m}-${i}`] ? 'holiday-red' : 'weekend') : '';

                        let val = parseInt(r.v);
                        if (isNaN(val)) val = 0;
                        if (act) sum[i] += val;

                        let vShow = '';
                        if (act && r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0')) vShow = r.v;

                        row1 += `<td class="col-fix-day gantt-cell-bar ${wkCls} ${act ? 'bar-active' : ''}"></td>`;
                        row2 += `<td class="col-fix-day gantt-num ${wkCls}">${vShow}</td>`;
                    }
                    row1 += '</tr>'; row2 += '</tr>';
                    html += row1 + row2;
                });

                let sRow = `<tr class="stats-row"><td class="col-fix-name" style="text-align:center;">每日統計</td>`;
                for (let i = 1; i <= 31; i++) sRow += `<td class="col-fix-day">${sum[i] > 0 ? sum[i] : ''}</td>`;
                html += sRow + '</tr>';
                tbody.innerHTML = html;
                newContainer.appendChild(tbody);
            }
        }
    </script>
</body>
</html>
