<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>訓練流路管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Hide scrollbar for clean UI where needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <!-- Import Map for React and Libraries -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "uuid": "https://esm.sh/uuid@9.0.1",
    "papaparse": "https://esm.sh/papaparse@5.4.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-blue-500 selection:text-white">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { v4 as uuidv4 } from 'uuid';
        import { 
            UserCheck, Users, Flag, BarChart2, Building2, ArrowLeft, Network, 
            Plus, Trash2, Calendar, Save, Upload, FileSpreadsheet, FileText, 
            Menu, Loader2, X, Check, CalendarDays, MousePointerClick, ChevronLeft, ChevronRight 
        } from 'lucide-react';
        import Papa from 'papaparse';

        // --- Constants & Config ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwDk9vkK3Idu7ax_mpfx4hcW36Bn_IIoen72gqXmNRPlXn6PDzQJMgONXAqCX46uJd9OA/exec";

        // --- Utils: Date Parser ---
        /**
         * 解析日期字串，處理 "115/05/20" 或 "1/5-10" 等格式
         * 修正：優先移除年份前綴，避免月份誤判
         */
        const parseDateStr = (str, excludeList, currentYear) => {
            let results = [];
            if (!str) return results;

            try {
                // 1. Detect Year (if explicit in string)
                let specificYear = null;
                const yearMatch = str.match(/(?:^|[^\d])(11[4-9]|12[0-9]|202[5-9])[年\/\.]/);
                if (yearMatch) {
                    const y = parseInt(yearMatch[1]);
                    specificYear = (y < 1000) ? (y + 1911) : y;
                }

                // 2. Preprocess
                // 先將全形轉半形，移除括號等
                let s = str.trim()
                    .replace(/[０-９]/g, d => "０１２３４５６７８９".indexOf(d).toString())
                    .replace(/（.*?）/g, '').replace(/\(.*?\)/g, '')
                    .replace(/[、，,]/g, ' ')
                    .replace(/～/g, '-').replace(/~/g, '-').replace(/－/g, '-')
                    .replace(/月/g, '/')
                    .replace(/日/g, '');

                // *** 關鍵修正：移除年份前綴 (如 115/ 或 2026/) 以避免干擾月份解析 ***
                // Regex 說明：匹配行首或分隔符後的 "1xx/" 或 "20xx/" 並移除
                s = s.replace(/(^|[\s])(?:1\d{2}|20\d{2})[\/.-]/g, ' '); 

                const tokens = s.split(/\s+/);
                let currentMonth = null;
                const baseYear = specificYear || currentYear;

                tokens.forEach(token => {
                    if (!token) return;

                    // 嘗試抓取月份 (e.g., "5/" or "05.")
                    const explicitMonthMatch = token.match(/^(\d+)[\/.]/);
                    if (explicitMonthMatch) {
                        currentMonth = parseInt(explicitMonthMatch[1]);
                    }

                    if (!currentMonth && !explicitMonthMatch) return;

                    // A: Cross Month (e.g., 1/30-2/2)
                    const crossMatch = token.match(/(\d+)[\/.](\d+)-(\d+)[\/.](\d+)/);
                    if (crossMatch) {
                        const m1 = parseInt(crossMatch[1]), d1 = parseInt(crossMatch[2]);
                        const m2 = parseInt(crossMatch[3]), d2 = parseInt(crossMatch[4]);
                        
                        const cur = new Date(baseYear, m1 - 1, d1);
                        const end = new Date(baseYear, m2 - 1, d2);
                        
                        if (cur <= end) {
                            let loopCount = 0;
                            while (cur <= end && loopCount < 366) {
                                results.push({ m: cur.getMonth() + 1, d: cur.getDate(), y: cur.getFullYear() });
                                cur.setDate(cur.getDate() + 1);
                                loopCount++;
                            }
                        }
                        currentMonth = m2;
                        return;
                    }

                    // B: Range with Month (e.g., 1/5-10)
                    const rangeWithMonth = token.match(/(\d+)[\/.](\d+)-(\d+)/);
                    if (rangeWithMonth) {
                        const m = parseInt(rangeWithMonth[1]);
                        const d1 = parseInt(rangeWithMonth[2]);
                        const d2 = parseInt(rangeWithMonth[3]);
                        currentMonth = m;
                        if (d2 >= d1) {
                            for (let i = d1; i <= d2; i++) results.push({ m: m, d: i, y: baseYear });
                        }
                        return;
                    }

                    // C: Range no Month (e.g., 5-10) - uses currentMonth
                    const rangeNoMonth = token.match(/^(\d+)-(\d+)$/);
                    if (rangeNoMonth && currentMonth) {
                        const d1 = parseInt(rangeNoMonth[1]);
                        const d2 = parseInt(rangeNoMonth[2]);
                        if (d2 >= d1) {
                            for (let i = d1; i <= d2; i++) results.push({ m: currentMonth, d: i, y: baseYear });
                        }
                        return;
                    }

                    // D: Single with Month (e.g., 1/5)
                    const singleWithMonth = token.match(/(\d+)[\/.](\d+)/);
                    if (singleWithMonth) {
                        const m = parseInt(singleWithMonth[1]);
                        const d = parseInt(singleWithMonth[2]);
                        currentMonth = m;
                        results.push({ m: m, d: d, y: baseYear });
                        return;
                    }

                    // E: Single no Month (e.g., 5)
                    const singleNoMonth = token.match(/^(\d+)$/);
                    if (singleNoMonth && currentMonth) {
                        const d = parseInt(singleNoMonth[1]);
                        results.push({ m: currentMonth, d: d, y: baseYear });
                        return;
                    }
                });

                if (excludeList && excludeList.length > 0) {
                    results = results.filter(o => !excludeList.includes(o.d));
                }

            } catch (e) {
                console.error("Date parsing failed:", e);
            }
            return results;
        };

        const isDayOff = (year, month, day, holidays) => {
            const dateStr = `${year}-${month}-${day}`;
            const w = new Date(year, month - 1, day).getDay();
            if (holidays[dateStr]) return true;
            if (w === 0 || w === 6) return true;
            return false;
        };

        // --- API Services ---
        const fetchHolidays = async (year) => {
            try {
                const res = await fetch(`${GAS_API_URL}?type=holidays&year=${year}`);
                const json = await res.json();
                return json.status === 'success' ? json.holidays : {};
            } catch (e) {
                console.error("Failed to fetch holidays", e);
                return {};
            }
        };

        const loadData = async () => {
            try {
                const res = await fetch(GAS_API_URL);
                const json = await res.json();
                
                if (json.status === 'success') {
                    const mapRow = (r, type) => {
                        const base = {
                            id: uuidv4(),
                            unit: r[1],
                            name: r[2],
                            target: r[3],
                            date: r[4],
                            loc: r[5],
                            ex: JSON.parse(r[type === 3 ? 8 : (type === 1 ? 19 : 15)] || '[]'),
                            isNew: false
                        };
                        
                        if (type === 1) {
                            return {
                                ...base,
                                m: r[0],
                                batch: r[6],
                                pb: r[7],
                                dHour: r[9],
                                bHour: r[10],
                                mp: r[12],
                                ext: r[13] === 'true',
                                nt: r[14],
                                kl: r[15],
                                ty: r[16],
                                yl: r[17],
                                note: r[18],
                            };
                        } else if (type === 2) {
                            return {
                                ...base,
                                m: r[0],
                                batch: r[6],
                                pb: r[7],
                                dHour: r[9],
                                bHour: r[10],
                                inst: r[12],
                                ext: r[13] === 'true',
                                note: r[14],
                            };
                        } else {
                            return {
                                id: uuidv4(),
                                unit: r[0],
                                name: r[1],
                                target: r[2],
                                date: r[3],
                                days: r[4],
                                hours: r[5],
                                mp: r[6],
                                loc: r[7],
                                ex: JSON.parse(r[8] || '[]'),
                                isNew: false
                            };
                        }
                    };

                    return {
                        d1: (json.d1 || []).map(r => mapRow(r, 1)),
                        d2: (json.d2 || []).map(r => mapRow(r, 2)),
                        d3: (json.d3 || []).map(r => mapRow(r, 3)),
                    };
                }
                return null;
            } catch (e) {
                throw new Error("API Connection Failed: " + e);
            }
        };

        const saveData = async (data) => {
            const p1 = data.d1.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (Number(r.batch) * Number(r.pb)) || 0, r.dHour, r.bHour, (Number(r.batch) * Number(r.bHour)) || 0, r.mp, r.ext, r.nt, r.kl, r.ty, r.yl, r.note, JSON.stringify(r.ex)]);
            const p2 = data.d2.map(r => [r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb, (Number(r.batch) * Number(r.pb)) || 0, r.dHour, r.bHour, (Number(r.batch) * Number(r.bHour)) || 0, r.inst, r.ext, r.note, JSON.stringify(r.ex)]);
            const p3 = data.d3.map(r => [r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.ex)]);
            
            const res = await fetch(GAS_API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ d1: p1, d2: p2, d3: p3 }), 
                headers: { 'Content-Type': 'text/plain' } 
            });
            return await res.json();
        };

        // --- Component: Sidebar ---
        const Sidebar = ({ currentTab, onSwitch, isOpen, onCloseMobile }) => {
            const baseClass = "w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition font-medium text-sm";
            const activeClass = "bg-blue-600/20 text-blue-300 border border-blue-500/30";
            const inactiveClass = "text-slate-400 hover:bg-slate-800 hover:text-white";

            const renderItem = (tab, label, icon) => (
                <button
                    onClick={() => { onSwitch(tab); onCloseMobile(); }}
                    className={`${baseClass} ${currentTab === tab ? activeClass : inactiveClass}`}
                >
                    {icon} {label}
                </button>
            );

            return (
                <aside className={`
                    fixed inset-y-0 left-0 bg-slate-900 text-white z-30 transition-transform duration-300
                    w-64 flex flex-col shadow-2xl
                    ${isOpen ? 'translate-x-0' : '-translate-x-full'}
                    md:translate-x-0 md:relative
                `}>
                    <div className="p-6 border-b border-slate-800 flex items-center gap-3">
                        <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg">
                            <Network className="text-white w-5 h-5" />
                        </div>
                        <div>
                            <h1 className="font-bold text-lg tracking-wide">訓練流路</h1>
                            <p className="text-xs text-slate-400">訓練中心內部系統</p>
                        </div>
                    </div>

                    <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                        {renderItem(1, '消防人員', <UserCheck size={20} />)}
                        {renderItem(2, '非消防人員', <Users size={20} />)}
                        {renderItem(3, '重大活動', <Flag size={20} />)}
                        {renderItem(4, '甘特圖', <BarChart2 size={20} />)}
                    </nav>

                    <div className="p-4 border-t border-slate-800 space-y-2 bg-slate-900">
                        <div className="text-[10px] text-slate-500 font-bold px-4 mb-1 uppercase tracking-wider">系統切換</div>
                        <a href="https://tfd-train.github.io/Facility-Booking/" className="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm">
                            <Building2 size={18} className="text-indigo-400" /> 場地借用系統
                        </a>
                        <a href="https://tfd-train.github.io/Training-Management-Platform/" className="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-500 hover:text-white transition text-xs">
                            <ArrowLeft size={16} /> 回整合首頁
                        </a>
                    </div>
                </aside>
            );
        };

        // --- Component: DateModal (Corrected) ---
        const DateModal = ({ 
          isOpen, onClose, onConfirm, dateString, initialExcluded, year, holidays 
        }) => {
          // Set of selected dates in "M-D" format (e.g., "1-15")
          const [selectedDates, setSelectedDates] = useState(new Set());
          
          // Current view month (1-12)
          const [viewMonth, setViewMonth] = useState(1);

          // Initialize
          useEffect(() => {
            if (isOpen) {
              const parsed = parseDateStr(dateString, [], year);
              const newSet = new Set();
              let firstMonthFound = -1;
              let hasValidDates = false;

              parsed.forEach(p => {
                if (p.y === year) {
                    const isLegacyExcluded = initialExcluded && initialExcluded.includes(p.d);
                    if (!isLegacyExcluded) {
                        newSet.add(`${p.m}-${p.d}`);
                        if (firstMonthFound === -1) firstMonthFound = p.m;
                        hasValidDates = true;
                    }
                }
              });

              setSelectedDates(newSet);

              // Logic to set initial view month
              if (hasValidDates && firstMonthFound > 0) {
                setViewMonth(firstMonthFound);
              } else {
                // Default to current month if empty
                setViewMonth(new Date().getMonth() + 1);
              }
            }
          }, [isOpen, dateString, initialExcluded, year]);

          const changeMonth = (delta) => {
            let m = viewMonth + delta;
            if (m > 12) m = 1;
            if (m < 1) m = 12;
            setViewMonth(m);
          };

          const toggleDay = (d) => {
            const key = `${viewMonth}-${d}`;
            const newSet = new Set(selectedDates);
            if (newSet.has(key)) {
                newSet.delete(key);
            } else {
                newSet.add(key);
            }
            setSelectedDates(newSet);
          };

          const getDaysInMonth = (m, y) => {
            return new Date(y, m, 0).getDate();
          };

          const weekDays = ['日','一','二','三','四','五','六'];
          const totalDays = getDaysInMonth(viewMonth, year);
          const firstDayOfWeek = new Date(year, viewMonth - 1, 1).getDay(); // 0=Sun

          // --- Mass Selection Logic ---
          const applyFilter = (type) => {
            const newSet = new Set(selectedDates);
            
            for (let d = 1; d <= totalDays; d++) {
                const key = `${viewMonth}-${d}`;
                const dateObj = new Date(year, viewMonth - 1, d);
                const dayOfWeek = dateObj.getDay();
                const isHoli = isDayOff(year, viewMonth, d, holidays);
                const isWeekendOrHoliday = dayOfWeek === 0 || dayOfWeek === 6 || isHoli;

                switch (type) {
                    case 'select-all':
                        newSet.add(key);
                        break;
                    case 'clear-all':
                        newSet.delete(key);
                        break;
                    case 'select-weekends':
                        if (isWeekendOrHoliday) newSet.add(key);
                        else newSet.delete(key);
                        break;
                    case 'select-weekdays':
                        if (!isWeekendOrHoliday) newSet.add(key);
                        else newSet.delete(key);
                        break;
                    case 'invert':
                        if (newSet.has(key)) newSet.delete(key);
                        else newSet.add(key);
                        break;
                }
            }
            setSelectedDates(newSet);
          };

          const toggleWeekDay = (targetDayIdx) => {
            const newSet = new Set(selectedDates);
            let allSelected = true;
            for (let d = 1; d <= totalDays; d++) {
                const dateObj = new Date(year, viewMonth - 1, d);
                if (dateObj.getDay() === targetDayIdx) {
                    if (!newSet.has(`${viewMonth}-${d}`)) {
                        allSelected = false;
                        break;
                    }
                }
            }
            for (let d = 1; d <= totalDays; d++) {
                const dateObj = new Date(year, viewMonth - 1, d);
                if (dateObj.getDay() === targetDayIdx) {
                    const key = `${viewMonth}-${d}`;
                    if (allSelected) newSet.delete(key);
                    else newSet.add(key);
                }
            }
            setSelectedDates(newSet);
          };

          const handleConfirm = () => {
            const list = Array.from(selectedDates).map(str => {
                const [m, d] = str.split('-').map(Number);
                return { m, d };
            });
            list.sort((a, b) => {
                if (a.m !== b.m) return a.m - b.m;
                return a.d - b.d;
            });
            const grouped = {};
            list.forEach(item => {
                if (!grouped[item.m]) grouped[item.m] = [];
                grouped[item.m].push(item.d);
            });
            const parts = [];
            Object.keys(grouped).forEach(mStr => {
                const m = parseInt(mStr);
                const days = grouped[m];
                let ranges = [];
                if (days.length > 0) {
                    let start = days[0];
                    let prev = days[0];
                    for (let i = 1; i < days.length; i++) {
                        if (days[i] === prev + 1) {
                            prev = days[i];
                        } else {
                            if (start === prev) ranges.push(`${start}`);
                            else ranges.push(`${start}-${prev}`);
                            start = days[i];
                            prev = days[i];
                        }
                    }
                    if (start === prev) ranges.push(`${start}`);
                    else ranges.push(`${start}-${prev}`);
                }
                if (ranges.length > 0) {
                    parts.push(`${m}/${ranges.join('、')}`);
                }
            });
            onConfirm(parts.join(' '), []);
          };

          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black/50 z-[2000] flex justify-center items-center backdrop-blur-sm">
              <div className="bg-white w-[95%] max-w-[600px] rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                
                <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                     <div>
                        <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                            <CalendarDays size={20} className="text-blue-600"/>
                            日期選擇器
                        </h3>
                        <p className="text-xs text-slate-500 font-mono mt-1 ml-7">
                            目前年度: {year} ({year-1911}年)
                        </p>
                     </div>
                     <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition text-slate-500">
                        <X size={20} />
                     </button>
                </div>

                <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-white">
                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                        <div className="flex items-center gap-2 mb-3">
                            <MousePointerClick size={16} className="text-slate-400"/>
                            <span className="text-xs font-bold text-slate-600 uppercase tracking-wider">批量選擇 (當前月份)</span>
                        </div>
                        <div className="space-y-3">
                            <div className="flex flex-wrap gap-2">
                                <button onClick={() => applyFilter('select-all')} className="px-3 py-1.5 text-xs font-bold bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100 transition">全選本月</button>
                                <button onClick={() => applyFilter('clear-all')} className="px-3 py-1.5 text-xs font-bold bg-white text-slate-600 border border-slate-200 rounded-lg hover:bg-slate-100 transition">清除本月</button>
                                <button onClick={() => applyFilter('invert')} className="px-3 py-1.5 text-xs font-bold bg-slate-100 text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-200 transition">反向選擇</button>
                            </div>
                            <div className="h-px bg-slate-200 w-full"></div>
                            <div className="flex flex-wrap gap-2">
                                 <button onClick={() => applyFilter('select-weekdays')} className="px-3 py-1.5 text-xs font-bold bg-blue-50 text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 transition">只選平日</button>
                                <button onClick={() => applyFilter('select-weekends')} className="px-3 py-1.5 text-xs font-bold bg-amber-50 text-amber-700 border border-amber-200 rounded-lg hover:bg-amber-100 transition">只選六日</button>
                            </div>
                            <div className="h-px bg-slate-200 w-full"></div>
                            <div className="flex flex-col gap-1.5">
                                <span className="text-[10px] text-slate-400 font-bold">按星期快速切換:</span>
                                <div className="flex gap-1 flex-wrap">
                                    {weekDays.map((d, i) => (
                                        <button key={i} onClick={() => toggleWeekDay(i)} className="flex-1 min-w-[32px] py-1 text-xs border border-slate-200 rounded bg-white hover:bg-slate-50 hover:border-blue-300 text-slate-600 transition">{d}</button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex items-center justify-between mb-4 px-2">
                        <button onClick={() => changeMonth(-1)} className="p-2 rounded-lg hover:bg-slate-100 text-slate-600 border border-slate-200 shadow-sm"><ChevronLeft size={20} /></button>
                        <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2"><span className="text-blue-600">{viewMonth}</span> 月</h4>
                        <button onClick={() => changeMonth(1)} className="p-2 rounded-lg hover:bg-slate-100 text-slate-600 border border-slate-200 shadow-sm"><ChevronRight size={20} /></button>
                    </div>

                    <div className="grid grid-cols-7 gap-2">
                        {weekDays.map(d => (<div key={d} className="text-center text-xs font-bold text-slate-400 py-2">{d}</div>))}
                        {Array.from({ length: firstDayOfWeek }).map((_, i) => (<div key={`empty-${i}`}></div>))}
                        {Array.from({ length: totalDays }).map((_, i) => {
                            const d = i + 1;
                            const key = `${viewMonth}-${d}`;
                            const isSelected = selectedDates.has(key);
                            const isOff = isDayOff(year, viewMonth, d, holidays);
                            return (
                                <button
                                    key={key}
                                    onClick={() => toggleDay(d)}
                                    className={`
                                        relative p-1 rounded-lg text-sm font-medium border transition-all duration-150
                                        flex flex-col items-center justify-center min-h-[56px]
                                        ${isSelected 
                                            ? 'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-200 transform scale-[1.02]' 
                                            : 'bg-white text-slate-700 border-slate-200 hover:border-blue-300 hover:shadow-sm'
                                        }
                                        ${!isSelected && isOff ? 'bg-red-50/50 text-red-600 border-red-100' : ''}
                                    `}
                                >
                                    <div className="flex justify-between w-full px-1 mb-1">
                                        <span className={`text-[9px] ${isSelected ? 'text-blue-200' : 'opacity-60'}`}>{weekDays[(firstDayOfWeek + i) % 7]}</span>
                                        {isOff && (<span className={`text-[9px] font-bold ${isSelected ? 'text-white' : 'text-red-500'}`}>休</span>)}
                                    </div>
                                    <span className="text-xl font-bold leading-none">{d}</span>
                                    {isSelected && <Check size={12} className="mt-1 opacity-80" />}
                                </button>
                            );
                        })}
                    </div>
                    <div className="mt-6 text-center text-xs text-slate-400">已選擇 {selectedDates.size} 個日期</div>
                </div>

                <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-white rounded-b-2xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    <button onClick={onClose} className="px-6 py-2.5 text-slate-500 hover:bg-slate-100 rounded-xl font-bold text-sm transition">取消</button>
                    <button onClick={handleConfirm} className="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold text-sm shadow-lg shadow-blue-200 flex items-center gap-2 transition transform active:scale-95">
                        <Check size={18} /> 確定並帶入
                    </button>
                </div>
              </div>
            </div>
          );
        };

        // --- Component: FirefighterTable ---
        const FirefighterTable = ({ data, onChange, onDelete, onAdd, onOpenDateModal }) => {
            return (
                <div className="flex flex-col h-full">
                <div className="table-container flex-1 mb-4 overflow-auto custom-scrollbar bg-white rounded-lg border border-slate-200">
                    <table className="w-full border-collapse text-[13px] table-fixed min-w-[2000px]">
                    <thead className="bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                        <th className="border border-slate-300 p-2 w-[50px]">刪除</th>
                        <th className="border border-slate-300 p-2 w-[40px]">項次</th>
                        <th className="border border-slate-300 p-2 w-[40px]">月份</th>
                        <th className="border border-slate-300 p-2 w-[100px]">承辦單位</th>
                        <th className="border border-slate-300 p-2 w-[200px]">課程名稱</th>
                        <th className="border border-slate-300 p-2 w-[80px]">訓練對象</th>
                        <th className="border border-slate-300 p-2 w-[140px]">課程日期</th>
                        <th className="border border-slate-300 p-2 w-[120px]">上課地點</th>
                        <th className="border border-slate-300 p-2 w-[40px]">梯數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">每梯<br/>人數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">合計<br/>人數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">每天<br/>時數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">每梯<br/>時數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">合計<br/>時數</th>
                        <th className="border border-slate-300 p-2 w-[100px] bg-sky-100">預計調用人數<br/>(分隊人力)</th>
                        <th className="border border-slate-300 p-2 w-[120px] bg-yellow-100">是否提供宜基<br/>北桃參訓</th>
                        <th className="border border-slate-300 p-2 w-[60px] bg-yellow-100">暫訂<br/>新北</th>
                        <th className="border border-slate-300 p-2 w-[60px] bg-yellow-100">暫訂<br/>基隆</th>
                        <th className="border border-slate-300 p-2 w-[60px] bg-yellow-100">暫訂<br/>桃園</th>
                        <th className="border border-slate-300 p-2 w-[60px] bg-yellow-100">暫訂<br/>宜蘭</th>
                        <th className="border border-slate-300 p-2 w-[150px]">備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map((row, i) => {
                        const totalPeople = (Number(row.batch) * Number(row.pb)) || 0;
                        const totalHours = (Number(row.batch) * Number(row.bHour)) || 0;
                        return (
                            <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                            <td className="border border-slate-300 p-0 text-center">
                                <button onClick={() => onDelete(i)} className="text-slate-300 hover:text-red-500 transition w-full h-full flex items-center justify-center"><Trash2 size={18} /></button>
                            </td>
                            <td className="border border-slate-300 p-0"><input type="text" value={i + 1} readOnly className="w-full h-[38px] text-center text-slate-400 bg-transparent outline-none" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.m || ''} readOnly className="w-full h-[38px] text-center text-slate-500 bg-slate-50 outline-none" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.unit || ''} onChange={(e) => onChange(i, 'unit', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><textarea value={row.name || ''} onChange={(e) => onChange(i, 'name', e.target.value)} className="w-full h-full min-h-[38px] p-2 text-left resize-none outline-none focus:bg-blue-50 leading-tight"/></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.target || ''} onChange={(e) => onChange(i, 'target', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0">
                                <div className="flex items-center h-full">
                                    <input type="text" value={row.date || ''} onChange={(e) => { 
                                        const val = e.target.value;
                                        onChange(i, 'date', val); 
                                        // FIX: 這裡也加上年份過濾邏輯，確保自動填入月份正確
                                        // 移除 "115/" 或 "2026/" 等前綴
                                        const noYear = val.replace(/(^|[\s])(?:1\d{2}|20\d{2})[\/.-]/g, '');
                                        const m = noYear.match(/^(\d{1,2})/); 
                                        if(m) onChange(i, 'm', m[1]); 
                                    }} placeholder="1/6-19" className="flex-1 h-[38px] text-center outline-none focus:bg-blue-50" />
                                    <button onClick={() => onOpenDateModal(i)} className="w-[30px] h-full border-l border-slate-300 bg-slate-50 text-slate-500 hover:text-blue-600 flex items-center justify-center transition-colors hover:bg-slate-100"><Calendar size={16} /></button>
                                </div>
                            </td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.loc || ''} onChange={(e) => onChange(i, 'loc', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.batch || ''} onChange={(e) => onChange(i, 'batch', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.pb || ''} onChange={(e) => onChange(i, 'pb', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0 bg-slate-50 text-center text-slate-500 font-medium">{totalPeople}</td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.dHour || ''} onChange={(e) => onChange(i, 'dHour', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.bHour || ''} onChange={(e) => onChange(i, 'bHour', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0 bg-slate-50 text-center text-slate-500 font-medium">{totalHours}</td>
                            <td className="border border-slate-300 p-0 bg-sky-50"><input type="number" value={row.mp || ''} onChange={(e) => onChange(i, 'mp', e.target.value)} className="w-full h-[38px] text-center outline-none bg-transparent focus:bg-blue-100" /></td>
                            <td className="border border-slate-300 p-0 text-center"><input type="checkbox" checked={row.ext} onChange={(e) => onChange(i, 'ext', e.target.checked)} className="w-4 h-4 text-blue-600 rounded cursor-pointer" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.nt || ''} onChange={(e) => onChange(i, 'nt', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.kl || ''} onChange={(e) => onChange(i, 'kl', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.ty || ''} onChange={(e) => onChange(i, 'ty', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.yl || ''} onChange={(e) => onChange(i, 'yl', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.note || ''} onChange={(e) => onChange(i, 'note', e.target.value)} className="w-full h-[38px] text-left px-2 outline-none focus:bg-blue-50" /></td>
                            </tr>
                        );
                        })}
                    </tbody>
                    </table>
                </div>
                <button onClick={onAdd} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0">
                    <Plus size={18} /> 新增資料列
                </button>
                </div>
            );
        };

        // --- Component: NonFirefighterTable ---
        const NonFirefighterTable = ({ data, onChange, onDelete, onAdd, onOpenDateModal }) => {
            return (
                <div className="flex flex-col h-full">
                <div className="table-container flex-1 mb-4 overflow-auto custom-scrollbar bg-white rounded-lg border border-slate-200">
                    <table className="w-full border-collapse text-[13px] table-fixed min-w-[1800px]">
                    <thead className="bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                        <th className="border border-slate-300 p-2 w-[50px]">刪除</th>
                        <th className="border border-slate-300 p-2 w-[40px]">序號</th>
                        <th className="border border-slate-300 p-2 w-[40px]">月份</th>
                        <th className="border border-slate-300 p-2 w-[100px]">承辦單位</th>
                        <th className="border border-slate-300 p-2 w-[200px]">課程名稱</th>
                        <th className="border border-slate-300 p-2 w-[120px]">訓練對象</th>
                        <th className="border border-slate-300 p-2 w-[140px]">課程日期</th>
                        <th className="border border-slate-300 p-2 w-[120px]">訓練地點</th>
                        <th className="border border-slate-300 p-2 w-[40px]">梯數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">每梯<br/>人數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">合計<br/>人數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">每天<br/>時數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">每梯<br/>時數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">合計<br/>時數</th>
                        <th className="border border-slate-300 p-2 w-[80px]">調用本局<br/>教官人數</th>
                        <th className="border border-slate-300 p-2 w-[100px]">是否提供<br/>跨縣市</th>
                        <th className="border border-slate-300 p-2 w-[150px]">備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map((row, i) => {
                        const totalPeople = (Number(row.batch) * Number(row.pb)) || 0;
                        const totalHours = (Number(row.batch) * Number(row.bHour)) || 0;
                        return (
                            <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                            <td className="border border-slate-300 p-0 text-center"><button onClick={() => onDelete(i)} className="text-slate-300 hover:text-red-500 transition w-full h-full flex items-center justify-center"><Trash2 size={18} /></button></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={i + 1} readOnly className="w-full h-[38px] text-center text-slate-400 bg-transparent outline-none" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.m || ''} readOnly className="w-full h-[38px] text-center text-slate-500 bg-slate-50 outline-none" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.unit || ''} onChange={(e) => onChange(i, 'unit', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><textarea value={row.name || ''} onChange={(e) => onChange(i, 'name', e.target.value)} className="w-full h-full min-h-[38px] p-2 text-left resize-none outline-none focus:bg-blue-50 leading-tight" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.target || ''} onChange={(e) => onChange(i, 'target', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0">
                                <div className="flex items-center h-full">
                                    <input type="text" value={row.date || ''} onChange={(e) => { 
                                        const val = e.target.value;
                                        onChange(i, 'date', val); 
                                        // FIX: Remove year prefix
                                        const noYear = val.replace(/(^|[\s])(?:1\d{2}|20\d{2})[\/.-]/g, '');
                                        const m = noYear.match(/^(\d{1,2})/); 
                                        if(m) onChange(i, 'm', m[1]); 
                                    }} className="flex-1 h-[38px] text-center outline-none focus:bg-blue-50" placeholder="1/6" />
                                    <button onClick={() => onOpenDateModal(i)} className="w-[30px] h-full border-l border-slate-300 bg-slate-50 text-slate-500 hover:text-blue-600 flex items-center justify-center transition-colors hover:bg-slate-100"><Calendar size={16} /></button>
                                </div>
                            </td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.loc || ''} onChange={(e) => onChange(i, 'loc', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.batch || ''} onChange={(e) => onChange(i, 'batch', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.pb || ''} onChange={(e) => onChange(i, 'pb', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0 bg-slate-50 text-center text-slate-500 font-medium">{totalPeople}</td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.dHour || ''} onChange={(e) => onChange(i, 'dHour', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.bHour || ''} onChange={(e) => onChange(i, 'bHour', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0 bg-slate-50 text-center text-slate-500 font-medium">{totalHours}</td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.inst || ''} onChange={(e) => onChange(i, 'inst', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0 text-center"><input type="checkbox" checked={row.ext} onChange={(e) => onChange(i, 'ext', e.target.checked)} className="w-4 h-4 text-blue-600 rounded cursor-pointer" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.note || ''} onChange={(e) => onChange(i, 'note', e.target.value)} className="w-full h-[38px] text-left px-2 outline-none focus:bg-blue-50" /></td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      <button onClick={onAdd} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0">
        <Plus size={18} /> 新增資料列
      </button>
    </div>
  );
};

        // --- Component: EventTable ---
        const EventTable = ({ data, onChange, onDelete, onAdd, onOpenDateModal }) => {
            return (
                <div className="flex flex-col h-full">
                <div className="table-container flex-1 mb-4 overflow-auto custom-scrollbar bg-white rounded-lg border border-slate-200">
                    <table className="w-full border-collapse text-[13px] table-fixed min-w-[1200px]">
                    <thead className="bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <tr>
                        <th className="border border-slate-300 p-2 w-[50px]">刪除</th>
                        <th className="border border-slate-300 p-2 w-[40px]">序號</th>
                        <th className="border border-slate-300 p-2 w-[100px]">承辦單位</th>
                        <th className="border border-slate-300 p-2 w-[250px]">重大活動演習名稱</th>
                        <th className="border border-slate-300 p-2 w-[150px]">參加對象</th>
                        <th className="border border-slate-300 p-2 w-[140px]">日期</th>
                        <th className="border border-slate-300 p-2 w-[50px]">天數</th>
                        <th className="border border-slate-300 p-2 w-[50px]">時數</th>
                        <th className="border border-slate-300 p-2 w-[100px] bg-red-50">每日調用<br/>外勤人數</th>
                        <th className="border border-slate-300 p-2 w-[150px]">地點(教室)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map((row, i) => (
                        <tr key={row.id} className="hover:bg-slate-50 transition-colors">
                            <td className="border border-slate-300 p-0 text-center"><button onClick={() => onDelete(i)} className="text-slate-300 hover:text-red-500 transition w-full h-full flex items-center justify-center"><Trash2 size={18} /></button></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={i + 1} readOnly className="w-full h-[38px] text-center text-slate-400 bg-transparent outline-none" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.unit || ''} onChange={(e) => onChange(i, 'unit', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><textarea value={row.name || ''} onChange={(e) => onChange(i, 'name', e.target.value)} className="w-full h-full min-h-[38px] p-2 text-left resize-none outline-none focus:bg-blue-50 leading-tight" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.target || ''} onChange={(e) => onChange(i, 'target', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0">
                                <div className="flex items-center h-full">
                                    <input type="text" value={row.date || ''} onChange={(e) => onChange(i, 'date', e.target.value)} className="flex-1 h-[38px] text-center outline-none focus:bg-blue-50" />
                                    <button onClick={() => onOpenDateModal(i)} className="w-[30px] h-full border-l border-slate-300 bg-slate-50 text-slate-500 hover:text-blue-600 flex items-center justify-center transition-colors hover:bg-slate-100"><Calendar size={16} /></button>
                                </div>
                            </td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.days || ''} onChange={(e) => onChange(i, 'days', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0"><input type="number" value={row.hours || ''} onChange={(e) => onChange(i, 'hours', e.target.value)} className="w-full h-[38px] text-center outline-none focus:bg-blue-50" /></td>
                            <td className="border border-slate-300 p-0 bg-red-50"><input type="number" value={row.mp || ''} onChange={(e) => onChange(i, 'mp', e.target.value)} className="w-full h-[38px] text-center outline-none bg-transparent focus:bg-red-100" /></td>
                            <td className="border border-slate-300 p-0"><input type="text" value={row.loc || ''} onChange={(e) => onChange(i, 'loc', e.target.value)} className="w-full h-[38px] text-left px-2 outline-none focus:bg-blue-50" /></td>
                        </tr>
                        ))}
                    </tbody>
                    </table>
                </div>
                <button onClick={onAdd} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0">
                    <Plus size={18} /> 新增資料列
                </button>
                </div>
            );
        };

        // --- Component: GanttChart ---
        const GanttChart = ({ data, year, holidays }) => {
            const months = Array.from({ length: 12 }, (_, i) => i + 1);
            const days = Array.from({ length: 31 }, (_, i) => i + 1);

            const calculatedRows = useMemo(() => {
                const rows = [];
                const processRow = (r, val, prefix) => {
                    if (!r.date || (!r.mp && !r.inst)) return;
                    let daysSet = parseDateStr(r.date, r.ex || [], year);
                    daysSet = daysSet.filter(d => d.y === year);
                    if (daysSet.length === 0) return;
                    const involvedMonths = [...new Set(daysSet.map(o => o.m))].sort((a, b) => a - b);
                    involvedMonths.forEach(m => {
                        const daysInThisMonth = daysSet.filter(o => o.m === m).map(o => o.d);
                        const valueStr = val ? `(${prefix} ${val}人)` : '';
                        const label = `${r.date} ${r.name} ${valueStr}`;
                        rows.push({ m, n: label, ds: daysInThisMonth, v: val });
                    });
                };

                data.d1.forEach(r => processRow(r, r.mp, '調用'));
                data.d2.forEach(r => processRow(r, r.inst, '教官'));
                data.d3.forEach(r => processRow(r, r.mp, '調用'));

                const grouped = {};
                months.forEach(m => grouped[m] = []);
                rows.forEach(r => { if (grouped[r.m]) grouped[r.m].push(r); });
                return grouped;
            }, [data, year]);

            return (
                <div className="flex flex-col h-full">
                <div className="bg-amber-50 text-amber-800 px-4 py-3 rounded-xl border border-amber-200 text-sm mb-4 flex items-center gap-2 shadow-sm">
                    <Calendar size={18} className="text-amber-500" />
                    <span><strong>說明：</strong> 紅色底色代表國定假日或週末。資料來源：行政院行事曆。</span>
                </div>
                <div className="table-container flex-1 p-4 bg-white overflow-auto custom-scrollbar">
                    <div id="ganttExportArea">
                    <table className="border-collapse table-fixed w-[1232px] min-w-[1232px]">
                        <colgroup>
                            <col style={{ width: '300px', minWidth: '300px' }} />
                            {days.map(d => <col key={d} style={{ width: '30px', minWidth: '30px' }} />)}
                        </colgroup>
                        <thead>
                            <tr>
                                <th className="border border-slate-800 bg-white p-1 text-sm font-bold align-middle">{year}年 班期 / 活動名稱</th>
                                {days.map(d => <th key={d} className="border border-slate-800 bg-white p-0 text-center text-xs">{d}</th>)}
                            </tr>
                        </thead>
                        {months.map(m => {
                            const monthRows = calculatedRows[m];
                            if (!monthRows || monthRows.length === 0) return null;
                            const dailySums = Array(32).fill(0);
                            monthRows.forEach(r => {
                                r.ds.forEach(d => {
                                    const val = parseInt(String(r.v)) || 0;
                                    dailySums[d] += val;
                                });
                            });

                            return (
                                <tbody key={m} className="border-b-2 border-black break-inside-avoid">
                                    <tr className="bg-slate-200 border border-slate-800 font-bold"><td colSpan={32} className="pl-4 py-1 text-sm border border-slate-800">{m} 月份</td></tr>
                                    {monthRows.map((row, idx) => (
                                        <React.Fragment key={idx}>
                                            <tr className="h-[28px]">
                                                <td rowSpan={2} className="border border-slate-800 p-1 text-xs break-all bg-white leading-tight align-middle">{row.n}</td>
                                                {days.map(d => {
                                                    const isActive = row.ds.includes(d);
                                                    const isOff = isDayOff(year, m, d, holidays);
                                                    const bgClass = isOff ? (holidays[`${year}-${m}-${d}`] ? 'bg-red-100' : 'bg-gray-100') : '';
                                                    const activeClass = isActive ? '!bg-blue-500 border-black' : '';
                                                    return <td key={d} className={`border border-slate-800 border-b-0 p-0 ${bgClass} ${activeClass}`}></td>;
                                                })}
                                            </tr>
                                            <tr className="h-[28px]">
                                                {days.map(d => {
                                                    const isActive = row.ds.includes(d);
                                                    const isOff = isDayOff(year, m, d, holidays);
                                                    const bgClass = isOff ? (holidays[`${year}-${m}-${d}`] ? 'bg-red-100' : 'bg-gray-100') : '';
                                                    return <td key={d} className={`border border-slate-800 border-t-0 p-0 text-center text-[10px] font-bold ${bgClass}`}>{isActive && row.v != '0' ? row.v : ''}</td>;
                                                })}
                                            </tr>
                                        </React.Fragment>
                                    ))}
                                    <tr className="h-[28px]">
                                        <td className="border border-slate-800 bg-slate-50 text-center text-xs font-bold text-blue-800">每日統計</td>
                                        {days.map(d => <td key={d} className="border border-slate-800 bg-slate-50 text-center text-xs font-bold text-blue-800">{dailySums[d] > 0 ? dailySums[d] : ''}</td>)}
                                    </tr>
                                </tbody>
                            );
                        })}
                    </table>
                    </div>
                </div>
                </div>
            );
        };

        // --- Component: App ---
        const App = () => {
            const [currentTab, setCurrentTab] = useState(1);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [year, setYear] = useState(new Date().getFullYear());
            const [loading, setLoading] = useState(false);
            const [loadingText, setLoadingText] = useState('初始化中...');
            const [holidays, setHolidays] = useState({});
            
            const [modalState, setModalState] = useState({ isOpen: false, tab: null, index: null });

            const [data, setData] = useState({
                d1: [{ id: uuidv4(), m: '1', unit: '', name: '', target: '', date: '', loc: '', batch: '', pb: '', dHour: '', bHour: '', mp: '', ext: false, nt: '', kl: '', ty: '', yl: '', note: '', ex: [], isNew: true }],
                d2: [{ id: uuidv4(), m: '1', unit: '', name: '', target: '', date: '', loc: '', batch: '', pb: '', dHour: '', bHour: '', inst: '', ext: false, note: '', ex: [], isNew: true }],
                d3: [{ id: uuidv4(), unit: '', name: '', target: '', date: '', days: '', hours: '', mp: '', loc: '', ex: [], isNew: true }]
            });

            useEffect(() => {
                const init = async () => {
                    setLoading(true);
                    setLoadingText('同步資料中...');
                    await refreshHolidays(year);
                    const cloudData = await loadData();
                    if (cloudData) setData(cloudData);
                    setLoading(false);
                };
                init();
            }, []);

            const refreshHolidays = async (y) => {
                const h = await fetchHolidays(y);
                setHolidays(h);
            };

            const handleYearChange = async (val) => {
                const newYear = parseInt(val);
                setYear(newYear);
                setLoading(true);
                await refreshHolidays(newYear);
                setLoading(false);
            };

            const handleSave = async () => {
                setLoading(true);
                setLoadingText('儲存中...');
                try {
                    await saveData(data);
                    alert('儲存成功');
                } catch(e) {
                    alert('儲存失敗');
                }
                setLoading(false);
            };

            const updateRow = useCallback((tab, index, field, value) => {
                setData(prev => {
                    const key = `d${tab}`;
                    const newList = [...prev[key]];
                    newList[index] = { ...newList[index], [field]: value };
                    return { ...prev, [key]: newList };
                });
            }, []);

            const addRow = (tab) => {
                setData(prev => {
                    const key = `d${tab}`;
                    const newRow = { id: uuidv4(), unit: '', name: '', date: '', loc: '', ex: [], isNew: true };
                    if(tab === 1 || tab === 2) { newRow.m = ''; newRow.batch = ''; newRow.pb = ''; }
                    return { ...prev, [key]: [...prev[key], newRow] };
                });
            };

            const deleteRow = (tab, index) => {
                if(!window.confirm('確定刪除此列？')) return;
                setData(prev => {
                    const key = `d${tab}`;
                    const newList = [...prev[key]];
                    newList.splice(index, 1);
                    return { ...prev, [key]: newList };
                });
            };

            const openDateModal = (tab, index) => setModalState({ isOpen: true, tab, index });
            const closeDateModal = () => setModalState({ isOpen: false, tab: null, index: null });

            const handleDateModalConfirm = (formattedDateStr, excludedDays) => {
                if (modalState.tab && modalState.index !== null) {
                    updateRow(modalState.tab, modalState.index, 'ex', excludedDays);
                    updateRow(modalState.tab, modalState.index, 'date', formattedDateStr);
                    
                    const noYear = formattedDateStr.replace(/(^|[\s])(?:1\d{2}|20\d{2})[\/.-]/g, '');
                    const m = noYear.match(/^(\d{1,2})/); 
                    if(m && (modalState.tab === 1 || modalState.tab === 2)) {
                         updateRow(modalState.tab, modalState.index, 'm', m[1]);
                    }
                }
                closeDateModal();
            };

            const handleCSVImport = (e) => {
                const file = e.target.files?.[0];
                if(!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        alert(`已讀取 ${results.data.length} 筆資料 (簡易模式)`);
                    }
                });
            };

            const getTitle = () => {
                switch(currentTab) {
                    case 1: return "附件1 - 消防人員";
                    case 2: return "附件2 - 非消防人員";
                    case 3: return "附件3 - 重大活動";
                    case 4: return "甘特圖";
                }
            };

            const getCurrentRowData = () => {
                if (modalState.tab && modalState.index !== null) {
                    const key = `d${modalState.tab}`;
                    const row = data[key][modalState.index];
                    return { dateString: row.date, excluded: row.ex || [] };
                }
                return { dateString: '', excluded: [] };
            };

            const { dateString, excluded } = getCurrentRowData();

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100 font-sans">
                    {loading && (
                        <div className="fixed inset-0 bg-black/50 z-[9999] flex flex-col items-center justify-center text-white backdrop-blur-sm">
                            <Loader2 size={48} className="animate-spin mb-4" />
                            <div className="text-lg font-bold">{loadingText}</div>
                        </div>
                    )}

                    <DateModal 
                        isOpen={modalState.isOpen}
                        onClose={closeDateModal}
                        onConfirm={handleDateModalConfirm}
                        dateString={dateString}
                        initialExcluded={excluded}
                        year={year}
                        holidays={holidays}
                    />

                    <Sidebar 
                        currentTab={currentTab} 
                        onSwitch={setCurrentTab} 
                        isOpen={mobileMenuOpen} 
                        onCloseMobile={() => setMobileMenuOpen(false)}
                    />

                    <main className="flex-1 flex flex-col min-w-0 relative">
                        <div className="md:hidden bg-white h-14 flex items-center justify-between px-4 shadow-sm border-b border-slate-200 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 text-slate-600"><Menu /></button>
                                <div className="font-bold text-slate-800">{getTitle().replace(/附件\d - /, '')}</div>
                            </div>
                        </div>

                        <div className="bg-white px-6 py-3 border-b border-slate-200 flex flex-wrap items-center justify-between gap-3 shadow-sm z-10">
                            <div className="hidden md:flex items-center gap-2 text-lg font-bold text-slate-800">
                                <span className="w-2 h-6 bg-blue-600 rounded-full"></span>
                                {getTitle()}
                            </div>

                            <div className="flex items-center gap-2">
                                <span className="text-sm font-bold text-slate-600">年度:</span>
                                <select value={year} onChange={(e) => handleYearChange(e.target.value)} className="bg-white border border-slate-300 text-slate-800 text-sm rounded-lg p-1.5 font-bold outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
                                    <option value="2025">114年 (2025)</option>
                                    <option value="2026">115年 (2026)</option>
                                    <option value="2027">116年 (2027)</option>
                                    <option value="2028">117年 (2028)</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                                {currentTab !== 4 ? (
                                    <>
                                        <label className="cursor-pointer px-3 py-1.5 rounded-lg text-sm font-bold bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600 flex items-center gap-2 transition whitespace-nowrap">
                                            <Upload size={16} /> 匯入
                                            <input type="file" accept=".csv" className="hidden" onChange={handleCSVImport} />
                                        </label>
                                        <button onClick={handleSave} className="px-3 py-1.5 rounded-lg text-sm font-bold bg-slate-900 text-white hover:bg-slate-800 shadow-lg flex items-center gap-2 transition whitespace-nowrap transform active:scale-95">
                                            <Save size={16} /> 儲存資料
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button className="px-3 py-1.5 rounded-lg text-sm font-bold bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg flex items-center gap-2 transition whitespace-nowrap">
                                            <FileSpreadsheet size={16} /> 下載 Excel
                                        </button>
                                        <button className="px-3 py-1.5 rounded-lg text-sm font-bold bg-rose-600 text-white hover:bg-rose-700 shadow-lg flex items-center gap-2 transition whitespace-nowrap">
                                            <FileText size={16} /> 下載 PDF
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="flex-1 overflow-hidden p-4 relative bg-slate-100">
                            {currentTab === 1 && (
                                <FirefighterTable 
                                    data={data.d1} 
                                    onChange={(i, f, v) => updateRow(1, i, f, v)}
                                    onDelete={(i) => deleteRow(1, i)}
                                    onAdd={() => addRow(1)}
                                    onOpenDateModal={(i) => openDateModal(1, i)}
                                />
                            )}
                            {currentTab === 2 && (
                                <NonFirefighterTable
                                    data={data.d2} 
                                    onChange={(i, f, v) => updateRow(2, i, f, v)}
                                    onDelete={(i) => deleteRow(2, i)}
                                    onAdd={() => addRow(2)}
                                    onOpenDateModal={(i) => openDateModal(2, i)}
                                />
                            )}
                            {currentTab === 3 && (
                                <EventTable
                                    data={data.d3} 
                                    onChange={(i, f, v) => updateRow(3, i, f, v)}
                                    onDelete={(i) => deleteRow(3, i)}
                                    onAdd={() => addRow(3)}
                                    onOpenDateModal={(i) => openDateModal(3, i)}
                                />
                            )}
                            {currentTab === 4 && (
                                <GanttChart data={data} year={year} holidays={holidays} />
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
