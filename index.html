<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨“ç·´æµè·¯ç®¡ç†ç³»çµ±</title>

    <!-- 1. è¼‰å…¥æ ¸å¿ƒå·¥å…·åº« (è«‹ä¿æŒç¶²è·¯é€£ç·š) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 2. è¦–è¦ºæ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
        }

        .table-container {
            overflow-x: auto;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
            width: auto;
            border-spacing: 0;
        }

        #table1 {
            min-width: 2000px;
        }

        #table2 {
            min-width: 1800px;
        }

        td {
            border: 1px solid #cbd5e1;
            height: auto;
            min-height: 38px;
            background: white;
            padding: 0;
            vertical-align: middle;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            height: 38px;
            border: none;
            outline: none;
            background: transparent;
            text-align: center;
            font-family: inherit;
            font-size: 13px;
            display: block;
            color: #334155;
        }

        input:focus {
            background: #eff6ff;
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        textarea {
            width: 100%;
            min-height: 38px;
            height: 100%;
            border: none;
            resize: none;
            outline: none;
            background: transparent;
            font-family: inherit;
            font-size: 13px;
            text-align: left;
            padding: 8px;
            box-sizing: border-box;
            line-height: 1.4;
        }

        textarea:focus {
            background: #eff6ff;
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        /* ç”˜ç‰¹åœ–å°ˆç”¨ CSS */
        #table4 {
            width: 1232px !important;
            min-width: 1232px !important;
            max-width: 1232px !important;
            table-layout: fixed !important;
            border-collapse: collapse;
            margin: 0;
        }

        .col-fix-name {
            width: 300px !important;
            min-width: 300px !important;
            max-width: 300px !important;
            white-space: normal;
            word-break: break-all;
            line-height: 1.3;
            padding: 5px;
            border: 1px solid #000 !important;
            vertical-align: middle !important;
            background: #fff;
            box-sizing: border-box;
        }

        .col-fix-day {
            width: 30px !important;
            min-width: 30px !important;
            max-width: 30px !important;
            text-align: center;
            padding: 0 !important;
            border: 1px solid #000 !important;
            box-sizing: border-box;
        }

        .gantt-visual-row,
        .gantt-data-row {
            height: 28px;
            line-height: 28px;
        }

        .gantt-cell-bar {
            border-bottom: none;
            height: 28px;
        }

        .gantt-num {
            border-top: none;
            font-weight: bold;
            color: #000;
            font-size: 12px;
            height: 28px;
            line-height: 28px;
        }

        .weekend {
            background-color: #f3f4f6;
        }

        .holiday-red {
            background-color: #fee2e2;
        }

        .bar-active {
            background-color: #3b82f6 !important;
            border-color: #000;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        tbody.gantt-month-group {
            break-inside: avoid;
            page-break-inside: avoid;
            border-bottom: 2px solid #000;
        }

        .gantt-month-header td {
            background: #e2e8f0;
            font-weight: bold;
            padding-left: 15px;
            border: 1px solid #000;
            font-size: 14px;
            height: 32px;
        }

        .stats-row td {
            background-color: #f8fafc;
            border: 1px solid #000;
            color: #1e40af;
            font-weight: bold;
            text-align: center;
        }

        /* UI å…ƒä»¶ */
        .date-cell {
            display: flex;
            align-items: center;
            height: 100%;
        }

        .date-cell input {
            flex: 1;
        }

        .btn-calendar {
            width: 30px;
            height: 100%;
            min-height: 38px;
            border: none;
            border-left: 1px solid #cbd5e1;
            cursor: pointer;
            background: #f8fafc;
            color: #64748b;
            transition: 0.2s;
        }

        .col-yellow {
            background: #ffffcc !important;
        }

        .col-blue-light {
            background: #e0f2fe !important;
        }

        .col-red-light {
            background: #fee2e2 !important;
        }

        /* Modal */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }

        .day-btn {
            padding: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
        }

        .day-btn.active.excluded {
            background: #64748b;
            color: white;
            text-decoration: line-through;
            border-color: #475569;
        }

        .day-btn.active {
            background: #dbeafe;
            color: #1e40af;
            font-weight: bold;
            border-color: #3b82f6;
        }

        .print-month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .month-select-btn {
            padding: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            transition: 0.2s;
            font-size: 13px;
        }

        .month-select-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        #loading {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
            font-size: 16px;
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #fff;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* åˆ—å°éš±è— */
        @media print {
            @page {
                size: A3 landscape;
                margin: 5mm;
            }

            body {
                background: white;
                height: auto;
                overflow: visible;
                display: block !important;
            }

            #sidebar,
            .top-bar,
            .btn-add-row,
            .del-btn,
            .btn-calendar,
            #loading,
            #csvInput,
            #toolbar-container,
            .mobile-header,
            #yearSelectorContainer {
                display: none !important;
            }

            .main-content,
            .workspace,
            .view-section,
            .table-container {
                width: 100%;
                height: auto;
                overflow: visible;
                display: block;
                padding: 0;
                margin: 0;
                border: none;
                box-shadow: none;
            }

            .view-section {
                display: none;
            }

            .view-section.active {
                display: block;
            }

            #table4 {
                width: 1232px !important;
                min-width: 1232px !important;
                table-layout: fixed !important;
            }

            .col-fix-name {
                width: 300px !important;
            }

            .col-fix-day {
                width: 30px !important;
                padding: 0 !important;
            }

            table,
            th,
            td {
                border: 1px solid #000 !important;
            }

            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-blue-500 selection:text-white">

    <div id="loading">
        <div class="spinner"></div>
        <div id="loadText">è™•ç†ä¸­...</div>
    </div>

    <!-- æ—¥æ›† Modal -->
    <div id="dateModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-[420px] p-6 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-lg text-slate-800">é¸æ“‡æ—¥æœŸ</h3>
                <select id="pickerYearSelect" onchange="changePickerYear(this.value)"
                    class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded p-1 font-bold">
                    <option value="2025">114å¹´</option>
                    <option value="2026">115å¹´</option>
                    <option value="2027">116å¹´</option>
                    <option value="2028">117å¹´</option>
                    <option value="2029">118å¹´</option>
                </select>
            </div>
            <div id="modalRangeText" class="text-sm text-blue-600 mb-3 font-mono"></div>
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100"
                    onclick="applyDateFilter('all')">å…¨é¸</button>
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100"
                    onclick="applyDateFilter('no-weekend')">æ’é™¤å…­æ—¥</button>
                <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100"
                    onclick="applyDateFilter('only-weekend')">åƒ…é¸å…­æ—¥</button>
                <button
                    class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100 text-red-500 border-red-200"
                    onclick="applyDateFilter('clear')">æ¸…é™¤</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="px-5 py-2 text-slate-500 hover:bg-slate-100 rounded-xl font-bold"
                    onclick="closeModal('dateModal')">å–æ¶ˆ</button>
                <button
                    class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-bold shadow-lg"
                    onclick="saveDateModal()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- ä¸‹è¼‰æœˆä»½é¸æ“‡ Modal -->
    <div id="printModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-[420px] p-6 rounded-2xl shadow-2xl">
            <h3 class="font-bold text-lg mb-2 text-slate-800">è«‹é¸æ“‡è¼¸å‡ºæœˆä»½</h3>
            <div class="flex justify-between items-center mb-4">
                <span class="text-xs text-slate-500">æœªé¸å–æœˆä»½å°‡è¢«éš±è—</span>
                <button class="px-2 py-1 text-xs border rounded" onclick="toggleAllMonths()">å…¨é¸/åé¸</button>
            </div>
            <div class="print-month-grid" id="printMonthGrid"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button class="px-5 py-2 text-slate-500 hover:bg-slate-100 rounded-xl font-bold"
                    onclick="closeModal('printModal')">å–æ¶ˆ</button>
                <button
                    class="px-5 py-2 bg-slate-900 text-white rounded-xl hover:bg-slate-800 font-bold shadow-lg"
                    onclick="executePrintOrExport()">ç¢ºèªåŸ·è¡Œ</button>
            </div>
        </div>
    </div>

    <!-- å´é‚Šæ¬„ -->
    <aside id="sidebar"
        class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-30 transition-all duration-300">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center shadow-lg"><i
                    class="ri-flow-chart text-white"></i></div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">è¨“ç·´æµè·¯</h1>
                <p class="text-xs text-slate-400">è¨“ç·´ä¸­å¿ƒå…§éƒ¨ç³»çµ±</p>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div onclick="switchTab(1, this)"
                class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl bg-blue-600/20 text-blue-300 border border-blue-500/30 flex items-center gap-3 hover:bg-blue-600 hover:text-white transition">
                <i class="ri-user-fire-line text-xl"></i> æ¶ˆé˜²äººå“¡
            </div>
            <div onclick="switchTab(2, this)"
                class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition">
                <i class="ri-group-line text-xl"></i> éæ¶ˆé˜²äººå“¡
            </div>
            <div onclick="switchTab(3, this)"
                class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition">
                <i class="ri-flag-line text-xl"></i> é‡å¤§æ´»å‹•
            </div>
            <div onclick="switchTab(4, this)"
                class="nav-item cursor-pointer w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition">
                <i class="ri-bar-chart-horizontal-line text-xl"></i> ç”˜ç‰¹åœ–
            </div>
        </nav>
        <div class="p-4 border-t border-slate-800 space-y-2 bg-slate-900">
            <div class="text-[10px] text-slate-500 font-bold px-4 mb-1 uppercase tracking-wider">ç³»çµ±åˆ‡æ›</div>
            <a href="javascript:void(0)" onclick="location.href=OTHER_SYSTEM_URL"
                class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm">
                <i class="ri-building-2-fill text-lg text-indigo-400"></i> å ´åœ°å€Ÿç”¨ç³»çµ±
            </a>
            <a href="javascript:void(0)" onclick="location.href=PORTAL_URL"
                class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-500 hover:text-white transition text-xs">
                <i class="ri-arrow-left-line"></i> å›æ•´åˆé¦–é 
            </a>
        </div>
    </aside>

    <!-- ä¸»å…§å®¹ -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
        <div
            class="mobile-header bg-white md:hidden h-14 flex items-center justify-between px-4 shadow-sm border-b border-slate-200 z-20">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileSidebar()" class="text-slate-600 p-2"><i
                        class="ri-menu-line text-xl"></i></button>
                <div class="font-bold text-slate-800" id="mobilePageTitle">æ¶ˆé˜²äººå“¡</div>
            </div>
            <a href="javascript:void(0)" onclick="location.href=PORTAL_URL"
                class="text-slate-400 hover:text-blue-600"><i class="ri-home-4-line text-xl"></i></a>
        </div>

        <div id="toolbar-container"
            class="bg-white px-6 py-3 border-b border-slate-200 flex flex-wrap items-center justify-between gap-3 shadow-sm z-10">
            <div class="text-lg font-bold text-slate-800 hidden md:flex items-center gap-2" id="pageTitle">
                <span class="w-2 h-6 bg-blue-600 rounded-full"></span> é™„ä»¶1 - æ¶ˆé˜²äººå“¡
            </div>
            <div id="yearSelectorContainer" class="hidden flex items-center gap-2">
                <span class="text-sm font-bold text-slate-600">å¹´åº¦:</span>
                <select id="yearSelect" onchange="changeYear(this.value)"
                    class="bg-white border border-slate-300 text-slate-800 text-sm rounded-lg block p-1.5 font-bold">
                    <option value="2025">114å¹´ (2025)</option>
                    <option value="2026">115å¹´ (2026)</option>
                    <option value="2027">116å¹´ (2027)</option>
                    <option value="2028">117å¹´ (2028)</option>
                    <option value="2029">118å¹´ (2029)</option>
                </select>
            </div>
            <div class="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0" id="toolbar"></div>
        </div>

        <div class="flex-1 overflow-hidden p-4 relative">
            <div id="view1" class="view-section h-full flex flex-col">
                <div class="table-container flex-1 mb-4">
                    <table id="table1">
                        <thead>
                            <tr>
                                <th style="width:50px">åˆªé™¤</th>
                                <th style="width:40px">é …æ¬¡</th>
                                <th style="width:40px">æœˆä»½</th>
                                <th style="width:100px">æ‰¿è¾¦å–®ä½</th>
                                <th style="width:200px">èª²ç¨‹åç¨±</th>
                                <th style="width:80px">è¨“ç·´å°è±¡</th>
                                <th style="width:140px">èª²ç¨‹æ—¥æœŸ</th>
                                <th style="width:120px">ä¸Šèª²åœ°é»</th>
                                <th style="width:40px">æ¢¯æ•¸</th>
                                <th style="width:50px">æ¯æ¢¯<br>äººæ•¸</th>
                                <th style="width:50px">åˆè¨ˆ<br>äººæ•¸</th>
                                <th style="width:50px">æ¯å¤©<br>æ™‚æ•¸</th>
                                <th style="width:50px">æ¯æ¢¯<br>æ™‚æ•¸</th>
                                <th style="width:50px">åˆè¨ˆ<br>æ™‚æ•¸</th>
                                <th style="width:100px" class="col-blue-light">é è¨ˆèª¿ç”¨äººæ•¸<br>(åˆ†éšŠäººåŠ›)</th>
                                <th style="width:120px" class="col-yellow">æ˜¯å¦æä¾›å®œåŸº<br>åŒ—æ¡ƒåƒè¨“</th>
                                <th style="width:60px" class="col-yellow">æš«è¨‚<br>æ–°åŒ—</th>
                                <th style="width:60px" class="col-yellow">æš«è¨‚<br>åŸºéš†</th>
                                <th style="width:60px" class="col-yellow">æš«è¨‚<br>æ¡ƒåœ’</th>
                                <th style="width:60px" class="col-yellow">æš«è¨‚<br>å®œè˜­</th>
                                <th style="width:150px">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1"></tbody>
                    </table>
                </div>
                <button
                    class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0"
                    onclick="addRow(1)"><i class="ri-add-line text-lg"></i> æ–°å¢è³‡æ–™åˆ—</button>
            </div>

            <div id="view2" class="view-section hidden h-full flex flex-col">
                <div class="table-container flex-1 mb-4">
                    <table id="table2">
                        <thead>
                            <tr>
                                <th style="width:50px">åˆªé™¤</th>
                                <th style="width:40px">åºè™Ÿ</th>
                                <th style="width:40px">æœˆä»½</th>
                                <th style="width:100px">æ‰¿è¾¦å–®ä½</th>
                                <th style="width:200px">èª²ç¨‹åç¨±</th>
                                <th style="width:120px">è¨“ç·´å°è±¡</th>
                                <th style="width:140px">èª²ç¨‹æ—¥æœŸ</th>
                                <th style="width:120px">è¨“ç·´åœ°é»</th>
                                <th style="width:40px">æ¢¯æ•¸</th>
                                <th style="width:50px">æ¯æ¢¯<br>äººæ•¸</th>
                                <th style="width:50px">åˆè¨ˆ<br>äººæ•¸</th>
                                <th style="width:50px">æ¯å¤©<br>æ™‚æ•¸</th>
                                <th style="width:50px">æ¯æ¢¯<br>æ™‚æ•¸</th>
                                <th style="width:50px">åˆè¨ˆ<br>æ™‚æ•¸</th>
                                <th style="width:80px">èª¿ç”¨æœ¬å±€<br>æ•™å®˜äººæ•¸</th>
                                <th style="width:100px">æ˜¯å¦æä¾›<br>è·¨ç¸£å¸‚</th>
                                <th style="width:150px">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2"></tbody>
                    </table>
                </div>
                <button
                    class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0"
                    onclick="addRow(2)"><i class="ri-add-line text-lg"></i> æ–°å¢è³‡æ–™åˆ—</button>
            </div>

            <div id="view3" class="view-section hidden h-full flex flex-col">
                <div class="table-container flex-1 mb-4">
                    <table id="table3">
                        <thead>
                            <tr>
                                <th style="width:50px">åˆªé™¤</th>
                                <th style="width:40px">åºè™Ÿ</th>
                                <th style="width:100px">æ‰¿è¾¦å–®ä½</th>
                                <th style="width:250px">é‡å¤§æ´»å‹•æ¼”ç¿’åç¨±</th>
                                <th style="width:150px">åƒåŠ å°è±¡</th>
                                <th style="width:140px">æ—¥æœŸ</th>
                                <th style="width:50px">å¤©æ•¸</th>
                                <th style="width:50px">æ™‚æ•¸</th>
                                <th style="width:100px" class="col-red-light">æ¯æ—¥èª¿ç”¨<br>å¤–å‹¤äººæ•¸</th>
                                <th style="width:150px">åœ°é»(æ•™å®¤)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody3"></tbody>
                    </table>
                </div>
                <button
                    class="bg-blue-600 text-white px-5 py-2.5 rounded-xl hover:bg-blue-700 shadow-lg font-bold transition flex items-center gap-2 w-fit mx-auto md:mx-0"
                    onclick="addRow(3)"><i class="ri-add-line text-lg"></i> æ–°å¢è³‡æ–™åˆ—</button>
            </div>

            <div id="view4" class="view-section hidden h-full flex flex-col">
                <div
                    class="bg-amber-50 text-amber-800 px-4 py-3 rounded-xl border border-amber-200 text-sm mb-4 flex items-center gap-2 shadow-sm">
                    <i class="ri-calendar-event-line text-lg text-amber-500"></i>
                    <span><strong>èªªæ˜ï¼š</strong> ç´…è‰²åº•è‰²ä»£è¡¨åœ‹å®šå‡æ—¥æˆ–é€±æœ«ã€‚è³‡æ–™ä¾†æºï¼šå…§å»ºè¡Œæ”¿é™¢è¡Œäº‹æ›†ã€‚</span>
                </div>
                <div class="table-container flex-1 p-4 bg-white">
                    <div id="ganttExportArea">
                        <table id="table4">
                            <tbody id="ganttContainer"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="processCSV(this)">

    <!-- ğŸ”§ é›²ç«¯èˆ‡ç³»çµ±é€£çµè¨­å®šï¼ˆå…¨éƒ¨å¯«åœ¨åŒä¸€æ”¯ index.htmlï¼‰ -->
    <script>
        // ğŸš¨ é€™ä¸‰å€‹è«‹æ”¹æˆä½ å¯¦éš›çš„ç¶²å€
        // 1. Google Apps Script Web App URL
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwDk9vkK3Idu7ax_mpfx4hcW36Bn_IIoen72gqXmNRPlXn6PDzQJMgONXAqCX46uJd9OA/exec";

        // 2. è¨“ç·´å ´åœ°å€Ÿç”¨ç³»çµ±ç¶²å€
        const OTHER_SYSTEM_URL = "https://tfd-train.github.io/Facility-Booking/";

        // 3. æ•´åˆé¦–é ç¶²å€
        const PORTAL_URL = "https://tfd-train.github.io/Training-Management-Platform/";
    </script>

    <script>
        // === 1. å…¨åŸŸè®Šæ•¸ ===
        let d1 = [], d2 = [], d3 = [];
        let currentTab = 1;
        let printActionType = '';
        let selectedMonthsForPrint = new Set();

        const nowYear = new Date().getFullYear();
        let currentYear = (nowYear >= 2025 && nowYear <= 2029) ? nowYear : 2025;
        let pickerYear = currentYear;

        // å…§å»ºå‡æ—¥è¡¨
        const builtInHolidays = {
            '2025-1-1': true, '2025-1-25': true, '2025-1-26': true, '2025-1-27': true, '2025-1-28': true,
            '2025-1-29': true, '2025-1-30': true, '2025-1-31': true, '2025-2-1': true, '2025-2-2': true,
            '2025-2-28': true, '2025-4-3': true, '2025-4-4': true, '2025-4-5': true, '2025-4-6': true,
            '2025-5-30': true, '2025-5-31': true, '2025-6-1': true, '2025-10-4': true, '2025-10-5': true,
            '2025-10-6': true, '2025-10-10': true, '2025-10-11': true, '2025-10-12': true,
            '2026-1-1': true, '2026-2-16': true, '2026-2-17': true, '2026-2-18': true, '2026-2-19': true,
            '2026-2-20': true, '2026-2-28': true, '2026-4-4': true, '2026-4-5': true, '2026-6-19': true,
            '2026-9-25': true, '2026-10-10': true
        };

        let currentEdit = null;
        let selectedDates = new Set();
        let currentCalendarMonth = 1;

        // === åˆ¤æ–·æ˜¯å¦å‡æ—¥ / é€±æœ« ===
        function isDayOff(y, m, d) {
            const key = `${y}-${m}-${d}`;
            if (builtInHolidays[key]) return true;
            const date = new Date(y, m - 1, d);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        // === 2. ä¸‹è¼‰èˆ‡åŒ¯å‡ºåŠŸèƒ½ ===
        function downloadCSVTemplate() {
            try {
                let csvContent = "\uFEFF";
                if (currentTab === 1) {
                    csvContent += "æœˆä»½,æ‰¿è¾¦å–®ä½,èª²ç¨‹åç¨±,è¨“ç·´å°è±¡,èª²ç¨‹æ—¥æœŸ,ä¸Šèª²åœ°é»,æ¢¯æ•¸,æ¯æ¢¯äººæ•¸,æ¯å¤©æ™‚æ•¸,æ¯æ¢¯æ™‚æ•¸,é è¨ˆèª¿ç”¨äººæ•¸,æ˜¯å¦æä¾›è·¨ç¸£å¸‚(TRUE/FALSE),æ–°åŒ—,åŸºéš†,æ¡ƒåœ’,å®œè˜­,å‚™è¨»\n";
                } else if (currentTab === 2) {
                    csvContent += "æœˆä»½,æ‰¿è¾¦å–®ä½,èª²ç¨‹åç¨±,è¨“ç·´å°è±¡,èª²ç¨‹æ—¥æœŸ,ä¸Šèª²åœ°é»,æ¢¯æ•¸,æ¯æ¢¯äººæ•¸,æ¯å¤©æ™‚æ•¸,æ¯æ¢¯æ™‚æ•¸,èª¿ç”¨æ•™å®˜äººæ•¸,æ˜¯å¦æä¾›è·¨ç¸£å¸‚(TRUE/FALSE),å‚™è¨»\n";
                } else if (currentTab === 3) {
                    csvContent += "æ‰¿è¾¦å–®ä½,æ´»å‹•åç¨±,åƒåŠ å°è±¡,æ—¥æœŸ,å¤©æ•¸,æ™‚æ•¸,æ¯æ—¥èª¿ç”¨äººæ•¸,åœ°é»\n";
                }
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, `é™„ä»¶${currentTab}_ç¯„æœ¬.csv`);
            } catch (e) {
                alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´: " + e);
            }
        }

        async function exportExcelJS(selM) {
            try {
                const wb = new ExcelJS.Workbook();
                const sh = wb.addWorksheet('ç”˜ç‰¹åœ–');
                sh.getColumn(1).width = 50;
                for (let k = 2; k <= 32; k++) sh.getColumn(k).width = 4;

                const headerRow = sh.addRow([
                    `${currentYear}å¹´ ç­æœŸ / æ´»å‹•åç¨±`,
                    ...Array.from({ length: 31 }, (_, k) => k + 1)
                ]);
                headerRow.eachCell(c => {
                    c.font = { bold: true };
                    c.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFf8fafc' } };
                    c.border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                    c.alignment = { horizontal: 'center' };
                });

                let rows = [];
                const parse = (r) => parseDateStr(r.date, r.ex, currentYear);

                const add = (r, val, pre) => {
                    let ds = parse(r);
                    ds = ds.filter(d => d.y === currentYear);
                    if (ds.length === 0) return;

                    let ms = [...new Set(ds.map(o => o.m))].sort((a, b) => a - b);
                    ms.forEach(m => {
                        rows.push({
                            m: m,
                            n: `${r.date} ${r.name} ${val > 0 ? `(${pre}${val}äºº)` : ''}`,
                            ds: ds.filter(o => o.m === m).map(o => o.d),
                            v: val
                        });
                    });
                };

                d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, 'èª¿ç”¨'); });
                d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, 'æ•™å®˜'); });
                d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, 'èª¿ç”¨'); });

                let grp = {};
                for (let i = 1; i <= 12; i++) grp[i] = [];
                rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r); });

                selM.forEach(m => {
                    if (!grp[m] || grp[m].length === 0) return;

                    let mt = sh.addRow([`${m} æœˆä»½`]);
                    mt.font = { bold: true, size: 12 };
                    mt.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFe2e8f0' }
                    };

                    let sum = Array(32).fill(0);

                    grp[m].forEach(r => {
                        let dVis = [r.n], dDat = [""];
                        for (let i = 1; i <= 31; i++) {
                            if (r.ds.includes(i)) {
                                dVis.push("");
                                let vShow = "";
                                if (r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0' || r.v === 0)) {
                                    vShow = parseInt(r.v);
                                }
                                dDat.push(vShow);
                                sum[i] += parseInt(r.v) || 0;
                            } else {
                                dVis.push("");
                                dDat.push("");
                            }
                        }
                        let rVis = sh.addRow(dVis);
                        let rDat = sh.addRow(dDat);

                        rVis.eachCell((c, col) => {
                            c.border = { right: { style: 'thin' } };
                            if (col === 1) c.alignment = { horizontal: 'left', vertical: 'middle', wrapText: true };
                            if (col > 1 && r.ds.includes(col - 1)) {
                                c.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: 'FF3b82f6' }
                                };
                            }
                        });
                        rDat.eachCell((c, col) => {
                            c.border = {
                                bottom: { style: 'thick' },
                                right: { style: 'thin' },
                                left: { style: 'thin' }
                            };
                            c.alignment = { horizontal: 'center' };
                            if (col === 1) c.alignment = { horizontal: 'left', wrapText: true };
                            if (col > 1 && r.ds.includes(col - 1)) c.font = { bold: true };
                        });
                        sh.mergeCells(rVis.number, 1, rDat.number, 1);
                    });

                    let sd = ["æ¯æ—¥çµ±è¨ˆ"];
                    for (let i = 1; i <= 31; i++) sd.push(sum[i]);
                    let sr = sh.addRow(sd);
                    sr.eachCell((c) => {
                        c.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFf1f5f9' }
                        };
                        c.font = { bold: true, color: { argb: 'FF1e40af' } };
                        c.border = {
                            top: { style: 'double' },
                            bottom: { style: 'thick' },
                            left: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        c.alignment = { horizontal: 'center' };
                    });
                    sh.addRow([]);
                });

                const buf = await wb.xlsx.writeBuffer();
                saveAs(new Blob([buf]), "ç”˜ç‰¹åœ–å ±è¡¨.xlsx");
            } catch (e) {
                alert("Excel ä¸‹è¼‰å¤±æ•—: " + e);
            }
        }

        function downloadPDF(selectedMonths) {
            try {
                const element = document.getElementById('ganttExportArea');
                const container = document.querySelector('.view-section#view4 .table-container');
                if (!element || !container) { alert("æ‰¾ä¸åˆ°ç”˜ç‰¹åœ–å…ƒä»¶"); return; }

                const originalOverflow = container.style.overflow;
                const originalWidth = container.style.width;

                const originalTab = currentTab;
                if (originalTab !== 4) switchTab(4);

                if (selectedMonths) {
                    for (let m = 1; m <= 12; m++) {
                        const tb = document.getElementById(`month-${m}`);
                        if (tb) {
                            if (selectedMonths.includes(m)) tb.style.display = 'table-header-group';
                            else tb.style.display = 'none';
                        }
                    }
                }

                container.style.overflow = 'visible';
                container.style.width = '1232px';

                const opt = {
                    margin: 5,
                    filename: 'ç”˜ç‰¹åœ–å ±è¡¨.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, scrollY: 0, useCORS: true, width: 1232 },
                    jsPDF: { unit: 'pt', format: 'a3', orientation: 'landscape' }
                };

                showLoading(true, "æ­£åœ¨ç”¢ç”Ÿ PDF...");

                setTimeout(() => {
                    html2pdf().set(opt).from(element).save()
                        .then(() => {
                            container.style.overflow = originalOverflow;
                            container.style.width = originalWidth;
                            for (let m = 1; m <= 12; m++) {
                                let tb = document.getElementById(`month-${m}`);
                                if (tb) tb.style.display = 'table-header-group';
                            }
                            showLoading(false);
                            if (originalTab !== 4) switchTab(originalTab);
                        })
                        .catch(err => {
                            console.error(err);
                            alert("PDF ç”¢ç”Ÿå¤±æ•—: " + err);
                            container.style.overflow = originalOverflow;
                            container.style.width = originalWidth;
                            for (let m = 1; m <= 12; m++) {
                                let tb = document.getElementById(`month-${m}`);
                                if (tb) tb.style.display = 'table-header-group';
                            }
                            showLoading(false);
                        });
                }, 800);
            } catch (e) {
                alert("PDF åˆå§‹åŒ–å¤±æ•—: " + e);
                showLoading(false);
            }
        }

        // === 3. æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ===
        function renderT1() {
            const tb = document.getElementById('tbody1'); if (!tb) return;
            tb.innerHTML = '';
            d1.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center">
                    <button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(1,${i})">
                        <i class="ri-close-circle-fill text-xl"></i>
                    </button>
                </td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_1_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d1[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d1[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d1[${i}].target=this.value"></td>
                <td>
                    <div class="date-cell">
                        <input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(1,${i},this.value)" placeholder="é»æ“Šé¸å–">
                        <button class="btn-calendar" onclick="openDateModal(1,${i})"><i class="ri-calendar-line"></i></button>
                    </div>
                </td>
                <td><input type="text" value="${r.loc || ''}" onchange="d1[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d1[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d1[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">
                    ${(r.batch * r.pb) || 0}
                </td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d1[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bHour || ''}" onchange="d1[${i}].bHour=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">
                    ${(r.batch * r.bHour) || 0}
                </td>
                <td class="col-blue-light"><input type="number" value="${r.mp || ''}" onchange="d1[${i}].mp=this.value"></td>
                <td style="text-align:center">
                    <input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d1[${i}].ext=this.checked">
                </td>
                <td><input type="number" value="${r.nt || ''}" onchange="d1[${i}].nt=this.value"></td>
                <td><input type="number" value="${r.kl || ''}" onchange="d1[${i}].kl=this.value"></td>
                <td><input type="number" value="${r.ty || ''}" onchange="d1[${i}].ty=this.value"></td>
                <td><input type="number" value="${r.yl || ''}" onchange="d1[${i}].yl=this.value"></td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d1[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        function renderT2() {
            const tb = document.getElementById('tbody2'); if (!tb) return;
            tb.innerHTML = '';
            d2.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center">
                    <button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(2,${i})">
                        <i class="ri-close-circle-fill text-xl"></i>
                    </button>
                </td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" id="m_2_${i}" value="${r.m || ''}" readonly style="background:#f8fafc;color:#64748b"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d2[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d2[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d2[${i}].target=this.value"></td>
                <td>
                    <div class="date-cell">
                        <input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(2,${i},this.value)">
                        <button class="btn-calendar" onclick="openDateModal(2,${i})"><i class="ri-calendar-line"></i></button>
                    </div>
                </td>
                <td><input type="text" value="${r.loc || ''}" onchange="d2[${i}].loc=this.value"></td>
                <td><input type="number" value="${r.batch || ''}" onchange="d2[${i}].batch=this.value"></td>
                <td><input type="number" value="${r.pb || ''}" onchange="d2[${i}].pb=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">
                    ${(r.batch * r.pb) || 0}
                </td>
                <td><input type="number" value="${r.dHour || ''}" onchange="d2[${i}].dHour=this.value"></td>
                <td><input type="number" value="${r.bHour || ''}" onchange="d2[${i}].bHour=this.value"></td>
                <td style="background:#f8fafc;text-align:center;line-height:38px;color:#64748b">
                    ${(r.batch * r.bHour) || 0}
                </td>
                <td><input type="number" value="${r.inst || ''}" onchange="d2[${i}].inst=this.value"></td>
                <td style="text-align:center">
                    <input type="checkbox" class="w-4 h-4 text-blue-600 rounded" ${r.ext ? 'checked' : ''} onchange="d2[${i}].ext=this.checked">
                </td>
                <td class="align-left"><input type="text" value="${r.note || ''}" onchange="d2[${i}].note=this.value"></td>
                </tr>`;
            });
        }

        function renderT3() {
            const tb = document.getElementById('tbody3'); if (!tb) return;
            tb.innerHTML = '';
            d3.forEach((r, i) => {
                tb.innerHTML += `<tr>
                <td style="text-align:center">
                    <button class="text-slate-300 hover:text-red-500 transition" onclick="delRow(3,${i})">
                        <i class="ri-close-circle-fill text-xl"></i>
                    </button>
                </td>
                <td><input type="text" value="${i + 1}" readonly style="color:#94a3b8"></td>
                <td><input type="text" value="${r.unit || ''}" onchange="d3[${i}].unit=this.value"></td>
                <td class="align-left"><textarea onchange="d3[${i}].name=this.value">${r.name || ''}</textarea></td>
                <td><input type="text" value="${r.target || ''}" onchange="d3[${i}].target=this.value"></td>
                <td>
                    <div class="date-cell">
                        <input type="text" value="${r.date || ''}" onchange="updateMonthFromDate(3,${i},this.value)">
                        <button class="btn-calendar" onclick="openDateModal(3,${i})"><i class="ri-calendar-line"></i></button>
                    </div>
                </td>
                <td><input type="number" value="${r.days || ''}" onchange="d3[${i}].days=this.value"></td>
                <td><input type="number" value="${r.hours || ''}" onchange="d3[${i}].hours=this.value"></td>
                <td class="col-red-light"><input type="number" value="${r.mp || ''}" onchange="d3[${i}].mp=this.value"></td>
                <td class="align-left"><input type="text" value="${r.loc || ''}" onchange="d3[${i}].loc=this.value"></td>
                </tr>`;
            });
        }

        function renderAll() {
            renderT1();
            renderT2();
            renderT3();
        }

        // === äº‹ä»¶èˆ‡è¼”åŠ© ===
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('h-full');
        }

        function updateMonthFromDate(t, i, val) {
            let match = val.match(/^(\d+)\//);
            if (match) {
                let m = match[1];
                if (t === 1) d1[i].m = m;
                if (t === 2) d2[i].m = m;
                const mEl = document.getElementById(`m_${t}_${i}`);
                if (mEl) mEl.value = m;
            }
            if (t === 1) d1[i].date = val;
            if (t === 2) d2[i].date = val;
            if (t === 3) d3[i].date = val;
        }

        function addRow(t) {
            if (t === 1) d1.push({
                m: '', unit: '', name: '', target: '', date: '', loc: '',
                batch: '', pb: '',
                dHour: '', bHour: '',
                mp: 0, ext: false,
                nt: '', kl: '', ty: '', yl: '',
                note: '', ex: [], isNew: true
            });
            if (t === 2) d2.push({
                m: '', unit: '', name: '', target: '', date: '', loc: '',
                batch: '', pb: '',
                dHour: '', bHour: '',
                inst: 0, ext: false,
                note: '', ex: [], isNew: true
            });
            if (t === 3) d3.push({
                unit: '', name: '', target: '', date: '',
                days: '', hours: '', mp: 0,
                loc: '', ex: [], isNew: true
            });
            renderAll();
        }

        function delRow(t, i) {
            const input = prompt("âš ï¸ ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nè«‹è¼¸å…¥é˜²å‘†ç¢¼ã€Œ119ã€ä»¥ç¢ºèªåˆªé™¤ï¼š");
            if (input === "119") {
                if (t === 1) d1.splice(i, 1);
                if (t === 2) d2.splice(i, 1);
                if (t === 3) d3.splice(i, 1);
                renderAll();
            } else if (input !== null) {
                alert("é˜²å‘†ç¢¼éŒ¯èª¤ï¼Œå–æ¶ˆåˆªé™¤ã€‚");
            }
        }

        function switchTab(idx, el) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(e => {
                e.classList.remove('bg-blue-600/20', 'text-blue-300', 'border', 'border-blue-500/30');
                e.classList.add('text-slate-400');
            });
            if (el) {
                el.classList.remove('text-slate-400');
                el.classList.add('bg-blue-600/20', 'text-blue-300', 'border', 'border-blue-500/30');
            } else {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    const btn = sidebar.querySelectorAll('.nav-item')[idx - 1];
                    if (btn) btn.classList.add('bg-blue-600/20', 'text-blue-300');
                }
            }

            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            const view = document.getElementById(`view${idx}`);
            if (view) view.classList.remove('hidden');

            currentTab = idx;
            const titles = ["é™„ä»¶1 - æ¶ˆé˜²äººå“¡", "é™„ä»¶2 - éæ¶ˆé˜²äººå“¡", "é™„ä»¶3 - é‡å¤§æ´»å‹•", "ç”˜ç‰¹åœ–"];
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) pageTitle.innerHTML = `<span class="w-2 h-6 bg-blue-600 rounded-full"></span> ${titles[idx - 1]}`;
            const mobileTitle = document.getElementById('mobilePageTitle');
            if (mobileTitle) mobileTitle.innerText = titles[idx - 1].replace(/é™„ä»¶\d - /, '');

            const yearSelector = document.getElementById('yearSelectorContainer');
            if (yearSelector) {
                if (idx === 4) yearSelector.classList.remove('hidden');
                else yearSelector.classList.add('hidden');
            }

            updateToolbar();
            if (idx === 4) renderGantt();
        }

        function updateToolbar() {
            const bar = document.getElementById('toolbar');
            if (!bar) return;
            let html = '';
            const btnBase = "px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition whitespace-nowrap";
            const btnLight = `${btnBase} bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600`;
            const btnDark = `${btnBase} bg-slate-900 text-white hover:bg-slate-800 shadow-lg`;
            const btnGreen = `${btnBase} bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg`;
            const btnRed = `${btnBase} bg-rose-600 text-white hover:bg-rose-700 shadow-lg`;

            if (currentTab <= 3) {
                html += `<button class="${btnLight}" onclick="downloadCSVTemplate()"><i class="ri-download-2-line"></i> ç¯„ä¾‹</button>`;
                html += `<button class="${btnLight}" onclick="document.getElementById('csvInput').click()"><i class="ri-upload-2-line"></i> åŒ¯å…¥</button>`;
                html += `<button class="${btnDark}" onclick="saveData()"><i class="ri-save-3-line"></i> å„²å­˜è³‡æ–™</button>`;
            } else {
                html += `<button class="${btnGreen}" onclick="openPrintModal('excel')"><i class="ri-file-excel-2-line"></i> ä¸‹è¼‰ Excel</button>`;
                html += `<button class="${btnRed}" onclick="openPrintModal('download')"><i class="ri-file-pdf-line"></i> ä¸‹è¼‰ PDF</button>`;
            }
            bar.innerHTML = html;
        }

        function showLoading(s, t) {
            const ld = document.getElementById('loading'); if (ld) ld.style.display = s ? 'flex' : 'none';
            const txt = document.getElementById('loadText'); if (txt && t) txt.innerText = t;
        }

        // === é›²ç«¯å­˜å– ===
        function loadData() {
            try {
                if (!GAS_API_URL || GAS_API_URL.includes("è«‹å¡«å…¥")) {
                    if (d1.length === 0) addRow(1);
                    if (d2.length === 0) addRow(2);
                    if (d3.length === 0) addRow(3);
                    return;
                }
            } catch (e) {
                if (d1.length === 0) addRow(1);
                if (d2.length === 0) addRow(2);
                if (d3.length === 0) addRow(3);
                renderAll();
                return;
            }

            showLoading(true, "åŒæ­¥é›²ç«¯...");
            fetch(GAS_API_URL)
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        d1 = (res.d1 && res.d1.length > 0) ? res.d1.map(r => ({
                            m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5],
                            batch: r[6], pb: r[7],
                            dHour: r[9], bHour: r[10],
                            mp: r[12], ext: r[13] === 'true',
                            nt: r[14], kl: r[15], ty: r[16], yl: r[17],
                            note: r[18], ex: JSON.parse(r[19] || '[]'),
                            isNew: false
                        })) : [];
                        d2 = (res.d2 && res.d2.length > 0) ? res.d2.map(r => ({
                            m: r[0], unit: r[1], name: r[2], target: r[3], date: r[4], loc: r[5],
                            batch: r[6], pb: r[7],
                            dHour: r[9], bHour: r[10],
                            inst: r[12], ext: r[13] === 'true',
                            note: r[14], ex: JSON.parse(r[15] || '[]'),
                            isNew: false
                        })) : [];
                        d3 = (res.d3 && res.d3.length > 0) ? res.d3.map(r => ({
                            unit: r[0], name: r[1], target: r[2], date: r[3],
                            days: r[4], hours: r[5], mp: r[6], loc: r[7],
                            ex: JSON.parse(r[8] || '[]'), isNew: false
                        })) : [];
                    }
                    if (d1.length === 0) addRow(1);
                    if (d2.length === 0) addRow(2);
                    if (d3.length === 0) addRow(3);
                    renderAll();
                })
                .catch(e => {
                    console.error(e);
                    if (d1.length === 0) addRow(1);
                    if (d2.length === 0) addRow(2);
                    if (d3.length === 0) addRow(3);
                    renderAll();
                })
                .finally(() => showLoading(false));
        }

        function saveData() {
            showLoading(true, "å„²å­˜ä¸­...");
            const p1 = d1.map(r => [
                r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb,
                (r.batch * r.pb) || 0,
                r.dHour, r.bHour,
                (r.batch * r.bHour) || 0,
                r.mp, r.ext,
                r.nt, r.kl, r.ty, r.yl, r.note,
                JSON.stringify(r.ex)
            ]);
            const p2 = d2.map(r => [
                r.m, r.unit, r.name, r.target, r.date, r.loc, r.batch, r.pb,
                (r.batch * r.pb) || 0,
                r.dHour, r.bHour,
                (r.batch * r.bHour) || 0,
                r.inst, r.ext, r.note, JSON.stringify(r.ex)
            ]);
            const p3 = d3.map(r => [
                r.unit, r.name, r.target, r.date, r.days, r.hours, r.mp, r.loc, JSON.stringify(r.ex)
            ]);

            fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify({ d1: p1, d2: p2, d3: p3 }),
                headers: { 'Content-Type': 'text/plain' }
            })
                .then(r => r.json())
                .then(res => {
                    if (res.status === 'success') {
                        alert(res.message || "å·²å„²å­˜å®Œæˆ");
                        loadData();
                    } else {
                        alert("éŒ¯èª¤: " + res.message);
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert("å­˜æª”å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                })
                .finally(() => showLoading(false));
        }

        function processCSV(input) {
            if (!input.files[0]) return;
            const file = input.files[0];

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    const data = results.data;
                    let currentData = (currentTab === 1) ? d1 : (currentTab === 2 ? d2 : d3);
                    let hasData = currentData.length > 1 || (currentData.length === 1 && (currentData[0].unit !== '' || currentData[0].date !== ''));
                    let shouldClear = false;

                    if (hasData) {
                        if (confirm("âš ï¸ è¡¨æ ¼å…§å·²æœ‰è³‡æ–™ï¼\n\næŒ‰ã€Œç¢ºå®šã€ï¼šæ¸…é™¤ç¾æœ‰è³‡æ–™ï¼Œåªä¿ç•™åŒ¯å…¥çš„æª”æ¡ˆ (è¦†è“‹æ¨¡å¼)ã€‚\næŒ‰ã€Œå–æ¶ˆã€ï¼šä¿ç•™ç¾æœ‰è³‡æ–™ï¼Œå°‡æª”æ¡ˆåŠ åœ¨æœ€å¾Œé¢ (é™„åŠ æ¨¡å¼)ã€‚")) {
                            shouldClear = true;
                        }
                    } else { shouldClear = true; }

                    if (shouldClear) {
                        if (currentTab === 1) d1 = [];
                        if (currentTab === 2) d2 = [];
                        if (currentTab === 3) d3 = [];
                    }

                    if (currentTab === 1) {
                        data.forEach(r => {
                            d1.push({
                                m: r['æœˆä»½'] || '',
                                unit: r['æ‰¿è¾¦å–®ä½'] || '',
                                name: r['èª²ç¨‹åç¨±'] || '',
                                target: r['è¨“ç·´å°è±¡'] || '',
                                date: r['èª²ç¨‹æ—¥æœŸ'] || '',
                                loc: r['ä¸Šèª²åœ°é»'] || '',
                                batch: r['æ¢¯æ•¸'] || '',
                                pb: r['æ¯æ¢¯äººæ•¸'] || '',
                                dHour: r['æ¯å¤©æ™‚æ•¸'] || '',
                                bHour: r['æ¯æ¢¯æ™‚æ•¸'] || '',
                                mp: r['é è¨ˆèª¿ç”¨äººæ•¸'] || '',
                                ext: (r['æ˜¯å¦æä¾›è·¨ç¸£å¸‚(TRUE/FALSE)'] || '').toUpperCase() === 'TRUE',
                                nt: r['æ–°åŒ—'] || '',
                                kl: r['åŸºéš†'] || '',
                                ty: r['æ¡ƒåœ’'] || '',
                                yl: r['å®œè˜­'] || '',
                                note: r['å‚™è¨»'] || '',
                                ex: [],
                                isNew: true
                            });
                        });
                        renderT1();
                    } else if (currentTab === 2) {
                        data.forEach(r => {
                            d2.push({
                                m: r['æœˆä»½'] || '',
                                unit: r['æ‰¿è¾¦å–®ä½'] || '',
                                name: r['èª²ç¨‹åç¨±'] || '',
                                target: r['è¨“ç·´å°è±¡'] || '',
                                date: r['èª²ç¨‹æ—¥æœŸ'] || '',
                                loc: r['ä¸Šèª²åœ°é»'] || '',
                                batch: r['æ¢¯æ•¸'] || '',
                                pb: r['æ¯æ¢¯äººæ•¸'] || '',
                                dHour: r['æ¯å¤©æ™‚æ•¸'] || '',
                                bHour: r['æ¯æ¢¯æ™‚æ•¸'] || '',
                                inst: r['èª¿ç”¨æ•™å®˜äººæ•¸'] || '',
                                ext: (r['æ˜¯å¦æä¾›è·¨ç¸£å¸‚(TRUE/FALSE)'] || '').toUpperCase() === 'TRUE',
                                note: r['å‚™è¨»'] || '',
                                ex: [],
                                isNew: true
                            });
                        });
                        renderT2();
                    } else if (currentTab === 3) {
                        data.forEach(r => {
                            d3.push({
                                unit: r['æ‰¿è¾¦å–®ä½'] || '',
                                name: r['æ´»å‹•åç¨±'] || '',
                                target: r['åƒåŠ å°è±¡'] || '',
                                date: r['æ—¥æœŸ'] || '',
                                days: r['å¤©æ•¸'] || '',
                                hours: r['æ™‚æ•¸'] || '',
                                mp: r['æ¯æ—¥èª¿ç”¨äººæ•¸'] || '',
                                loc: r['åœ°é»'] || '',
                                ex: [],
                                isNew: true
                            });
                        });
                        renderT3();
                    }
                    input.value = '';
                    alert(shouldClear ? "è³‡æ–™å·²è¦†è“‹åŒ¯å…¥" : "è³‡æ–™å·²é™„åŠ åŒ¯å…¥");
                }
            });
        }

        // === 6. æ™ºæ…§å¹´ä»½èˆ‡æ—¥æœŸè§£æ ===
        function parseDateStr(str, excludeList, baseYear) {
            let results = [];
            if (!str) return results;
            if (!baseYear) baseYear = currentYear;

            try {
                let specificYear = null;
                let yearMatch = str.match(/(?:^|[^\d])(11[4-9]|12[0-9]|202[5-9])[å¹´\/\.]/);
                if (yearMatch) {
                    let y = parseInt(yearMatch[1]);
                    specificYear = (y < 1000) ? (y + 1911) : y;
                }

                let s = str.trim()
                    .replace(/[ï¼-ï¼™]/g, d => "ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™".indexOf(d))
                    .replace(/ï¼ˆ.*?ï¼‰/g, '').replace(/\(.*?\)/g, '')
                    .replace(/11[3-6]å¹´/g, '')
                    .replace(/202[4-7]å¹´/g, '')
                    .replace(/æœˆ/g, '/')
                    .replace(/æ—¥/g, '')
                    .replace(/ï½/g, '-').replace(/~/g, '-').replace(/ï¼/g, '-')
                    .replace(/[ã€ï¼Œ,]/g, ' ')
                    .trim();

                let tokens = s.split(/\s+/);
                let currentMonth = null;

                const checkDate = (m, d) => {
                    if (specificYear) return specificYear;
                    return baseYear;
                };

                tokens.forEach(token => {
                    if (!token) return;

                    let explicitMonthMatch = token.match(/^(\d+)[\/.]/);
                    if (explicitMonthMatch) {
                        currentMonth = parseInt(explicitMonthMatch[1]);
                    }

                    if (!currentMonth && !explicitMonthMatch) return;

                    let crossMatch = token.match(/(\d+)[\/.](\d+)-(\d+)[\/.](\d+)/);
                    if (crossMatch) {
                        let m1 = parseInt(crossMatch[1]), d1 = parseInt(crossMatch[2]);
                        let m2 = parseInt(crossMatch[3]), d2 = parseInt(crossMatch[4]);
                        let y = checkDate(m1, d1);
                        let cur = new Date(y, m1 - 1, d1);
                        let end = new Date(y, m2 - 1, d2);
                        if (end < cur) end.setFullYear(y + 1);
                        if (cur <= end) {
                            while (cur <= end) {
                                results.push({ m: cur.getMonth() + 1, d: cur.getDate(), y: cur.getFullYear() });
                                cur.setDate(cur.getDate() + 1);
                            }
                        }
                        currentMonth = m2;
                        return;
                    }

                    let rangeWithMonth = token.match(/(\d+)[\/.](\d+)-(\d+)/);
                    if (rangeWithMonth) {
                        let m = parseInt(rangeWithMonth[1]);
                        let d1 = parseInt(rangeWithMonth[2]);
                        let d2 = parseInt(rangeWithMonth[3]);
                        let y = checkDate(m, d1);
                        currentMonth = m;
                        if (d2 >= d1) {
                            for (let i = d1; i <= d2; i++) results.push({ m: m, d: i, y: y });
                        }
                        return;
                    }

                    let rangeNoMonth = token.match(/^(\d+)-(\d+)$/);
                    if (rangeNoMonth) {
                        let d1 = parseInt(rangeNoMonth[1]);
                        let d2 = parseInt(rangeNoMonth[2]);
                        let y = checkDate(currentMonth, d1);
                        if (d2 >= d1) {
                            for (let i = d1; i <= d2; i++) results.push({ m: currentMonth, d: i, y: y });
                        }
                        return;
                    }

                    let singleWithMonth = token.match(/(\d+)[\/.](\d+)/);
                    if (singleWithMonth) {
                        let m = parseInt(singleWithMonth[1]);
                        let d = parseInt(singleWithMonth[2]);
                        let y = checkDate(m, d);
                        currentMonth = m;
                        results.push({ m: m, d: d, y: y });
                        return;
                    }

                    let singleNoMonth = token.match(/^(\d+)$/);
                    if (singleNoMonth) {
                        let d = parseInt(singleNoMonth[1]);
                        let y = checkDate(currentMonth, d);
                        results.push({ m: currentMonth, d: d, y: y });
                        return;
                    }
                });

                if (excludeList && excludeList.length > 0) {
                    results = results.filter(o => !excludeList.includes(o.d));
                }

            } catch (e) {
                console.error("æ—¥æœŸè§£æå¤±æ•—:", e);
            }
            return results;
        }

        // === 7. ç”˜ç‰¹åœ–æ¸²æŸ“ ===
        function renderGantt() {
            const table = document.getElementById('table4');
            const container = document.getElementById('ganttContainer');
            if (!table || !container) return;

            let headerHTML = `<tr id="ganttHeader"><th class="col-fix-name">${currentYear}å¹´ ç­æœŸ / æ´»å‹•åç¨±</th>`;
            for (let i = 1; i <= 31; i++) headerHTML += `<th class="col-fix-day">${i}</th>`;
            headerHTML += '</tr>';

            table.innerHTML = `
                <colgroup>
                    <col style="width: 300px; min-width: 300px;">
                    ${Array(31).fill('<col style="width: 30px; min-width: 30px;">').join('')}
                </colgroup>
                <thead>${headerHTML}</thead>
                <tbody id="ganttContainer"></tbody>
            `;

            const newContainer = document.getElementById('ganttContainer');
            let rows = [];
            const parse = (r) => parseDateStr(r.date, r.ex, currentYear);

            const add = (r, val, prefix) => {
                let daysSet = parse(r);
                daysSet = daysSet.filter(d => d.y === currentYear);
                if (daysSet.length === 0) return;

                let involvedMonths = [...new Set(daysSet.map(o => o.m))].sort((a, b) => a - b);
                involvedMonths.forEach(m => {
                    let daysInThisMonth = daysSet.filter(o => o.m === m).map(o => o.d);
                    let label = `${r.date} ${r.name} ${val > 0 ? `(${prefix} ${val}äºº)` : ''}`;
                    rows.push({ m: m, n: label, ds: daysInThisMonth, v: val });
                });
            };

            d1.forEach(r => { if (r.date && r.mp) add(r, r.mp, 'èª¿ç”¨'); });
            d2.forEach(r => { if (r.date && r.inst) add(r, r.inst, 'æ•™å®˜'); });
            d3.forEach(r => { if (r.date && r.mp) add(r, r.mp, 'èª¿ç”¨'); });

            let grp = {}; for (let i = 1; i <= 12; i++) grp[i] = [];
            rows.forEach(r => { if (grp[r.m]) grp[r.m].push(r); });

            for (let m = 1; m <= 12; m++) {
                if (!grp[m] || grp[m].length === 0) continue;

                let tbody = document.createElement('tbody');
                tbody.className = 'gantt-month-group';
                tbody.id = `month-${m}`;
                let html = `<tr class="gantt-month-header"><td colspan="32">${m} æœˆä»½</td></tr>`;
                let sum = Array(32).fill(0);

                grp[m].forEach(r => {
                    let row1 = `<tr class="gantt-visual-row">
                        <td class="col-fix-name" rowspan="2">${r.n}</td>`;

                    let row2 = `<tr class="gantt-data-row">`;

                    for (let i = 1; i <= 31; i++) {
                        let act = r.ds.includes(i);
                        let isHoliday = isDayOff(currentYear, m, i);
                        let wkCls = isHoliday ? (builtInHolidays[`${currentYear}-${m}-${i}`] ? 'holiday-red' : 'weekend') : '';

                        let val = parseInt(r.v);
                        if (isNaN(val)) val = 0;
                        if (act) sum[i] += val;

                        let vShow = '';
                        if (act && r.v !== '' && r.v != null && (parseInt(r.v) > 0 || r.v == '0')) {
                            vShow = r.v;
                        }

                        row1 += `<td class="col-fix-day gantt-cell-bar ${wkCls} ${act ? 'bar-active' : ''}"></td>`;
                        row2 += `<td class="col-fix-day gantt-num ${wkCls}">${vShow}</td>`;
                    }
                    row1 += '</tr>';
                    row2 += '</tr>';
                    html += row1 + row2;
                });

                let sRow = `<tr class="stats-row"><td class="col-fix-name" style="text-align:center;">æ¯æ—¥çµ±è¨ˆ</td>`;
                for (let i = 1; i <= 31; i++) sRow += `<td class="col-fix-day">${sum[i]}</td>`;
                html += sRow + '</tr>';
                tbody.innerHTML = html;
                newContainer.appendChild(tbody);
            }
        }

        // === 8. æ—¥æ›† Modal ===
        function openDateModal(t, i) {
            currentEdit = { t, i };
            const val = t === 1 ? d1[i].date : t === 2 ? d2[i].date : d3[i].date;
            selectedDates.clear();

            const parsed = parseDateStr(val, null, pickerYear);
            if (parsed.length > 0) {
                pickerYear = parsed[0].y;
                currentCalendarMonth = parsed[0].m;
            } else {
                pickerYear = nowYear;
                currentCalendarMonth = new Date().getMonth() + 1;
            }

            parsed.forEach(o => {
                if (o.y === pickerYear) selectedDates.add(`${o.m}-${o.d}`);
            });

            document.getElementById('pickerYearSelect').value = pickerYear;

            renderCalendar();
            document.getElementById('dateModal').classList.remove('hidden');
            document.getElementById('dateModal').classList.add('flex');
        }

        function changePickerYear(val) {
            pickerYear = parseInt(val);
            selectedDates.clear();
            renderCalendar();
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            el.classList.add('hidden');
            el.classList.remove('flex');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const header = document.createElement('div');
            header.className = "col-span-7 flex justify-between items-center mb-2";
            header.innerHTML = `
                <button onclick="changeMonth(-1)" class="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="ri-arrow-left-s-line"></i></button>
                <span class="font-bold text-lg text-blue-600">${currentCalendarMonth} æœˆ</span>
                <button onclick="changeMonth(1)" class="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="ri-arrow-right-s-line"></i></button>
            `;
            grid.appendChild(header);

            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(d => {
                const div = document.createElement('div');
                div.className = "text-center text-xs font-bold text-slate-500 py-1";
                div.innerText = d;
                grid.appendChild(div);
            });

            const daysInMonth = new Date(pickerYear, currentCalendarMonth, 0).getDate();
            const firstDay = new Date(pickerYear, currentCalendarMonth - 1, 1).getDay();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                grid.appendChild(empty);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const key = `${currentCalendarMonth}-${d}`;
                const isActive = selectedDates.has(key);
                const isHoliday = isDayOff(pickerYear, currentCalendarMonth, d);
                const holidayClass = isHoliday
                    ? (builtInHolidays[`${pickerYear}-${currentCalendarMonth}-${d}`]
                        ? 'text-red-600 font-bold bg-red-50 border-red-200'
                        : 'text-red-500 bg-slate-50')
                    : '';
                const btn = document.createElement('div');
                btn.className = `day-btn ${isActive ? 'active' : ''} ${holidayClass}`;
                btn.innerText = d;
                btn.onclick = () => {
                    if (selectedDates.has(key)) selectedDates.delete(key);
                    else selectedDates.add(key);
                    renderCalendar();
                };
                grid.appendChild(btn);
            }

            updateModalRangeText();
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth < 1) { currentCalendarMonth = 12; pickerYear--; }
            if (currentCalendarMonth > 12) { currentCalendarMonth = 1; pickerYear++; }
            document.getElementById('pickerYearSelect').value = pickerYear;
            renderCalendar();
        }

        function updateModalRangeText() {
            const text = document.getElementById('modalRangeText');
            if (text) text.innerText = `å·²é¸å– ${selectedDates.size} å¤©`;
        }

        function applyDateFilter(type) {
            const daysInMonth = new Date(pickerYear, currentCalendarMonth, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const key = `${currentCalendarMonth}-${d}`;
                const isHoliday = isDayOff(pickerYear, currentCalendarMonth, d);
                if (type === 'all') selectedDates.add(key);
                else if (type === 'clear') selectedDates.delete(key);
                else if (type === 'no-weekend') {
                    if (!isHoliday) selectedDates.add(key); else selectedDates.delete(key);
                } else if (type === 'only-weekend') {
                    if (isHoliday) selectedDates.add(key); else selectedDates.delete(key);
                }
            }
            renderCalendar();
        }

        function saveDateModal() {
            if (!currentEdit) return;
            const sorted = [...selectedDates].map(s => {
                const [m, d] = s.split('-').map(Number);
                return { m, d, val: m * 100 + d };
            }).sort((a, b) => a.val - b.val);

            let str = "";
            const needsYearPrefix = (pickerYear !== currentYear);
            const prefix = needsYearPrefix ? `${pickerYear - 1911}å¹´` : "";

            if (sorted.length > 0) {
                let groups = {};
                sorted.forEach(o => {
                    if (!groups[o.m]) groups[o.m] = [];
                    groups[o.m].push(o.d);
                });
                let parts = [];
                for (let m in groups) {
                    let days = groups[m];
                    let ranges = [];
                    let start = days[0], prev = days[0];
                    for (let i = 1; i < days.length; i++) {
                        if (days[i] === prev + 1) {
                            prev = days[i];
                        } else {
                            ranges.push(start === prev ? `${start}` : `${start}-${prev}`);
                            start = days[i];
                            prev = days[i];
                        }
                    }
                    ranges.push(start === prev ? `${start}` : `${start}-${prev}`);
                    parts.push(`${m}/${ranges.join('ã€')}`);
                }
                str = prefix + parts.join(', ');
            }

            const { t, i } = currentEdit;
            if (t === 1) d1[i].date = str;
            if (t === 2) d2[i].date = str;
            if (t === 3) d3[i].date = str;

            updateMonthFromDate(t, i, str);
            renderAll();
            closeModal('dateModal');
        }

        // === ç”˜ç‰¹åœ–å¹´åˆ†åˆ‡æ› ===
        function changeYear(val) {
            currentYear = parseInt(val);
            renderGantt();
        }

        // === åˆ—å° / åŒ¯å‡ºæœˆä»½é¸æ“‡ ===
        function openPrintModal(type) {
            printActionType = type;
            // ç¢ºä¿ç”˜ç‰¹åœ–æ˜¯æœ€æ–°çš„
            if (currentTab !== 4) {
                switchTab(4);
            } else {
                renderGantt();
            }

            selectedMonthsForPrint = new Set();
            for (let m = 1; m <= 12; m++) {
                const tb = document.getElementById(`month-${m}`);
                if (tb) selectedMonthsForPrint.add(m);
            }
            buildPrintMonthGrid();

            const modal = document.getElementById('printModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function buildPrintMonthGrid() {
            const grid = document.getElementById('printMonthGrid');
            grid.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const hasData = document.getElementById(`month-${m}`) != null;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'month-select-btn';
                if (!hasData) {
                    btn.classList.add('opacity-40');
                }
                if (selectedMonthsForPrint.has(m)) {
                    btn.classList.add('selected');
                }
                btn.innerText = `${m} æœˆ`;
                btn.onclick = () => {
                    if (!hasData) return;
                    if (selectedMonthsForPrint.has(m)) selectedMonthsForPrint.delete(m);
                    else selectedMonthsForPrint.add(m);
                    buildPrintMonthGrid();
                };
                grid.appendChild(btn);
            }
        }

        function toggleAllMonths() {
            let allSelected = true;
            for (let m = 1; m <= 12; m++) {
                const tb = document.getElementById(`month-${m}`);
                if (tb && !selectedMonthsForPrint.has(m)) {
                    allSelected = false;
                    break;
                }
            }
            if (allSelected) {
                selectedMonthsForPrint.clear();
            } else {
                selectedMonthsForPrint.clear();
                for (let m = 1; m <= 12; m++) {
                    const tb = document.getElementById(`month-${m}`);
                    if (tb) selectedMonthsForPrint.add(m);
                }
            }
            buildPrintMonthGrid();
        }

        function executePrintOrExport() {
            const months = Array.from(selectedMonthsForPrint).sort((a, b) => a - b);
            if (months.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½");
                return;
            }
            closeModal('printModal');
            if (printActionType === 'excel') {
                exportExcelJS(months);
            } else if (printActionType === 'download') {
                downloadPDF(months);
            }
        }

        // Window Onload
        window.onload = function () {
            const yearSelect = document.getElementById('yearSelect');
            if (yearSelect) yearSelect.value = currentYear;
            updateToolbar();
            loadData();
        };
    </script>
</body>
</html>
